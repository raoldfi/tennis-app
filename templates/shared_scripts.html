<script>
/**
 * Tennis App - Standardized UI System v2.1
 * Enhanced with League Management, Team Operations, and Visual Effects
 * Comprehensive JavaScript utilities for all tennis app components
 */

class TennisUI {
    // ==================== INITIALIZATION ====================
    
    static init() {
        console.log('🎾 Tennis UI System v2.1 Initialized');
        this.initializeFlashMessages();
        this.initializeTooltips();
        this.initializeSearchTables();
        this.initializeScheduledMatchesTable(); 
        this.loadStyles();
    }

    static initializeFlashMessages() {
        // Auto-hide flash messages after 5 seconds
        document.querySelectorAll('.alert').forEach(alert => {
            if (!alert.querySelector('.btn-close')) return;
            
            setTimeout(() => {
                if (alert.parentNode && !alert.classList.contains('fade')) {
                    alert.classList.add('fade');
                    setTimeout(() => {
                        if (alert.parentNode) alert.remove();
                    }, 150);
                }
            }, 5000);
        });
    }

    static initializeTooltips() {
        // Initialize Bootstrap tooltips if available
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    }

    static initializeSearchTables() {
        // Add search functionality to tables with search inputs
        document.querySelectorAll('input[data-table-search]').forEach(input => {
            const tableId = input.getAttribute('data-table-search');
            const table = document.getElementById(tableId);
            if (!table) return;

            input.addEventListener('input', (e) => {
                this.filterTable(table, e.target.value);
            });
        });
    }
    
    /**
     * Validate form by ID (convenience method)
     * @param {string} formId - The ID of the form to validate
     * @returns {boolean} - True if form is valid
     */
    static validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) {
            console.error(`Form with ID '${formId}' not found`);
            return false;
        }
        
        return TennisForms.validateForm(form);
    }

    /**
     * Show a modal by ID
     * @param {string} modalId - The ID of the modal to show
     */
    static showModal(modalId) {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error(`Modal with ID '${modalId}' not found`);
        }
    }
    
    /**
     * Hide a modal by ID
     * @param {string} modalId - The ID of the modal to hide
     */
    static hideModal(modalId) {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        } else {
            console.error(`Modal with ID '${modalId}' not found`);
        }
    }
    
    /**
     * Set modal content
     * @param {string} modalId - The ID of the modal
     * @param {string} contentId - The ID of the content element within the modal
     * @param {string} content - The HTML content to set
     */
    static setModalContent(modalId, contentId, content) {
        const contentElement = document.getElementById(contentId);
        if (contentElement) {
            contentElement.innerHTML = content;
        } else {
            console.error(`Content element with ID '${contentId}' not found in modal '${modalId}'`);
        }
    }
    
    static filterTable(table, searchTerm) {
        const rows = table.querySelectorAll('tbody tr');
        const term = searchTerm.toLowerCase();
        let visibleCount = 0;

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const isVisible = text.includes(term);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });

        // Show/hide "no results" message
        const noResults = document.getElementById('noResults');
        if (noResults) {
            noResults.style.display = visibleCount === 0 && searchTerm ? 'block' : 'none';
        }
    }

    static loadStyles() {
        // Ensure required styles are loaded
        if (!document.getElementById('tennis-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'tennis-ui-styles';
            styles.textContent = `
                .tennis-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    min-width: 350px;
                    max-width: 500px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                    animation: slideInRight 0.4s ease;
                    border-radius: 8px;
                    border: none;
                }
                
                .tennis-notification-enhanced {
                    background: rgba(255, 255, 255, 0.98) !important;
                    backdrop-filter: blur(10px);
                    border-left: 5px solid;
                    font-weight: 500;
                    padding: 1rem 1.25rem;
                }
                
                .tennis-notification-enhanced.alert-success {
                    border-left-color: #28a745;
                    background: rgba(40, 167, 69, 0.95) !important;
                    color: white;
                }
                
                .tennis-notification-enhanced.alert-danger {
                    border-left-color: #dc3545;
                    background: rgba(220, 53, 69, 0.95) !important;
                    color: white;
                }
                
                .tennis-notification-enhanced.alert-warning {
                    border-left-color: #ffc107;
                    background: rgba(255, 193, 7, 0.95) !important;
                    color: #212529;
                }
                
                .tennis-notification-enhanced.alert-info {
                    border-left-color: #007bff;
                    background: rgba(0, 123, 255, 0.95) !important;
                    color: white;
                }
                
                .tennis-notification-icon {
                    flex-shrink: 0;
                    margin-top: 2px;
                }
                
                .tennis-notification-content {
                    line-height: 1.4;
                }
                
                .tennis-notification-message {
                    font-size: 0.95rem;
                    font-weight: 500;
                }
                
                .tennis-notification:hover {
                    transform: translateX(-5px);
                    box-shadow: 0 12px 35px rgba(0,0,0,0.4);
                    transition: all 0.2s ease;
                }
                
                .fade-out {
                    animation: slideOutRight 0.3s ease forwards;
                }
                
                @keyframes slideInRight {
                    from { 
                        transform: translateX(100%); 
                        opacity: 0; 
                    }
                    to { 
                        transform: translateX(0); 
                        opacity: 1; 
                    }
                }
                
                @keyframes slideOutRight {
                    from { 
                        transform: translateX(0); 
                        opacity: 1; 
                    }
                    to { 
                        transform: translateX(100%); 
                        opacity: 0; 
                    }
                }
                
                /* Stack multiple notifications */
                .tennis-notification:nth-child(n+2) {
                    margin-top: 10px;
                }
                
                /* Enhanced close button for dark backgrounds */
                .tennis-notification .btn-close-white {
                    filter: brightness(0) invert(1);
                    opacity: 0.8;
                }
                
                .tennis-notification .btn-close-white:hover {
                    opacity: 1;
                    transform: scale(1.1);
                }
            `;
            document.head.appendChild(styles);
        }
    }

    /**
     * Standard scheduled matches table functions
     */
    static initializeScheduledMatchesTable(tableSelector = '.tennis-matches-table') {
        const tables = document.querySelectorAll(tableSelector);
        tables.forEach(table => {
            // Add click handlers for action buttons
            table.addEventListener('click', (e) => {
                const target = e.target.closest('.action-btn');
                if (!target) return;
    
                const matchId = target.getAttribute('data-match-id');
                const action = target.getAttribute('data-action');
    
                switch (action) {
                    case 'view':
                        this.viewMatchDetails(matchId);
                        break;
                    case 'unschedule':
                        const description = target.getAttribute('data-description');
                        this.unscheduleMatch(matchId, description);
                        break;
                    case 'edit':
                        this.editMatchSchedule(matchId);
                        break;
                }
            });
        });
    }
    
    static viewMatchDetails(matchId) {
        window.location.href = `/matches/${matchId}`;
    }
    
    static async unscheduleMatch(matchId, description) {
        const confirmed = await this.showConfirmDialog(
            'Unschedule Match',
            `Are you sure you want to unschedule "${description}"?`,
            'Unschedule',
            'btn-tennis-warning'
        );
    
        if (!confirmed) return;
    
        try {
            const result = await this.apiCall(`/matches/${matchId}/schedule`, {
                method: 'DELETE'
            });
    
            this.showNotification(result.message || 'Match unscheduled successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            this.showNotification(error.message || 'Failed to unschedule match.', 'danger');
        }
    }
    
    static editMatchSchedule(matchId) {
        // Use existing schedule match function from matches.html
        if (typeof scheduleMatch === 'function') {
            scheduleMatch(matchId);
        } else {
            window.location.href = `/matches/${matchId}/schedule`;
        }
    }
    
    /**
     * Format day name from date string
     */
    static formatDayName(dateStr) {
        if (!dateStr || dateStr === 'TBD') return 'TBD';
        
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'short' });
        } catch {
            return 'TBD';
        }
    }
    
    /**
     * Get status class for match
     */
    static getMatchStatusClass(match) {
        if (!match.scheduled_times || match.scheduled_times.length === 0) {
            return 'status-unscheduled';
        }
        
        const expectedLines = match.expected_lines || 3;
        const scheduledLines = match.scheduled_times.length;
        
        if (scheduledLines >= expectedLines) {
            return 'status-scheduled';
        } else {
            return 'status-partial';
        }
    }

    // ==================== API UTILITIES ====================

    /**
     * Make API calls with standardized error handling
     * @param {string} url - API endpoint
     * @param {Object} options - Fetch options
     * @returns {Promise} - Response data
     */
    static async apiCall(url, options = {}) {
        try {
            const defaultHeaders = {};
            
            // Only add Content-Type for JSON data
            if (options.body && typeof options.body === 'string') {
                defaultHeaders['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(url, {
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                },
                ...options
            });
    
            // Always try to parse JSON response (for both success and error)
            let data;
            try {
                data = await response.json();
            } catch (parseError) {
                // If JSON parsing fails, create a generic error object
                data = { 
                    error: `Server returned non-JSON response: ${response.status} ${response.statusText}` 
                };
            }
    
            // For error responses, throw an error with the server's error message
            if (!response.ok) {
                const errorMessage = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                console.error('API Error Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: url,
                    errorData: data
                });
                
                // Create an error object that includes all the response data
                const error = new Error(errorMessage);
                error.status = response.status;
                error.responseData = data;
                throw error;
            }
    
            return data;
            
        } catch (error) {
            // If it's a network error or other fetch error, wrap it
            if (!error.status) {
                console.error('Network/Fetch error:', error);
                error.message = `Network error: ${error.message}`;
            }
            throw error;
        }
    }

    // ==================== BULK OPERATIONS ====================

    /**
     * Execute a bulk operation with standardized UI updates
     * @param {string} operation - Operation name (for logging)
     * @param {string} url - API endpoint
     * @param {FormData|Object} data - Data to send
     * @param {string} modalId - Modal to close on success
     * @param {Function} successCallback - Optional success callback
     */
    static async executeBulkOperation(operation, url, data, modalId, successCallback = null) {
        const submitBtn = document.querySelector(`#${modalId} .btn-tennis-warning, #${modalId} .btn-tennis-danger, #${modalId} .btn-tennis-success, #${modalId} .btn-primary`);
        
        // Set button loading state
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-loading');
            const originalText = submitBtn.innerHTML;
            submitBtn.setAttribute('data-original-text', originalText);
        }

        try {
            const options = {
                method: 'POST',
            };

            if (data instanceof FormData) {
                options.body = data;
            } else {
                options.body = JSON.stringify(data);
                options.headers = {
                    'Content-Type': 'application/json'
                };
            }

            const result = await this.apiCall(url, options);

            // Handle success
            this.showNotification(result.message || `${operation} completed successfully`, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) modal.hide();
            
            // Execute success callback
            if (successCallback) {
                successCallback(result);
            } else {
                // Default: reload page after short delay
                setTimeout(() => window.location.reload(), 500);
            }

        } catch (error) {
            this.showNotification(error.message || `${operation} failed`, 'danger');
            console.error(`${operation} error:`, error);
        } finally {
            // Reset button state
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-loading');
                const originalText = submitBtn.getAttribute('data-original-text');
                if (originalText) {
                    submitBtn.innerHTML = originalText;
                }
            }
        }
    }

    /**
     * Create a standardized bulk operation modal
     */
    static createBulkOperationModal(operation, title, scopeOptions, alertType, alertMessage, handler, leagues = []) {
        const iconMap = {
            'auto-schedule': 'magic',
            'unschedule': 'calendar-times',
            'delete': 'trash'
        };
    
        const buttonClassMap = {
            'auto-schedule': 'btn-tennis-warning',
            'unschedule': 'btn-tennis-warning', 
            'delete': 'btn-tennis-danger'
        };
    
        const formId = `bulk${operation.charAt(0).toUpperCase() + operation.slice(1).replace('-', '')}Form`;
        const modalId = `bulk${operation.charAt(0).toUpperCase() + operation.slice(1).replace('-', '')}Modal`;
    
        const needsLeagueSelection = scopeOptions.some(option => option.value === 'league');
        
        const modalContent = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-${iconMap[operation]}"></i> ${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="${formId}" class="tennis-form">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-crosshairs"></i> Scope <span class="required">*</span>
                                </label>
                                <div class="form-check-container">
                                    ${scopeOptions.map((option, index) => `
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="scope" value="${option.value}" 
                                                   id="${operation}${option.value}" ${index === 0 ? 'checked' : ''}>
                                            <label class="form-check-label" for="${operation}${option.value}">
                                                ${option.label}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${needsLeagueSelection ? `
                            <div class="mb-3" id="leagueSelection" style="display: none;">
                                <label for="bulkLeagueSelect" class="form-label">
                                    <i class="fas fa-trophy"></i> Select League
                                </label>
                                <select class="form-select" id="bulkLeagueSelect" name="league_id">
                                    <option value="">Choose a league...</option>
                                    ${leagues.map(league => `<option value="${league.id}">${league.name}</option>`).join('')}
                                </select>
                            </div>
                            ` : ''}
                            
                            <div class="alert alert-${alertType}">
                                <i class="fas fa-${alertType === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                                ${alertMessage}
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn ${buttonClassMap[operation]}" onclick="${handler.name}()">
                            <i class="fas fa-${iconMap[operation]}"></i> ${title}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();
        
        const modalElement = document.createElement('div');
        modalElement.className = 'modal fade tennis-modal';
        modalElement.id = modalId;
        modalElement.innerHTML = modalContent;
        document.body.appendChild(modalElement);
        
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    
        if (needsLeagueSelection) {
            setTimeout(() => {
                const scopeRadios = document.querySelectorAll(`#${modalId} input[name="scope"]`);
                const leagueSelection = document.getElementById('leagueSelection');
                
                scopeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (leagueSelection) {
                            leagueSelection.style.display = this.value === 'league' ? 'block' : 'none';
                        }
                    });
                });
            }, 100);
        }
    
        modal._element.addEventListener('hidden.bs.modal', () => {
            document.getElementById(modalId).remove();
        });
    }
    
    /**
     * Add current URL filters to FormData for "selected" scope operations
     */
    static addCurrentFiltersToFormData(formData, targetScope = 'selected') {
        if (formData.get('scope') === targetScope) {
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams) {
                if (!formData.has(key)) {
                    formData.append(key, value);
                }
            }
        }
    }
    


    // ==================== FORM UTILITIES ====================

    /**
     * Set form loading state
     * @param {string} formId - The ID of the form
     * @param {boolean} loading - Whether form is loading
     * @param {string} buttonSelector - CSS selector for the submit button
     */
    static setFormLoading(formId, loading, buttonSelector = 'button[type="submit"], .btn-tennis-success, .btn-tennis-primary') {
        const form = document.getElementById(formId);
        if (!form) {
            console.error(`Form with ID '${formId}' not found`);
            return;
        }

        const button = form.querySelector(buttonSelector);
        
        if (loading) {
            form.classList.add('tennis-loading');
            
            // Create loading overlay if it doesn't exist
            let overlay = form.querySelector('.tennis-loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'tennis-loading-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    border-radius: var(--tennis-border-radius);
                `;
                overlay.innerHTML = '<div class="tennis-spinner"></div>';
                form.style.position = 'relative';
                form.appendChild(overlay);
            }
            
            // Disable and update submit button
            if (button) {
                button.disabled = true;
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.innerHTML;
                }
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                button.classList.add('btn-loading');
            }

            // Disable all form inputs
            const inputs = form.querySelectorAll('input, select, textarea, button');
            inputs.forEach(input => {
                if (!input.hasAttribute('data-loading-disabled')) {
                    input.disabled = true;
                    input.setAttribute('data-loading-disabled', 'true');
                }
            });

        } else {
            form.classList.remove('tennis-loading');
            
            // Remove loading overlay
            const overlay = form.querySelector('.tennis-loading-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Re-enable submit button
            if (button) {
                button.disabled = false;
                button.classList.remove('btn-loading');
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                    delete button.dataset.originalText;
                }
            }

            // Re-enable form inputs
            const inputs = form.querySelectorAll('[data-loading-disabled]');
            inputs.forEach(input => {
                input.disabled = false;
                input.removeAttribute('data-loading-disabled');
            });
        }
    }

    /**
     * Serialize form data to object
     * @param {string} formId - The ID of the form
     * @returns {Object} - Form data as object
     */
    static serializeForm(formId) {
        const form = document.getElementById(formId);
        if (!form) {
            console.error(`Form with ID '${formId}' not found`);
            return {};
        }

        const formData = new FormData(form);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (data[key]) {
                // Handle multiple values (like checkboxes)
                if (Array.isArray(data[key])) {
                    data[key].push(value);
                } else {
                    data[key] = [data[key], value];
                }
            } else {
                data[key] = value;
            }
        }
        
        return data;
    }

    // ==================== LOADING SPINNER UTILITIES ====================

    /**
     * Show a notification message
     * @param {string} message - Message to display
     * @param {string} type - Alert type (success, danger, warning, info)
     * @param {number} duration - Auto-hide duration in milliseconds (default: 8000)
     * @param {Object} options - Additional options
     * @param {boolean} options.showRefresh - Show refresh button (default: false)
     * @param {string} options.refreshText - Text for refresh button (default: 'Refresh')
     * @param {Function} options.onRefresh - Custom refresh callback (default: page reload)
     */
    static showNotification(message, type = 'info', duration = 8000, options = {}) {
        const { 
            showRefresh = false, 
            refreshText = 'Refresh', 
            onRefresh = () => window.location.reload() 
        } = options;
    
        // Create notification element with enhanced styling
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show tennis-notification tennis-notification-enhanced`;
        
        // Add refresh button if requested
        const refreshButton = showRefresh ? `
            <button type="button" class="btn btn-sm btn-outline-light ms-2 tennis-refresh-btn" onclick="handleNotificationRefresh(this)">
                <i class="fas fa-sync-alt"></i> ${refreshText}
            </button>
        ` : '';
        
        notification.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="tennis-notification-icon me-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} fa-lg"></i>
                </div>
                <div class="tennis-notification-content flex-grow-1">
                    <div class="tennis-notification-message">${message}</div>
                </div>
                <div class="tennis-notification-actions">
                    ${refreshButton}
                    <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        `;
    
        // Store refresh callback on the notification element
        if (showRefresh) {
            notification._refreshCallback = onRefresh;
        }
    
        // Add to page
        document.body.appendChild(notification);
    
        // Add click-to-dismiss functionality
        notification.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-close') && !e.target.closest('.tennis-refresh-btn')) {
                // Don't dismiss when clicking buttons
                return;
            }
        });
    
        // Auto-remove after duration (if no refresh button or user preference)
        const timeoutId = setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.remove('show');
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, duration);
    
        // Allow manual dismissal to cancel auto-removal
        notification.addEventListener('closed.bs.alert', () => {
            clearTimeout(timeoutId);
        });
    
        // Add hover to pause auto-dismissal
        let isPaused = false;
        notification.addEventListener('mouseenter', () => {
            isPaused = true;
            clearTimeout(timeoutId);
        });
    
        notification.addEventListener('mouseleave', () => {
            if (isPaused && !showRefresh) { // Don't auto-hide if refresh button is shown
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.remove('show');
                        notification.classList.add('fade-out');
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 2000); // 2 second delay after mouse leave
            }
        });
    }

    /**
     * Show a confirmation dialog
     * @param {string} title - Dialog title
     * @param {string} message - Dialog message
     * @param {string} confirmText - Text for confirm button
     * @param {string} confirmClass - CSS class for confirm button
     * @returns {Promise<boolean>} - True if confirmed, false if cancelled
     */
    static async showConfirmDialog(title, message, confirmText = 'Confirm', confirmClass = 'btn-primary') {
        return new Promise((resolve) => {
            // Create modal HTML
            const modalId = 'tennis-confirm-dialog';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
    
            const modalHTML = `
                <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn ${confirmClass}" id="confirm-action">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
    
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            
            // Handle button clicks
            document.getElementById('confirm-action').addEventListener('click', () => {
                modal.hide();
                resolve(true);
            });
    
            modal._element.addEventListener('hidden.bs.modal', () => {
                document.getElementById(modalId).remove();
                resolve(false);
            });
    
            modal.show();
        });
    }

    /**
     * Set button loading state with text
     */
    static setButtonLoading(selector, loading, loadingText = 'Loading...') {
        const buttons = typeof selector === 'string' ? document.querySelectorAll(selector) : [selector];
        
        buttons.forEach(button => {
            if (loading) {
                if (!button.dataset.originalText) {
                    button.dataset.originalText = button.innerHTML;
                }
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
                button.disabled = true;
            } else {
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                    delete button.dataset.originalText;
                }
            }
        });
    }
    
    /**
     * Download file blob
     */
    static downloadFile(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
        
}

// ==================== LEAGUE MANAGEMENT ====================

class TennisLeagues {

    /**
     * Generate matches for a league
     */
    static async generateMatches(leagueId) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Generate Matches',
            `Are you sure you want to generate matches for this league? This will create match pairings for all teams in the league.`,
            'Generate Matches',
            'btn-tennis-success'
        );
    
        if (!confirmed) return;
    
        try {
            console.log(`🎲 Attempting to generate matches for league ${leagueId}`);
            
            const result = await TennisUI.apiCall(`/api/leagues/${leagueId}/generate-matches`, {
                method: 'POST'
            });
    
            console.log('✅ Generate matches successful:', result);
            TennisUI.showNotification(result.message || 'Matches generated successfully!', 'success');
            
            // Reload page to show new matches
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            console.error('❌ Generate matches error:', error);
            
            // The error.message now contains the actual JSON error message from the server
            let errorMessage = error.message || 'Failed to generate matches. Please try again.';
            
            // Log additional details if available
            if (error.responseData) {
                console.error('Server error details:', error.responseData);
                
                // If there are additional details in the response, we could use them
                if (error.responseData.teams_count !== undefined) {
                    console.log(`League has ${error.responseData.teams_count} teams`);
                }
                if (error.responseData.existing_matches_count !== undefined) {
                    console.log(`League has ${error.responseData.existing_matches_count} existing matches`);
                }
            }
            
            TennisUI.showNotification(errorMessage, 'danger', 7000); // Show for 7 seconds
        }
    }

    /**
     * Delete a single league
     */
    static async deleteLeague(leagueId, leagueName) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete League',
            `Are you sure you want to delete league "${leagueName}"? This action cannot be undone and will also delete all associated teams and matches.`,
            'Delete League',
            'btn-tennis-danger'
        );
    
        if (!confirmed) return;
    
        try {
            console.log(`🗑️ Attempting to delete league ${leagueId}: ${leagueName}`);
            
            const result = await TennisUI.apiCall(`/api/leagues/${leagueId}`, {
                method: 'DELETE'
            });
    
            console.log('✅ Delete league successful:', result);
            TennisUI.showNotification(result.message || 'League deleted successfully!', 'success');
            
            // Reload page to reflect changes
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            console.error('❌ Delete league error:', error);
            
            let errorMessage = error.message || 'Failed to delete league. Please try again.';
            
            // Log additional details if available
            if (error.responseData) {
                console.error('Server error details:', error.responseData);
            }
            
            TennisUI.showNotification(errorMessage, 'danger', 7000);
        }
    }
    
    /**
     * Bulk delete leagues
     */
    static async bulkDeleteLeagues(leagueIds) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Multiple Leagues',
            `Are you sure you want to delete ${leagueIds.length} league(s)? This action cannot be undone and will also delete all associated teams and matches.`,
            `Delete ${leagueIds.length} Leagues`,
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall('/api/leagues/bulk_delete', {
                method: 'POST',
                body: JSON.stringify({ league_ids: leagueIds })
            });

            TennisUI.showNotification(result.message || 'Leagues deleted successfully!', 'success');
            
            // Reload page
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete leagues. Please try again.',
                'danger'
            );
        }
    }

    /**
     * Clear league filters
     */
    static clearFilters() {
        // Clear all filter inputs
        const filters = [
            '#leagueNameFilter',
            '#yearFilter', 
            '#divisionFilter',
            '#sectionFilter',
            '#ageGroupFilter'
        ];
        
        filters.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.value = '';
            }
        });
        
        // Show all rows
        document.querySelectorAll('.league-row').forEach(row => {
            row.style.display = '';
        });
        
        // Reset result count
        const totalCount = document.querySelectorAll('.league-row').length;
        document.querySelectorAll('#resultCount, #tableResultCount').forEach(element => {
            element.textContent = `${totalCount} leagues`;
        });
        
        TennisUI.showNotification('Filters cleared', 'info');
    }
}


    
// ==================== TEAM MANAGEMENT ====================

class TennisTeams {
    /**
     * Delete a team
     */
    static async deleteTeam(teamId, teamName) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Team',
            `Are you sure you want to delete team "${teamName}"? This action cannot be undone and will also remove the team from all matches.`,
            'Delete Team',
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall(`/api/teams/${teamId}`, {
                method: 'DELETE'
            });

            TennisUI.showNotification(result.message || 'Team deleted successfully!', 'success');
            
            // Reload page to reflect changes
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete team. Please try again.',
                'danger'
            );
        }
    }

    /**
     * Bulk delete teams
     */
    static async bulkDeleteTeams(teamIds) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Multiple Teams',
            `Are you sure you want to delete ${teamIds.length} team(s)? This action cannot be undone and will remove the teams from all matches.`,
            `Delete ${teamIds.length} Teams`,
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall('/api/teams/bulk_delete', {
                method: 'POST',
                body: JSON.stringify({ team_ids: teamIds })
            });

            TennisUI.showNotification(result.message || 'Teams deleted successfully!', 'success');
            
            // Reload page
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete teams. Please try again.',
                'danger'
            );
        }
    }
}

// ==================== MATCH MANAGEMENT ====================

class TennisMatches {
    /**
     * Delete a match
     */
    static async deleteMatch(matchId, matchDescription) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Match',
            `Are you sure you want to delete this match "${matchDescription}"? This action cannot be undone.`,
            'Delete Match',
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall(`/api/matches/${matchId}`, {
                method: 'DELETE'
            });

            TennisUI.showNotification(result.message || 'Match deleted successfully!', 'success');
            
            // Reload page to reflect changes
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete match. Please try again.',
                'danger'
            );
        }
    }

    /**
     * Schedule a match
     */
    static async scheduleMatch(matchId, facilityId, date, time) {
        try {
            const result = await TennisUI.apiCall(`/api/matches/${matchId}/schedule`, {
                method: 'POST',
                body: JSON.stringify({
                    facility_id: facilityId,
                    date: date,
                    time: time
                })
            });

            TennisUI.showNotification(result.message || 'Match scheduled successfully!', 'success');
            
            // Reload page to show updated schedule
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to schedule match. Please try again.',
                'danger'
            );
        }
    }

    /**
     * Bulk delete matches
     */
    static async bulkDeleteMatches(matchIds) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Multiple Matches',
            `Are you sure you want to delete ${matchIds.length} match(es)? This action cannot be undone.`,
            `Delete ${matchIds.length} Matches`,
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall('/api/matches/bulk_delete', {
                method: 'POST',
                body: JSON.stringify({ match_ids: matchIds })
            });

            TennisUI.showNotification(result.message || 'Matches deleted successfully!', 'success');
            
            // Reload page
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete matches. Please try again.',
                'danger'
            );
        }
    }
}

// ==================== FACILITY MANAGEMENT ====================

class TennisFacilities {
    /**
     * Delete a facility
     */
    static async deleteFacility(facilityId, facilityName) {
        const confirmed = await TennisUI.showConfirmDialog(
            'Delete Facility',
            `Are you sure you want to delete facility "${facilityName}"? This action cannot be undone and may affect teams and matches using this facility.`,
            'Delete Facility',
            'btn-tennis-danger'
        );

        if (!confirmed) return;

        try {
            const result = await TennisUI.apiCall(`/api/facilities/${facilityId}`, {
                method: 'DELETE'
            });

            TennisUI.showNotification(result.message || 'Facility deleted successfully!', 'success');
            
            // Reload page to reflect changes
            setTimeout(() => window.location.reload(), 1000);
            
        } catch (error) {
            TennisUI.showNotification(
                error.message || 'Failed to delete facility. Please try again.',
                'danger'
            );
        }
    }
}

// ==================== FORM ENHANCEMENTS ====================

class TennisForms {
    /**
     * Initialize form validation and enhancement
     */
    static initializeFormValidation() {
        document.querySelectorAll('.tennis-form').forEach(form => {
            form.addEventListener('submit', this.handleFormSubmit.bind(this));
            
            // Add real-time validation
            form.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('blur', () => this.validateField(field));
                field.addEventListener('input', () => this.clearFieldError(field));
            });
        });
    }

    static handleFormSubmit(event) {
        const form = event.target;
        const isValid = this.validateForm(form);
        
        if (!isValid) {
            event.preventDefault();
            TennisUI.showNotification('Please correct the errors in the form', 'warning');
        }
    }

    static validateForm(form) {
        let isValid = true;
        
        form.querySelectorAll('[required]').forEach(field => {
            if (!this.validateField(field)) {
                isValid = false;
            }
        });
      
        return isValid;
    }

    static validateField(field) {
        const value = field.value.trim();
        const isRequired = field.hasAttribute('required');
        const fieldType = field.type;
        
        // Clear previous errors
        this.clearFieldError(field);
        
        // Check required fields
        if (isRequired && !value) {
            this.showFieldError(field, 'This field is required');
            return false;
        }
        
        // Type-specific validation
        if (value) {
            switch (fieldType) {
                case 'email':
                    if (!this.isValidEmail(value)) {
                        this.showFieldError(field, 'Please enter a valid email address');
                        return false;
                    }
                    break;
                case 'number':
                    const min = field.getAttribute('min');
                    const max = field.getAttribute('max');
                    const numValue = parseFloat(value);
                    
                    if (isNaN(numValue)) {
                        this.showFieldError(field, 'Please enter a valid number');
                        return false;
                    }
                    
                    if (min !== null && numValue < parseFloat(min)) {
                        this.showFieldError(field, `Value must be at least ${min}`);
                        return false;
                    }
                    
                    if (max !== null && numValue > parseFloat(max)) {
                        this.showFieldError(field, `Value must be no more than ${max}`);
                        return false;
                    }
                    break;
            }
        }
        
        return true;
    }

    static showFieldError(field, message) {
        field.classList.add('is-invalid');
        
        let feedback = field.parentNode.querySelector('.invalid-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            field.parentNode.appendChild(feedback);
        }
        
        feedback.textContent = message;
    }

    static clearFieldError(field) {
        field.classList.remove('is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) {
            feedback.remove();
        }
    }

    static isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
}

// ==================== DROPDOWN ENHANCEMENTS ====================

class TennisDropdowns {
    static init() {
        this.initializeCascadingDropdowns();
        this.initializeSearchableDropdowns();
        console.log('✅ Dropdown Management - Initialized');
    }
    
    static initializeCascadingDropdowns() {
        // Section -> Region cascading
        const sectionSelect = document.getElementById('section');
        const regionSelect = document.getElementById('region');
        
        if (sectionSelect && regionSelect) {
            sectionSelect.addEventListener('change', () => {
                this.updateRegionOptions(sectionSelect.value, regionSelect);
            });
        }
    }
    
    static updateRegionOptions(section, regionSelect) {
        // This would be populated with actual region data
        const regionsBySection = {
            'Southwest': ['Northern New Mexico', 'Southern New Mexico', 'Arizona', 'Colorado'],
            'Texas': ['North Texas', 'South Texas', 'East Texas', 'West Texas'],
            'Southern': ['Georgia', 'Alabama', 'Florida', 'South Carolina']
        };
        
        regionSelect.innerHTML = '<option value="">Select a region...</option>';
        
        if (regionsBySection[section]) {
            regionsBySection[section].forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
        }
    }
    
    static initializeSearchableDropdowns() {
        // Add search functionality to large dropdowns
        document.querySelectorAll('select[data-searchable]').forEach(select => {
            this.makeDropdownSearchable(select);
        });
    }
    
    static makeDropdownSearchable(select) {
        // This would implement a searchable dropdown functionality
        // For now, just add basic filtering
        const wrapper = document.createElement('div');
        wrapper.className = 'searchable-dropdown';
        select.parentNode.insertBefore(wrapper, select);
        wrapper.appendChild(select);
        
        const search = document.createElement('input');
        search.type = 'text';
        search.className = 'form-control mb-2';
        search.placeholder = 'Search options...';
        wrapper.insertBefore(search, select);
        
        search.addEventListener('input', () => {
            const searchTerm = search.value.toLowerCase();
            Array.from(select.options).forEach(option => {
                option.style.display = option.text.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });
    }
}

// ==================== BADGE MANAGEMENT ====================

class TennisBadges {
    static init() {
        this.initializeBadgeAnimations();
        this.initializeStatusBadges();
        console.log('✅ Badge Management - Initialized');
    }
    
    static initializeBadgeAnimations() {
        document.querySelectorAll('.badge, .tennis-badge-info, .tennis-badge-warning, .tennis-badge-success').forEach(badge => {
            badge.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.15s ease';
            });
            
            badge.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        });
    }
    
    static initializeStatusBadges() {
        // Update badge colors based on status
        document.querySelectorAll('[data-status]').forEach(element => {
            const status = element.dataset.status;
            this.updateStatusBadge(element, status);
        });
    }
    
    static updateStatusBadge(element, status) {
        element.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-info', 'bg-secondary');
        
        switch(status.toLowerCase()) {
            case 'active':
            case 'scheduled':
            case 'completed':
                element.classList.add('bg-success');
                break;
            case 'pending':
            case 'unscheduled':
                element.classList.add('bg-warning');
                break;
            case 'cancelled':
            case 'inactive':
                element.classList.add('bg-danger');
                break;
            case 'in-progress':
                element.classList.add('bg-info');
                break;
            default:
                element.classList.add('bg-secondary');
        }
    }
}

// ==================== CARD MANAGEMENT ====================

class TennisCards {
    static init() {
        this.initializeCardAnimations();
        this.initializeStatCards();
        console.log('✅ Card Management - Initialized');
    }
    
    static initializeCardAnimations() {
        // Enhanced hover effects for tennis cards
        document.querySelectorAll('.tennis-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.12)';
                this.style.transition = 'all 0.2s ease';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
        
        // Special handling for league detail cards
        document.querySelectorAll('.league-detail-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.12)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
    }
    
    static initializeStatCards() {
        // Animate stat card numbers on scroll
        const statCards = document.querySelectorAll('.stat-card h4');
        
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.animateNumber(entry.target);
                        observer.unobserve(entry.target);
                    }
                });
            });
            
            statCards.forEach(card => observer.observe(card));
        }
    }
    
    static animateNumber(element) {
        const finalNumber = parseInt(element.textContent);
        if (isNaN(finalNumber)) return;
        
        let currentNumber = 0;
        const increment = Math.ceil(finalNumber / 20);
        const timer = setInterval(() => {
            currentNumber += increment;
            if (currentNumber >= finalNumber) {
                currentNumber = finalNumber;
                clearInterval(timer);
            }
            element.textContent = currentNumber;
        }, 50);
    }
}


// ==================== GENERALIZED IMPORT/EXPORT MANAGEMENT ====================

class TennisImportExport {

    /**
     * Initialize import/export functionality (called when modal opens)
     */
    static init() {
        // File input change handler
        const fileInput = document.getElementById('yamlFileInput');
        const uploadArea = document.getElementById('fileUploadArea');
        const importBtn = document.getElementById('importBtn');
    
        if (fileInput && uploadArea && importBtn) {
            // Remove existing listeners to prevent duplicates
            fileInput.removeEventListener('change', this.handleFileSelect);
            uploadArea.removeEventListener('dragover', this.handleDragOver);
            uploadArea.removeEventListener('dragleave', this.handleDragLeave);
            uploadArea.removeEventListener('drop', this.handleDrop);
            uploadArea.removeEventListener('click', this.clickHandler);
    
            // Add fresh listeners
            this.clickHandler = () => fileInput.click();
            fileInput.addEventListener('change', this.handleFileSelect.bind(this));
            uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
            uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
            uploadArea.addEventListener('drop', this.handleDrop.bind(this));
            // Don't add click handler to entire area since button handles it
            //uploadArea.addEventListener('click', this.clickHandler);
        }
    }
    
    /**
     * Handle file selection
     */
    static handleFileSelect(event) {
        const file = event.target.files[0];
        this.processSelectedFile(file);
    }
    
    /**
     * Handle drag over
     */
    static handleDragOver(event) {
        event.preventDefault();
        event.target.closest('.tennis-file-upload-area').classList.add('dragover');
    }
    
    /**
     * Handle drag leave
     */
    static handleDragLeave(event) {
        event.target.closest('.tennis-file-upload-area').classList.remove('dragover');
    }
    
    /**
     * Handle file drop
     */
    static handleDrop(event) {
        event.preventDefault();
        const uploadArea = event.target.closest('.tennis-file-upload-area');
        uploadArea.classList.remove('dragover');
        
        const file = event.dataTransfer.files[0];
        this.processSelectedFile(file);
    }
    
    /**
     * Process the selected file
     */
    static processSelectedFile(file) {
        const importBtn = document.getElementById('importBtn');
        
        if (!file) {
            importBtn.disabled = true;
            return;
        }
    
        if (!file.name.toLowerCase().endsWith('.yaml') && !file.name.toLowerCase().endsWith('.yml')) {
            TennisUI.showNotification('Please select a YAML file (.yaml or .yml)', 'warning');
            importBtn.disabled = true;
            return;
        }
    
        // Store file for import
        this.selectedFile = file;
        importBtn.disabled = false;
        
        // Update upload area to show selected file
        const uploadArea = document.getElementById('fileUploadArea');
        uploadArea.innerHTML = `
            <div class="tennis-file-upload-content">
                <i class="fas fa-file-check fa-2x text-tennis-success mb-2"></i>
                <div>
                    <strong>File Selected: ${file.name}</strong>
                    <div class="small text-muted mt-1">Ready to import</div>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" onclick="TennisImportExport.resetFileUpload()">
                <i class="fas fa-times"></i> Change File
            </button>
        `;
        
        TennisUI.showNotification(`File "${file.name}" selected and ready for import`, 'info');
    }
    
    /**
     * Reset file upload area
     */
    static resetFileUpload() {
        const uploadArea = document.getElementById('fileUploadArea');
        uploadArea.innerHTML = `
            <div class="tennis-file-upload-content">
                <i class="fas fa-cloud-upload-alt fa-2x text-tennis-primary mb-2"></i>
                <div>
                    <strong>Drop YAML file here or click to browse</strong>
                    <div class="small text-muted mt-1">Supports .yaml and .yml files</div>
                </div>
            </div>
            <input type="file" id="yamlFileInput" accept=".yaml,.yml" style="display: none;">
            <button class="btn btn-tennis-primary mt-2" onclick="document.getElementById('yamlFileInput').click()">
                <i class="fas fa-folder-open"></i> Select File
            </button>
        `;
        
        document.getElementById('importBtn').disabled = true;
        this.selectedFile = null;
        this.init(); // Reinitialize handlers
    }
    
    /**
     * Download example YAML file
     */
    static downloadExample() {
        const examples = {
            leagues: `# Example leagues.yaml file
    - name: "Men's 4.0 Singles"
      year: 2025
      section: "Southwest"
      region: "Northern New Mexico"
      age_group: "18 & Over"
      division: "4.0"
      num_lines_per_match: 3
      num_matches: 12
      allow_split_lines: false
      preferred_days: ["Saturday", "Sunday"]
      backup_days: ["Friday"]
      start_date: "2025-03-01"
      end_date: "2025-09-30"
    
    - name: "Women's 3.5 Doubles"
      year: 2025
      section: "Southwest"
      region: "Northern New Mexico"
      age_group: "18 & Over"
      division: "3.5"
      num_lines_per_match: 3
      num_matches: 10
      allow_split_lines: true
      preferred_days: ["Saturday"]
      backup_days: ["Sunday", "Friday"]
      start_date: "2025-03-15"
      end_date: "2025-09-15"`,
    
            teams: `# Example teams.yaml file
    - name: "Lightning Bolts"
      league_id: 101
      captain: "Jane Smith"
      home_facility_id: 5
      preferred_days: ["Saturday", "Sunday"]
    
    - name: "Thunder Strikes"
      league_id: 101
      captain: "John Doe"
      home_facility_id: 3
      preferred_days: ["Tuesday", "Thursday"]`,
    
            facilities: `# Example facilities.yaml file
    - name: "Tennis Center North"
      location: "123 Tennis Ave, Las Cruces, NM"
      total_courts: 6
      schedule:
        Monday:
          start_times:
            - time: "09:00"
              available_courts: 4
            - time: "10:30"
              available_courts: 4
            - time: "12:00"
              available_courts: 6
        Tuesday:
          start_times:
            - time: "09:00"
              available_courts: 4
            - time: "10:30"
              available_courts: 4
        Wednesday:
          start_times: []
        Thursday:
          start_times:
            - time: "09:00"
              available_courts: 6
        Friday:
          start_times:
            - time: "09:00"
              available_courts: 4
        Saturday:
          start_times:
            - time: "08:00"
              available_courts: 6
            - time: "10:00"
              available_courts: 6
            - time: "12:00"
              available_courts: 6
        Sunday:
          start_times:
            - time: "08:00"
              available_courts: 6
            - time: "10:00"
              available_courts: 6
      unavailable_dates:
        - "2025-07-04"
        - "2025-12-25"
    
    - name: "Westside Tennis Club"
      location: "456 Court St, Las Cruces, NM"
      total_courts: 4
      schedule:
        Monday:
          start_times:
            - time: "09:00"
              available_courts: 2
        Tuesday:
          start_times:
            - time: "09:00"
              available_courts: 2
        Wednesday:
          start_times: []
        Thursday:
          start_times:
            - time: "09:00"
              available_courts: 2
        Friday:
          start_times:
            - time: "09:00"
              available_courts: 2
        Saturday:
          start_times:
            - time: "08:00"
              available_courts: 4
            - time: "10:00"
              available_courts: 4
        Sunday:
          start_times:
            - time: "08:00"
              available_courts: 4
      unavailable_dates: []`,
    
            matches: `# Example matches.yaml file
    # Note: Matches are typically generated automatically
    # This is an example of the expected format
    - team1_id: 101
      team2_id: 102
      league_id: 1
      date: "2025-06-15"
      time: "09:00"
      facility_id: 5
    
    - team1_id: 103
      team2_id: 104
      league_id: 1
      date: "2025-06-22"
      time: "10:00"
      facility_id: 3`
        };
    
        const exampleContent = examples[this.currentDataType] || examples.leagues;
        const blob = new Blob([exampleContent], { type: 'text/yaml' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `example_${this.currentDataType}.yaml`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    
        TennisUI.showNotification('Example YAML file downloaded', 'info');
    }
    /**
     * Show import/export modal for any data type
     * @param {string} dataType - 'leagues', 'teams', 'facilities', 'matches'
     * @param {string} title - Modal title
     */
    static showModal(dataType, title) {
        this.currentDataType = dataType;
        
        // Create modal dynamically using shared modal structure
        const modalHtml = this.createModalHtml(dataType, title);
        
        // Remove existing modal if present
        const existingModal = document.getElementById('importExportModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('importExportModal'));
        modal.show();
        
        // Initialize after modal is shown
        setTimeout(() => this.init(), 100);
        
        // Clean up on close
        modal._element.addEventListener('hidden.bs.modal', () => {
            document.getElementById('importExportModal').remove();
        });
    }

    /**
     * Create modal HTML using shared structure
     */
    static createModalHtml(dataType, title) {
        const examples = this.getExamples(dataType);
        
        return `
        <div class="modal fade tennis-modal" id="importExportModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-exchange-alt"></i>
                            ${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="tennis-import-section">
                                    <h5><i class="fas fa-upload text-tennis-primary"></i> Import ${dataType.charAt(0).toUpperCase() + dataType.slice(1)}</h5>
                                    <p class="text-muted">Upload a YAML file to import multiple ${dataType}.</p>
                                    
                                    <div class="tennis-file-upload-area" id="fileUploadArea">
                                        <div class="tennis-file-upload-content">
                                            <i class="fas fa-cloud-upload-alt fa-2x text-tennis-primary mb-2"></i>
                                            <div>
                                                <strong>Drop YAML file here or click to browse</strong>
                                                <div class="small text-muted mt-1">Supports .yaml and .yml files</div>
                                            </div>
                                        </div>
                                        <input type="file" id="yamlFileInput" accept=".yaml,.yml" style="display: none;">
                                        <button class="btn btn-tennis-primary mt-2" onclick="document.getElementById('yamlFileInput').click()">
                                            <i class="fas fa-folder-open"></i> Select File
                                        </button>
                                    </div>
                                    
                                    <div class="tennis-import-actions mt-3">
                                        <button class="btn btn-tennis-success" id="importBtn" onclick="TennisImportExport.executeImport()" disabled>
                                            <i class="fas fa-upload"></i> Import ${dataType.charAt(0).toUpperCase() + dataType.slice(1)}
                                        </button>
                                        <button class="btn btn-outline-info ms-2" onclick="TennisImportExport.downloadExample()">
                                            <i class="fas fa-download"></i> Download Example
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="tennis-export-section">
                                    <h5><i class="fas fa-download text-tennis-success"></i> Export ${dataType.charAt(0).toUpperCase() + dataType.slice(1)}</h5>
                                    <p class="text-muted">Download your ${dataType} data in various formats.</p>
                                    
                                    <div class="tennis-export-options">
                                        <button class="btn btn-tennis-success btn-export" onclick="TennisImportExport.executeExport('yaml')">
                                            <i class="fas fa-file-code"></i> Export YAML
                                        </button>
                                        <button class="btn btn-tennis-info btn-export" onclick="TennisImportExport.executeExport('json')">
                                            <i class="fas fa-file-download"></i> Export JSON
                                        </button>
                                        <button class="btn btn-outline-secondary btn-export" onclick="TennisImportExport.executeExport('csv')">
                                            <i class="fas fa-table"></i> Export CSV
                                        </button>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6><i class="fas fa-info-circle text-tennis-info"></i> YAML Format Example:</h6>
                                        <div class="tennis-example-code">${examples}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-lightbulb"></i> Quick Guide</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Import Process:</strong>
                                            <ol class="mb-0">
                                                <li>Download example to see format</li>
                                                <li>Prepare your YAML file</li>
                                                <li>Select or drag your file</li>
                                                <li>Click Import button</li>
                                            </ol>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Export Options:</strong>
                                            <ul class="mb-0">
                                                <li><strong>YAML:</strong> For importing later</li>
                                                <li><strong>JSON:</strong> For data processing</li>
                                                <li><strong>CSV:</strong> For spreadsheet apps</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>`;
    }

    /**
     * Get examples for different data types
     */
    static getExamples(dataType) {
        const examples = {
            leagues:`
leagues:
  - id: 201
    name: "2025 Adult 18+ 4.5 Women"
    year: 2025
    section: "Southwest"
    region: "Northern New Mexico"
    age_group: "18 & Over"
    division: "4.5 Women"
    num_lines_per_match: 5
    num_matches: 10
    allow_split_lines: false
    preferred_days:
      - "Sunday"
      - "Thursday"
    backup_days:
      - "Wednesday"
    start_date: "2025-03-01"
    end_date: "2025-05-01"`,
            
            teams: `
teams:
    - id: 2001
      name: "Lightning Bolts"
      league_id: 101
      captain: "Jane Smith"
      home_facility_id: 5
      preferred_days: ["Saturday"]`,
            
            facilities: `
facilities:
    - id: 14512
      name: "Tennis Center North"
      short_name: "TCN"
      location: "123 Tennis Ave"
      total_courts: 6
      schedule:
          Monday:
            start_times:
              - time: "18:00"
                available_courts: 5
          Tuesday:
            start_times:
              - time: "18:00"
                available_courts: 5
          Wednesday:
            start_times:
              - time: "18:00"
                available_courts: 5
          Thursday:
            start_times:
              - time: "18:00"
                available_courts: 5
          Friday:
            start_times:
              - time: "18:00"
                available_courts: 5
          Saturday:
            start_times:
              - time: "12:00"
                available_courts: 5
              - time: "14:00"
                available_courts: 5
          Sunday:
            start_times:
              - time: "12:00"
                available_courts: 5
              - time: "14:00"
                available_courts: 5
        unavailable_dates:
          - "2025-03-09"
          - "2025-03-23"`,
            
            matches: `
matches: 
    - team1_id: 101
      team2_id: 102
      league_id: 1
      date: "2025-06-15"
      time: "09:00"`
        };
        return examples[dataType] || '';
    }

    static async executeImport() {
        if (!this.selectedFile) {
            TennisUI.showNotification('Please select a YAML file first', 'warning');
            return;
        }
    
        const formData = new FormData();
        formData.append('yaml_file', this.selectedFile);
    
        try {
            TennisUI.setButtonLoading('importBtn', true, 'Importing...');
            
            const response = await fetch(`/api/import-${this.currentDataType}`, {
                method: 'POST',
                body: formData
            });
    
            const result = await response.json();
    
            if (!response.ok) {
                // Get the detailed error message from the server response
                const errorMessage = result.error || result.message || `Import failed: ${response.status} ${response.statusText}`;
                throw new Error(errorMessage);
            }
    
            TennisUI.showNotification(result.message || 'Import completed successfully!', 'success');
            
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('importExportModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 500);
    
        } catch (error) {
            TennisUI.showNotification(error.message || 'Import failed', 'danger');
            TennisUI.setButtonLoading('importBtn', false);
        }
    }

    /**
     * Execute export using dynamic API endpoint
     */
    static async executeExport(format) {
        try {
            TennisUI.setButtonLoading('.btn-export', true, 'Exporting...');

            const response = await fetch(`/api/export-${this.currentDataType}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ format: format })
            });

            if (!response.ok) {
                throw new Error(`Export failed: ${response.status} ${response.statusText}`);
            }

            // Handle file download
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `${this.currentDataType}_export.${format}`;
            if (contentDisposition) {
                const match = contentDisposition.match(/filename="(.+)"/);
                if (match) filename = match[1];
            }

            const blob = await response.blob();
            TennisUI.downloadFile(blob, filename);

            TennisUI.showNotification(`${this.currentDataType.charAt(0).toUpperCase() + this.currentDataType.slice(1)} exported as ${format.toUpperCase()}`, 'success');

        } catch (error) {
            TennisUI.showNotification(error.message || 'Export failed', 'danger');
        } finally {
            TennisUI.setButtonLoading('.btn-export', false);
        }
    }

    // ... [keep existing file handling methods but remove hardcoded references]
}

// ==================== GLOBAL Functions ====================

    
/**
 * Handle refresh button click in notifications
 */
function handleNotificationRefresh(button) {
    const notification = button.closest('.tennis-notification');
    if (notification && notification._refreshCallback) {
        // Show loading state on button
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        button.disabled = true;
        
        // Execute refresh callback
        try {
            notification._refreshCallback();
        } catch (error) {
            console.error('Refresh callback error:', error);
            // Restore button state on error
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }
}

// ==================== GLOBAL INITIALIZATION ====================

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    TennisUI.init();
    TennisForms.initializeFormValidation();
    TennisDropdowns.init();
    TennisBadges.init();
    TennisCards.init();
});

// Make classes available globally - add TennisImportExport
window.TennisImportExport = TennisImportExport;

// Make classes available globally
window.TennisUI = TennisUI;
window.TennisLeagues = TennisLeagues;
window.TennisTeams = TennisTeams;
window.TennisMatches = TennisMatches;
window.TennisFacilities = TennisFacilities;
window.TennisForms = TennisForms;
window.TennisDropdowns = TennisDropdowns;
window.TennisBadges = TennisBadges;
window.TennisCards = TennisCards;
</script>
