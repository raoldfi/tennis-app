{% extends "base.html" %}

{% block title %}Match Schedule - Tennis Database{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-calendar-week"></i> Match Schedule
        {% if selected_league %}
        <small class="text-muted">for {{ selected_league.name }}</small>
        {% endif %}
    </h1>
    <div class="d-flex gap-2">
        <span class="badge badge-match fs-6">{{ total_matches }} scheduled matches</span>
        <a href="{{ url_for('matches') }}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> View All Matches
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row align-items-end">
            <div class="col-md-4">
                <label for="league_id" class="form-label">
                    <i class="fas fa-filter"></i> Filter by League
                </label>
                <select class="form-select" id="league_id" name="league_id" onchange="this.form.submit()">
                    <option value="">All Leagues</option>
                    {% for league in leagues %}
                    <option value="{{ league.id }}" {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                        {{ league.name }} ({{ league.year }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="start_date" class="form-label">
                    <i class="fas fa-calendar-alt"></i> Start Date
                </label>
                <input type="date" class="form-control" id="start_date" name="start_date" 
                       value="{{ start_date }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">
                    <i class="fas fa-calendar-alt"></i> End Date
                </label>
                <input type="date" class="form-control" id="end_date" name="end_date" 
                       value="{{ end_date }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-2">
                {% if selected_league or start_date or end_date %}
                <a href="{{ url_for('schedule') }}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-times"></i> Clear
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Schedule Display -->
{% if schedule_data %}
<div class="row">
    {% for day_data in schedule_data %}
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">
                            <i class="fas fa-calendar-day"></i> 
                            {{ day_data.day_name }}
                            <small class="ms-2">{{ day_data.formatted_date }}</small>
                        </h4>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-light text-dark fs-6">
                            {{ day_data.matches|length }} match{% if day_data.matches|length != 1 %}es{% endif %}
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if day_data.matches %}
                <!-- Desktop Table View -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>Home Team</th>
                                    <th>Visitor Team</th>
                                    <th>Facility</th>
                                    <th>League</th>
                                    <th>Match ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for match in day_data.matches %}
                                <tr>
                                    <td>
                                        {% if match.time %}
                                            <span class="badge bg-success">{{ match.time }}</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">TBD</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ match.home_team_name }}</strong>
                                        <div class="small text-muted">Home</div>
                                    </td>
                                    <td>
                                        <strong>{{ match.visitor_team_name }}</strong>
                                        <div class="small text-muted">Visitor</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ match.facility_name }}</span>
                                    </td>
                                    <td>
                                        <div class="small text-muted">{{ match.league_name }}</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ match.id }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile Card View -->
                <div class="d-block d-md-none">
                    {% for match in day_data.matches %}
                    <div class="card mb-3 border-start border-primary border-3">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-3">
                                    {% if match.time %}
                                        <span class="badge bg-success">{{ match.time }}</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">TBD</span>
                                    {% endif %}
                                </div>
                                <div class="col-9">
                                    <div class="fw-bold">
                                        {{ match.home_team_name }} vs {{ match.visitor_team_name }}
                                    </div>
                                    <div class="small text-muted">
                                        <i class="fas fa-building"></i> {{ match.facility_name }} •
                                        <i class="fas fa-trophy"></i> {{ match.league_name }} •
                                        ID: {{ match.id }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                    <div>No matches scheduled for this day</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Schedule Summary -->
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-chart-bar"></i> Schedule Summary
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="text-primary">{{ schedule_data|length }}</h3>
                    <small class="text-muted">Days with matches</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="text-success">{{ total_matches }}</h3>
                    <small class="text-muted">Total matches</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="text-info">
                        {% if schedule_data %}
                        {{ "%.1f"|format(total_matches / schedule_data|length) }}
                        {% else %}
                        0
                        {% endif %}
                    </h3>
                    <small class="text-muted">Avg matches/day</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="text-warning">
                        {% if schedule_data %}
                        {{ schedule_data|length }}
                        {% else %}
                        0
                        {% endif %}
                    </h3>
                    <small class="text-muted">Playing days</small>
                </div>
            </div>
        </div>
        
        {% if schedule_data %}
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-calendar-day text-primary"></i> Date Range</h6>
                <p class="mb-1">
                    <strong>First match:</strong> {{ schedule_data[0].formatted_date }}
                </p>
                <p class="mb-0">
                    <strong>Last match:</strong> {{ schedule_data[-1].formatted_date }}
                </p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-chart-pie text-success"></i> Busiest Days</h6>
                {% set sorted_days = schedule_data|sort(attribute='matches.length', reverse=True) %}
                {% for day_data in sorted_days[:3] %}
                <p class="mb-1">
                    <strong>{{ day_data.day_name }} ({{ day_data.formatted_date.split(',')[0] }}):</strong> 
                    {{ day_data.matches|length }} matches
                </p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<div class="card">
    <div class="card-body text-center">
        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
        <h5>No Scheduled Matches Found</h5>
        {% if selected_league %}
        <p class="text-muted">No scheduled matches found for league: <strong>{{ selected_league.name }}</strong></p>
        {% elif start_date or end_date %}
        <p class="text-muted">No scheduled matches found in the specified date range.</p>
        {% else %}
        <p class="text-muted">No matches have been scheduled yet.</p>
        {% endif %}
        
        <div class="d-flex gap-2 justify-content-center">
            <a href="{{ url_for('matches') }}" class="btn btn-primary">
                <i class="fas fa-calendar-alt"></i> View All Matches
            </a>
            <a href="{{ url_for('leagues') }}" class="btn btn-success">
                <i class="fas fa-magic"></i> Generate Matches
            </a>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Note:</strong> This page only shows matches that have been scheduled with specific dates.
            Unscheduled matches are not displayed here.
            
            <div class="mt-2">
                <strong>To see unscheduled matches:</strong> Visit the 
                <a href="{{ url_for('matches') }}?show_unscheduled=true">Matches page</a> 
                and check "Include Unscheduled".
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="mt-4">
    <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <a href="{{ url_for('matches') }}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> All Matches
        </a>
        
        {% if schedule_data %}
        <button class="btn btn-outline-success" onclick="printSchedule()">
            <i class="fas fa-print"></i> Print Schedule
        </button>
        
        <button class="btn btn-outline-info" onclick="exportSchedule()">
            <i class="fas fa-download"></i> Export CSV
        </button>
        {% endif %}
        
        <a href="{{ url_for('leagues') }}" class="btn btn-outline-warning">
            <i class="fas fa-trophy"></i> View Leagues
        </a>
    </div>
</div>

<!-- Quick Date Navigation -->
{% if schedule_data %}
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-fast-forward"></i> Quick Navigation
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
            {% for day_data in schedule_data %}
            <a href="#day-{{ day_data.date_str }}" class="btn btn-sm btn-outline-primary">
                {{ day_data.day_name[:3] }} {{ day_data.date_str.split('-')[1] }}/{{ day_data.date_str.split('-')[2] }}
                <span class="badge bg-primary ms-1">{{ day_data.matches|length }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add anchor points for navigation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add anchor IDs to day cards for navigation
    const dayCards = document.querySelectorAll('.card .card-header');
    {% for day_data in schedule_data %}
    if (dayCards[{{ loop.index0 }}]) {
        dayCards[{{ loop.index0 }}].closest('.card').id = 'day-{{ day_data.date_str }}';
    }
    {% endfor %}
});
</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Print functionality
function printSchedule() {
    window.print();
}

// Export to CSV functionality
function exportSchedule() {
    const csvData = [];
    csvData.push(['Date', 'Day', 'Time', 'Home Team', 'Visitor Team', 'Facility', 'League', 'Match ID']);
    
    {% for day_data in schedule_data %}
    {% for match in day_data.matches %}
    csvData.push([
        '{{ day_data.date_str }}',
        '{{ day_data.day_name }}',
        '{{ match.time or "TBD" }}',
        '{{ match.home_team_name }}',
        '{{ match.visitor_team_name }}',
        '{{ match.facility_name }}',
        '{{ match.league_name }}',
        '{{ match.id }}'
    ]);
    {% endfor %}
    {% endfor %}
    
    const csvContent = csvData.map(row => row.map(field => 
        '"' + String(field).replace(/"/g, '""') + '"'
    ).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'tennis_schedule.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Auto-refresh for live schedule updates (optional)
// setInterval(() => {
//     if (!document.hidden) {
//         window.location.reload();
//     }
// }, 300000); // Refresh every 5 minutes

// Smooth scrolling for quick navigation
document.addEventListener('DOMContentLoaded', function() {
    const quickNavLinks = document.querySelectorAll('a[href^="#day-"]');
    quickNavLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Add print styles
const printStyles = document.createElement('style');
printStyles.textContent = `
    @media print {
        .btn, .card-header .badge, .alert, nav, footer {
            display: none !important;
        }
        .card {
            break-inside: avoid;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fa !important;
            color: #000 !important;
        }
        body {
            font-size: 12px;
        }
        .table {
            font-size: 11px;
        }
    }
`;
document.head.appendChild(printStyles);
</script>
{% endblock %}
