{% extends "base.html" %}

{% block title %}Schedule Match - {{ match_info.home_team }} vs {{ match_info.visitor_team }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/schedule-match.css') }}">
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('matches') }}">Matches</a></li>
        <li class="breadcrumb-item active" aria-current="page">Schedule Match</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="tennis-page-header">
    <h1 class="tennis-page-title">
        <i class="fas fa-calendar-plus"></i>
        Schedule Match
    </h1>
    <p class="tennis-subtitle">
        {{ match_info.home_team }} vs {{ match_info.visitor_team }} - Find the perfect time and date
    </p>
</div>

<!-- Match Info Card -->
<div class="tennis-card card-primary mb-4" 
     data-match-id="{{ match_info.id }}"
     data-lines-needed="{{ match_info.lines_needed }}"
     data-facility-info-id="{{ facility_info.id if facility_info else '' }}"
     data-home-team="{{ match_info.home_team }}"
     data-visitor-team="{{ match_info.visitor_team }}"
     data-league="{{ match_info.league }}">
    <div class="tennis-card-header">
        <h3>Match Details</h3>
    </div>
    <div class="tennis-card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-3 text-tennis-primary">
                    {{ match_info.home_team }} 
                    <span class="text-tennis-secondary mx-3">vs</span> 
                    {{ match_info.visitor_team }}
                </h4>
                <div class="d-flex flex-wrap gap-2">
                    <span class="tennis-badge tennis-badge-info">
                        <i class="fas fa-circle-play me-1"></i>
                        Round {{ match_info.round }} / {{ match_info.num_rounds }}
                    </span>
                    <span class="tennis-badge tennis-badge-secondary">
                        <i class="fas fa-trophy me-1"></i>
                        {{ match_info.league }}
                    </span>
                    <span class="tennis-badge tennis-badge-warning">
                        <i class="fas fa-tennis-ball me-1"></i>
                        {{ match_info.lines_needed }} Lines Needed
                    </span>
                </div>
            </div>
            <div class="col-md-4">
                {% if facility_info %}
                <div class="tennis-card card-info">
                    <div class="tennis-card-body">
                        <h6 class="mb-2 text-tennis-primary">
                            <i class="fas fa-building me-2"></i>{{ facility_info.name }}
                        </h6>
                        {% if facility_info.location %}
                        <p class="small mb-1"><i class="fas fa-location-dot me-1"></i>{{ facility_info.location }}</p>
                        {% endif %}
                        <p class="small mb-0"><i class="fas fa-tennis-ball me-1"></i>{{ facility_info.available_courts }} Courts Available</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
{% if success and available_dates %}
<div class="row">
    <!-- Available Dates -->
    <div class="col-lg-8">
        <div class="tennis-card">
            <div class="tennis-card-header">
                <h5>Available Dates</h5>
                <span class="tennis-badge tennis-badge-light">{{ available_dates|length }} options</span>
            </div>
            <div class="tennis-card-body">
                <div class="row">
                    {% for date_option in available_dates %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="tennis-card card-clickable date-card h-100 position-relative" 
                             data-date="{{ date_option.date }}" 
                             data-times="{{ date_option.available_times|join(',') if date_option.available_times else '' }}"
                             data-facility-options='{{ date_option.facility_options|tojson if date_option.facility_options else "[]" }}'>
                            
                            <!-- Quality Score -->
                            {% if date_option.quality_score %}
                            <div class="optimal-score tennis-badge tennis-badge-success">{{ date_option.quality_score }}</div>
                            {% endif %}
                            
                            <div class="tennis-card-body">
                                <!-- Date Info -->
                                <h6 class="mb-2 fw-bold text-tennis-primary">{{ date_option.day_name }}</h6>
                                <p class="mb-2 text-tennis-muted">{{ date_option.formatted_date }}</p>
                                
                                <!-- Facility Info -->
                                {% if date_option.facility_name %}
                                <div class="mb-3">
                                    <p class="mb-0 small text-tennis-secondary">
                                        <i class="fas fa-building me-1"></i>{{ date_option.facility_name }}
                                    </p>
                                </div>
                                {% endif %}
                                
                                <!-- Match Quality Badge -->
                                {% if date_option.quality_description %}
                                <div class="mb-3">
                                    {% if date_option.match_quality >= 80 %}
                                        <span class="tennis-badge tennis-badge-success" title="{{ date_option.quality_description }}">
                                            <i class="fas fa-star me-1"></i>Optimal
                                        </span>
                                    {% elif date_option.match_quality >= 60 %}
                                        <span class="tennis-badge tennis-badge-primary" title="{{ date_option.quality_description }}">
                                            <i class="fas fa-star me-1"></i>Good
                                        </span>
                                    {% elif date_option.match_quality >= 40 %}
                                        <span class="tennis-badge tennis-badge-warning" title="{{ date_option.quality_description }}">
                                            <i class="fas fa-circle me-1"></i>Fair
                                        </span>
                                    {% else %}
                                        <span class="tennis-badge tennis-badge-light" title="{{ date_option.quality_description }}">
                                            <i class="fas fa-circle me-1"></i>Poor
                                        </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                


                                <!-- Available Times with Facility Information -->
                                {% if date_option.facility_options %}
                                <div class="mb-3">
                                    <h6 class="text-tennis-success fw-bold mb-2">
                                        <i class="fas fa-clock me-1"></i>
                                        Available Time Slots
                                    </h6>
                                    <div class="small">
                                        {% for facility_option in date_option.facility_options[:2] %}
                                        <div class="mb-2">
                                            <div class="text-tennis-secondary fw-bold mb-1">
                                                <i class="fas fa-building me-1"></i>{{ facility_option.facility_name }}
                                            </div>
                                            {% for slot in facility_option.time_slots[:2] %}
                                            <div class="d-flex justify-content-between align-items-center mb-1 ms-2">
                                                <span class="tennis-badge 
                                                    {% if slot.available_courts >= slot.total_courts * 0.7 %}tennis-badge-success
                                                    {% elif slot.available_courts >= slot.total_courts * 0.3 %}tennis-badge-warning  
                                                    {% else %}tennis-badge-danger{% endif %}">
                                                    {{ slot.time }} 
                                                    <small>({{ slot.available_courts }}/{{ slot.total_courts }})</small>
                                                </span>
                                                <div class="capacity-indicator" style="width: 30px; height: 4px; background: #e9ecef; border-radius: 2px; overflow: hidden;">
                                                    <div class="capacity-fill" style="width: {{ (slot.available_courts / slot.total_courts * 100) if slot.total_courts > 0 else 0 }}%; height: 100%; background: 
                                                        {% if slot.available_courts >= slot.total_courts * 0.7 %}#28a745
                                                        {% elif slot.available_courts >= slot.total_courts * 0.3 %}#ffc107
                                                        {% else %}#dc3545{% endif %}; transition: width 0.3s ease;"></div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            {% if facility_option.time_slots|length > 2 %}
                                            <div class="ms-2">
                                                <span class="tennis-badge tennis-badge-light small">+{{ facility_option.time_slots|length - 2 }} more</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                        {% if date_option.facility_options|length > 2 %}
                                        <div class="text-center mt-2">
                                            <span class="tennis-badge tennis-badge-secondary small">+{{ date_option.facility_options|length - 2 }} more facilities</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif date_option.time_slot_details %}
                                <!-- Fallback for old single-facility structure -->
                                <div class="mb-3">
                                    <h6 class="text-tennis-success fw-bold mb-2">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ date_option.time_slot_details|length }} Time Slots
                                    </h6>
                                    <div class="small">
                                        {% for slot in date_option.time_slot_details[:3] %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="tennis-badge 
                                                {% if slot.available_courts >= slot.total_courts * 0.7 %}tennis-badge-success
                                                {% elif slot.available_courts >= slot.total_courts * 0.3 %}tennis-badge-warning  
                                                {% else %}tennis-badge-danger{% endif %}">
                                                {{ slot.time }} 
                                                <small>({{ slot.available_courts }}/{{ slot.total_courts }})</small>
                                            </span>
                                            <div class="capacity-indicator" style="width: 40px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                                                <div class="capacity-fill" style="width: {{ (slot.available_courts / slot.total_courts * 100) if slot.total_courts > 0 else 0 }}%; height: 100%; background: 
                                                    {% if slot.available_courts >= slot.total_courts * 0.7 %}#28a745
                                                    {% elif slot.available_courts >= slot.total_courts * 0.3 %}#ffc107
                                                    {% else %}#dc3545{% endif %}; transition: width 0.3s ease;"></div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% if date_option.time_slot_details|length > 3 %}
                                        <div class="text-center mt-2">
                                            <span class="tennis-badge tennis-badge-secondary small">+{{ date_option.time_slot_details|length - 3 }} more slots</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif date_option.available_times %}
                                <!-- Fallback for existing data structure -->
                                <div class="mb-3">
                                    <h6 class="text-tennis-success fw-bold mb-2">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ date_option.available_times|length }} Time Slots
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for time in date_option.available_times[:3] %}
                                        <span class="tennis-badge tennis-badge-light">{{ time }}</span>
                                        {% endfor %}
                                        {% if date_option.available_times|length > 3 %}
                                        <span class="tennis-badge tennis-badge-secondary">+{{ date_option.available_times|length - 3 }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                
                                
                                <!-- Existing Matches -->
                                {% if date_option.existing_matches and date_option.existing_matches|length > 0 %}
                                <div class="border-top pt-3">
                                    <h6 class="text-tennis-info fw-bold mb-2">
                                        <i class="fas fa-calendar-check me-1"></i>
                                        {{ date_option.existing_matches|length }} Existing Match{{ 'es' if date_option.existing_matches|length > 1 else '' }}
                                    </h6>
                                    <div class="existing-matches">
                                        {% for existing_match in date_option.existing_matches[:2] %}
                                        <div class="tennis-card card-compact existing-match-item mb-2">
                                            <div class="tennis-card-body">
                                                <div class="fw-bold text-tennis-primary small">{{ existing_match.home_team }} vs {{ existing_match.visitor_team }}</div>
                                                <div class="text-tennis-muted small">
                                                    <span class="tennis-badge tennis-badge-light me-1">{{ existing_match.league }}</span>
                                                    <span class="tennis-badge tennis-badge-info me-1">{{ existing_match.num_lines }} lines</span>
                                                    {% if existing_match.earliest_time and existing_match.latest_time %}
                                                        {% if existing_match.earliest_time == existing_match.latest_time %}
                                                            <span class="tennis-badge tennis-badge-secondary">{{ existing_match.earliest_time }}</span>
                                                        {% else %}
                                                            <span class="tennis-badge tennis-badge-secondary">{{ existing_match.earliest_time }} - {{ existing_match.latest_time }}</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% if date_option.existing_matches|length > 2 %}
                                        <div class="text-center">
                                            <span class="tennis-badge tennis-badge-light">+{{ date_option.existing_matches|length - 2 }} more</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Conflicts -->
                                {% if date_option.conflicts %}
                                <div class="border-top pt-3">
                                    <h6 class="text-tennis-danger fw-bold mb-2">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Conflicts
                                    </h6>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for conflict in date_option.conflicts %}
                                        <span class="tennis-badge tennis-badge-danger small">{{ conflict }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduling Controls -->
    <div class="col-lg-4">
        <div class="tennis-card sticky-top">
            <div class="tennis-card-header">
                <h5><i class="fas fa-cog me-2"></i>Scheduling Options</h5>
            </div>
            <div class="tennis-card-body">
            
                <!-- Selected Date Display -->
                <div class="mb-3">
                    <label class="tennis-form-label fw-bold">Selected Date:</label>
                    <div id="selected-date-display" class="tennis-card card-compact">
                        <div class="tennis-card-body">
                            <em class="text-tennis-muted">Select a date from the left</em>
                        </div>
                    </div>
                </div>
                
                <!-- Scheduling Mode -->
                <div class="mb-3" id="mode-section" style="display: none;">
                    <label class="tennis-form-label fw-bold">Scheduling Mode:</label>
                    <select class="tennis-form-control" id="scheduling-mode">
                        <option value="same_time">All Lines Same Time</option>
                        <option value="split_times">Split Times</option>
                        <option value="custom">Custom Times</option>
                    </select>
                    <div class="tennis-form-text">
                        <div id="mode-description" class="mt-1"></div>
                    </div>
                </div>
                
                <!-- Available Times -->
                <div class="mb-3" id="times-section" style="display: none;">
                    <label class="tennis-form-label fw-bold">Available Times:</label>
                    <div id="available-times-container" class="tennis-card card-compact">
                        <div class="tennis-card-body">
                            <!-- Times will be populated dynamically -->
                        </div>
                    </div>
                    <div class="tennis-form-text">Click times to select them for scheduling</div>
                    <div id="split-times-helper" class="tennis-card card-info" style="display: none;">
                        <div class="tennis-card-body">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Split Times:</strong> Select exactly 2 time slots. 
                            Lines will be distributed between the slots with all lines in each slot starting at the same time.
                        </div>
                    </div>
                </div>
                
                <!-- Selected Times Display -->
                <div class="mb-3" id="selected-times-section" style="display: none;">
                    <label class="tennis-form-label fw-bold">Selected Times:</label>
                    <div id="selected-times-display" class="tennis-card card-compact">
                        <div class="tennis-card-body">
                            <em class="text-tennis-muted">No times selected</em>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-3" id="action-buttons" style="display: none;">
                    <button type="button" id="preview-button" class="btn-tennis-primary" disabled>
                        <i class="fas fa-eye me-1"></i>Preview Schedule
                    </button>
                    <div class="tennis-form-text text-center">
                        Preview shows what changes would be made without actually scheduling
                    </div>
                    <a href="{{ url_for('matches') }}" class="btn-tennis-outline">
                        <i class="fas fa-arrow-left me-1"></i>Back to Matches
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- No Dates Available Message -->
{% elif success and not available_dates %}
<div class="tennis-empty-state">
    <i class="fas fa-calendar-times"></i>
    <h5>No Available Dates</h5>
    <p>
        No optimal dates are available for scheduling this match at the selected facility.
        This could be due to facility scheduling conflicts, team conflicts, or other constraints.
    </p>
    <div class="d-flex gap-2 justify-content-center">
        <a href="{{ url_for('matches') }}" class="btn-tennis-primary">
            <i class="fas fa-arrow-left me-1"></i>Back to Matches
        </a>
        <button type="button" class="btn-tennis-secondary" onclick="window.location.reload()">
            <i class="fas fa-refresh me-1"></i>Refresh Options
        </button>
    </div>
</div>

<!-- Error Message -->
{% else %}
<div class="tennis-empty-state">
    <i class="fas fa-exclamation-triangle text-tennis-danger"></i>
    <h5 class="text-tennis-danger">Scheduling Error</h5>
    <p>
        {{ error or 'An error occurred while loading scheduling options.' }}
    </p>
    <div class="d-flex gap-2 justify-content-center">
        <a href="{{ url_for('matches') }}" class="btn-tennis-primary">
            <i class="fas fa-arrow-left me-1"></i>Back to Matches
        </a>
        <button type="button" class="btn-tennis-secondary" onclick="window.location.reload()">
            <i class="fas fa-refresh me-1"></i>Refresh Options
        </button>
    </div>
</div>
{% endif %}
{% endblock %}

{% block modals %}
<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-tennis-primary">
                    <i class="fas fa-eye me-2"></i>Schedule Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <!-- Preview content will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-tennis-outline" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn-tennis-primary" id="confirm-schedule" disabled>
                    <i class="fas fa-check me-1"></i>Confirm Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add CSS for operations preview -->
<style>
.operations-preview {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    background-color: #f8f9fa;
}

.operation-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.875rem;
}

.operation-item:last-child {
    border-bottom: none;
}

.preview-status .alert {
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pages/schedule-match.js') }}"></script>
{% endblock %}