{% extends "base.html" %}

{% block title %}Matches{% endblock %}

{% block content %}
<div class="tennis-page-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="tennis-page-title">
                <i class="fas fa-calendar-alt"></i> Matches
            </h1>
            <p class="tennis-subtitle">View and manage tennis matches</p>
        </div>
        <div class="d-flex gap-2">
            <!-- View Toggle -->
            <div class="btn-group" role="group" aria-label="View Type">
                <input type="radio" class="btn-check" name="view_type" id="tableView" autocomplete="off" 
                       {% if view_type != 'schedule' %}checked{% endif %} onchange="toggleView('table')">
                <label class="btn btn-outline-tennis-primary" for="tableView">
                    <i class="fas fa-table"></i> Table
                </label>
                
                <input type="radio" class="btn-check" name="view_type" id="scheduleView" autocomplete="off" 
                       {% if view_type == 'schedule' %}checked{% endif %} onchange="toggleView('schedule')">
                <label class="btn btn-outline-tennis-primary" for="scheduleView">
                    <i class="fas fa-calendar-week"></i> Schedule
                </label>
            </div>
            
            <div class="dropdown">
                <button class="btn-tennis-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cogs"></i> Bulk Operations
                </button>
                <ul class="dropdown-menu">
                    <li><h6 class="dropdown-header">Scheduling</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkAutoScheduleModal()">
                        <i class="fas fa-magic text-tennis-primary"></i> Auto-Schedule Matches
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkUnscheduleModal()">
                        <i class="fas fa-calendar-times text-tennis-warning"></i> Unschedule Matches
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Management</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkDeleteModal()">
                        <i class="fas fa-trash text-tennis-danger"></i> Delete Matches
                    </a></li>
                </ul>
            </div>
            <a href="#" class="btn-tennis-outline">
                <i class="fas fa-plus"></i> Generate Matches
            </a>
        </div>
    </div>
</div>

<!-- Quality Score Summary -->
{% if quality_stats and quality_stats.count > 0 %}
<div class="tennis-card mb-3">
    <div class="tennis-section-header">
        <h3 class="tennis-section-title">
            <i class="fas fa-chart-line"></i> Schedule Quality Index
        </h3>
        <div class="tennis-badge tennis-badge-primary">{{ quality_stats.count }} scheduled matches</div>
    </div>
    <div class="tennis-card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-success">{{ quality_stats.average }}</div>
                    <div class="small text-tennis-muted">Average Match Quality</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-info">{{ quality_stats.count }}</div>
                    <div class="small text-tennis-muted">Scheduled Matches</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-muted">{{ quality_stats.total_matches }}</div>
                    <div class="small text-tennis-muted">Total Matches</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter Section -->
<div class="tennis-card mb-3">
    <div class="tennis-card-body py-2">
        <form method="GET" id="filterForm">
            <!-- Hidden field to preserve view type -->
            <input type="hidden" name="view_type" value="{{ view_type or 'table' }}">
            <div class="row g-2 align-items-center">
                <!-- Primary Filters Row -->
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <select class="tennis-form-control" name="league_id" onchange="this.form.submit();">
                        <option value="">All Leagues</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}" 
                                {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                            {{ league.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <select class="tennis-form-control" name="facility_id" onchange="this.form.submit();">
                        <option value="">All Facilities</option>
                        {% for facility in facilities %}
                        <option value="{{ facility.id }}" 
                                {% if selected_facility and selected_facility.id == facility.id %}selected{% endif %}>
                            {{ facility.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-2 col-md-2 col-sm-4">
                    <select class="tennis-form-control" name="match_type" onchange="this.form.submit();">
                        <option value="all" {% if match_type == 'all' %}selected{% endif %}>All</option>
                        <option value="scheduled" {% if match_type == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="unscheduled" {% if match_type == 'unscheduled' %}selected{% endif %}>Unscheduled</option>
                    </select>
                </div>
                
                <div class="col-lg-3 col-md-4 col-sm-8">
                    <input type="text" 
                           class="tennis-form-control" 
                           name="search_query" 
                           value="{{ search_query or '' }}"
                           placeholder="Search teams, leagues...">
                </div>
                
                <div class="col-lg-1 col-md-2 col-sm-2">
                    <input type="date" class="tennis-form-control" name="start_date" value="{{ start_date or '' }}" title="Start Date">
                </div>
                
                <div class="col-lg-1 col-md-2 col-sm-2">
                    <input type="date" class="tennis-form-control" name="end_date" value="{{ end_date or '' }}" title="End Date">
                </div>
                
                <div class="col-lg-1 col-md-12 col-sm-12">
                    <div class="d-flex gap-1">
                        <button type="submit" class="btn-tennis-primary btn-sm" title="Apply Filters">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if selected_league or selected_facility or match_type != 'all' or search_query or start_date or end_date %}
                        <a href="{{ url_for('matches') }}" class="btn-tennis-outline btn-sm" title="Clear All Filters">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Active Filters Display -->
{% if selected_league or selected_facility or match_type != 'all' or search_query or start_date or end_date %}
<div class="tennis-status tennis-status-scheduled mb-3">
    <i class="fas fa-filter"></i>
    <strong>Filters:</strong>
    {% if selected_league %}
    <span class="tennis-badge tennis-badge-primary ms-1">{{ selected_league.name }}</span>
    {% endif %}
    {% if selected_facility %}
    <span class="tennis-badge tennis-badge-info ms-1">{{ selected_facility.name }}</span>
    {% endif %}
    {% if match_type != 'all' %}
    <span class="tennis-badge tennis-badge-secondary ms-1">{{ match_type.title() }}</span>
    {% endif %}
    {% if search_query %}
    <span class="tennis-badge tennis-badge-warning ms-1">"{{ search_query }}"</span>
    {% endif %}
    {% if start_date or end_date %}
    <span class="tennis-badge tennis-badge-info ms-1">{{ start_date or 'Start' }} - {{ end_date or 'End' }}</span>
    {% endif %}
</div>
{% endif %}

<!-- Matches Display -->
{% if matches %}
<!-- Schedule View -->
{% if view_type == 'schedule' %}
    {% include 'components/scheduled_matches_table.html' %}
{% else %}
<!-- Table View -->
<div class="tennis-card">
    <div class="tennis-section-header">
        <h3 class="tennis-section-title">
            <i class="fas fa-list"></i> Matches
            {% if search_query %}
            <small class="tennis-form-text">- Results for "{{ search_query }}"</small>
            {% endif %}
        </h3>
        <div class="tennis-badge tennis-badge-primary">{{ matches|length }} match{{ 'es' if matches|length != 1 else '' }}</div>
    </div>
    
    <div class="tennis-card-body p-0">
        <div class="table-responsive">
            <table class="tennis-table mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Home Team</th>
                        <th>Visitor Team</th>
                        <th>League</th>
                        <th>Date & Time</th>
                        <th>Facility</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in matches %}
                    <tr>
                        <td data-label="ID">
                            <span class="tennis-badge tennis-badge-light">{{ match.id }}</span>
                            {% if match.round %}
                            <div class="small text-tennis-muted">R{{ match.round }}</div>
                            {% endif %}
                        </td>
                        <td data-label="Home Team">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-home text-tennis-success me-1"></i>
                                {% if match.home_team %}
                                <a href="{{ url_for('view_team', team_id=match.home_team.id) }}" class="text-decoration-none fw-bold">
                                    {{ match.home_team.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">TBD</span>
                                {% endif %}
                            </div>
                        </td>
                        <td data-label="Visitor Team">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-plane text-tennis-info me-1"></i>
                                {% if match.visitor_team %}
                                <a href="{{ url_for('view_team', team_id=match.visitor_team.id) }}" class="text-decoration-none fw-bold">
                                    {{ match.visitor_team.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">TBD</span>
                                {% endif %}
                            </div>
                        </td>
                        <td data-label="League">
                            {% if match.league %}
                            <a href="{{ url_for('view_league', league_id=match.league.id) }}" class="text-decoration-none">
                                <i class="fas fa-trophy me-1"></i>
                                {{ match.league.name }}
                            </a>
                            {% else %}
                            <span class="text-tennis-muted">No League</span>
                            {% endif %}
                        </td>
                        <td data-label="Date & Time">
                            {% if match.is_scheduled() %}
                                {% if match.date %}
                                <div class="fw-bold">{{ match.date | format_date('%m/%d/%Y') }}</div>
                                {% endif %}
                                {% if match.scheduled_times %}
                                    {% set unique_times = match.scheduled_times | unique | list %}
                                    {% for time in unique_times %}
                                    <span class="tennis-badge tennis-badge-success">{{ time }}</span>
                                    {% endfor %}
                                {% endif %}
                            {% else %}
                            <span class="text-tennis-muted">Not scheduled</span>
                            {% endif %}
                        </td>
                        <td data-label="Facility">
                            {% if match.facility %}
                            <a href="{{ url_for('view_facility', facility_id=match.facility.id) }}" class="text-decoration-none">
                                {{ match.facility.name }}
                            </a>
                            {% else %}
                            <span class="text-tennis-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td data-label="Status">
                            {% if match.is_scheduled() %}
                                {% if match.is_fully_scheduled() %}
                                <span class="tennis-badge tennis-badge-success">
                                    <i class="fas fa-check-circle"></i> Complete
                                </span>
                                {% else %}
                                <span class="tennis-badge tennis-badge-warning">
                                    <i class="fas fa-exclamation-circle"></i> Partial
                                </span>
                                {% endif %}
                                {% if match.get_quality_score() %}
                                <div class="small">
                                    Quality: <strong>{{ match.get_quality_score() }}</strong>
                                </div>
                                {% endif %}
                            {% else %}
                            <span class="tennis-badge tennis-badge-secondary">
                                <i class="fas fa-clock"></i> Unscheduled
                            </span>
                            {% endif %}
                        </td>
                        <td data-label="Actions">
                            <div class="d-flex gap-1">
                                <a href="{{ url_for('view_match', match_id=match.id) }}" 
                                   class="btn-tennis-outline btn-sm" 
                                   title="View match details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if match.is_scheduled() %}
                                <a href="{{ url_for('schedule_match', match_id=match.id) }}" 
                                   class="btn-tennis-secondary btn-sm" 
                                   title="Edit schedule">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('schedule_match', match_id=match.id) }}" 
                                   class="btn-tennis-primary btn-sm" 
                                   title="Schedule match">
                                    <i class="fas fa-calendar-plus"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="tennis-empty-state">
    <i class="fas fa-calendar-alt"></i>
    {% if search_query or selected_league or selected_facility or match_type != 'all' or start_date or end_date %}
    <h5>No Matches Found</h5>
    <p>No matches match your current filter criteria.</p>
    <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="{{ url_for('matches') }}" class="btn-tennis-outline">
            <i class="fas fa-times"></i> Clear Filters
        </a>
    </div>
    {% else %}
    <h5>No Matches Found</h5>
    <p>No matches are currently in the database.</p>
    <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="#" class="btn-tennis-primary">
            <i class="fas fa-plus"></i> Generate Matches
        </a>
    </div>
    {% endif %}
    
    <div class="tennis-status tennis-status-scheduled mt-3">
        <i class="fas fa-info-circle"></i>
        <strong>Note:</strong> Matches are generated from league team assignments. Create leagues and teams first.
    </div>
</div>
{% endif %}

{% endblock %}

{% block modals %}
<!-- Modals will be created dynamically by the MatchesPage JavaScript class -->
{% endblock %}

{% block scripts %}
<!-- Load matches page JavaScript -->
<script src="{{ url_for('static', filename='js/pages/matches.js') }}"></script>
<script>
// Global variables to store current filter state
let currentFilters = {
    league_id: "{% if selected_league %}{{ selected_league.id }}{% else %}{% endif %}",
    facility_id: "{% if selected_facility %}{{ selected_facility.id }}{% else %}{% endif %}",
    match_type: "{{ match_type if match_type else 'all' }}",
    start_date: "{{ start_date if start_date else '' }}",
    end_date: "{{ end_date if end_date else '' }}",
    search_query: "{{ search_query if search_query else '' }}"
};

// Initialize matches page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the matches page with available leagues
    const leagues = [
        {% for league in leagues %}
        { id: {{ league.id }}, name: "{{ league.name|e }}" }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    window.matchesPage = new MatchesPage(leagues);
    console.log('🎾 Matches page initialized with', leagues.length, 'leagues');
});

// View toggle function
function toggleView(viewType) {
    const form = document.getElementById('filterForm');
    const viewInput = form.querySelector('input[name="view_type"]');
    
    if (viewInput) {
        viewInput.value = viewType;
        form.submit();
    } else {
        // Fallback: create the input if it doesn't exist
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'view_type';
        input.value = viewType;
        form.appendChild(input);
        form.submit();
    }
}

// Show modal functions (kept for backward compatibility)
function showBulkAutoScheduleModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkAutoScheduleModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}

function showBulkUnscheduleModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkUnscheduleModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}

function showBulkDeleteModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkDeleteModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}
</script>
{% endblock %}