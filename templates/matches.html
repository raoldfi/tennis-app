{% extends "base.html" %}

{% block title %}Matches - Tennis Database{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-calendar-alt text-tennis-primary"></i> Tennis Matches
                    </h1>
                    <p class="text-muted mb-0">View and manage tennis matches</p>
                </div>
                <div>
                    <!-- Bulk Operations Dropdown -->
                    <div class="dropdown me-2 d-inline-block">
                        <button class="btn btn-tennis-primary dropdown-toggle" type="button" id="bulkOperationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-tasks"></i> Bulk Operations
                        </button>
                        <ul class="dropdown-menu shadow-tennis" aria-labelledby="bulkOperationsDropdown">
                            <li><h6 class="dropdown-header"><i class="fas fa-magic"></i> Scheduling Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="TennisUI.showModal('bulkAutoScheduleModal')">
                                <i class="fas fa-magic text-warning"></i> Auto-Schedule Matches
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="fas fa-calendar-times"></i> Unscheduling Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="TennisUI.showModal('bulkUnscheduleModal')">
                                <i class="fas fa-calendar-times text-danger"></i> Unschedule Matches
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="fas fa-trash"></i> Delete Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="TennisUI.showModal('bulkDeleteModal')">
                                <i class="fas fa-trash text-danger"></i> Delete Matches
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="tennis-card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('matches') }}" class="tennis-form">
                <div class="row g-3">
                    <!-- League Filter -->
                    <div class="col-md-3">
                        <label for="league_id" class="form-label">
                            <i class="fas fa-trophy"></i> League
                        </label>
                        <select class="form-select" id="league_id" name="league_id">
                            <option value="">All Leagues</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}" 
                                    {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                                {{ league.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Match Type Filter -->
                    <div class="col-md-3">
                        <label for="match_type" class="form-label">
                            <i class="fas fa-list"></i> Match Type
                        </label>
                        <select class="form-select" id="match_type" name="match_type">
                            <option value="all" {% if match_type == 'all' %}selected{% endif %}>
                                All Matches
                            </option>
                            <option value="scheduled" {% if match_type == 'scheduled' %}selected{% endif %}>
                                Scheduled Only
                            </option>
                            <option value="unscheduled" {% if match_type == 'unscheduled' %}selected{% endif %}>
                                Unscheduled Only
                            </option>
                        </select>
                    </div>

                    <!-- Date Range Filters -->
                    <div class="col-md-2">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-plus"></i> Start Date
                        </label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date or '' }}">
                    </div>

                    <div class="col-md-2">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-minus"></i> End Date
                        </label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date or '' }}">
                    </div>

                    <!-- Search -->
                    <div class="col-md-2">
                        <label for="search_query" class="form-label">
                            <i class="fas fa-search"></i> Search
                        </label>
                        <input type="text" class="form-control" id="search_query" name="search_query" 
                               value="{{ search_query or '' }}" placeholder="Teams, facilities...">
                    </div>
                </div>

                <!-- Filter Actions -->
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-tennis-primary">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <a href="{{ url_for('matches') }}" class="btn btn-secondary ms-2">
                            <i class="fas fa-times"></i> Clear Filters
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Active Filters Display -->
    {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
    <div class="alert alert-tennis-info mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-info-circle"></i>
                <strong>Active Filters:</strong>
                {% if selected_league %}
                <span class="badge bg-primary ms-1">League: {{ selected_league.name }}</span>
                {% endif %}
                {% if match_type != 'all' %}
                <span class="badge bg-secondary ms-1">Type: {{ match_type.title() }}</span>
                {% endif %}
                {% if start_date %}
                <span class="badge bg-info ms-1">From: {{ start_date }}</span>
                {% endif %}
                {% if end_date %}
                <span class="badge bg-info ms-1">To: {{ end_date }}</span>
                {% endif %}
                {% if search_query %}
                <span class="badge bg-warning ms-1">Search: "{{ search_query }}"</span>
                {% endif %}
            </div>
            <a href="{{ url_for('matches') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Clear All
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Matches Content -->
    {% if matches %}
    <!-- Desktop Table View -->
    <div class="tennis-card d-none d-lg-block">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-0">
                        <i class="fas fa-table"></i> Match Details
                    </h4>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">{{ matches | length }} matches</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table tennis-table mb-0">
                    <thead>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> ID</th>
                            <th><i class="fas fa-users"></i> Teams</th>
                            <th><i class="fas fa-trophy"></i> League</th>
                            <th><i class="fas fa-building"></i> Facility</th>
                            <th><i class="fas fa-calendar"></i> Date</th>
                            <th><i class="fas fa-clock"></i> Times</th>
                            <th><i class="fas fa-info-circle"></i> Status</th>
                            <th class="text-center"><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr class="{% if not match.is_fully_scheduled %}table-warning{% endif %}">
                            <td>
                                <span class="badge bg-secondary">{{ match.id }}</span>
                            </td>
                            <td>
                                <div class="match-teams">
                                    <div class="fw-bold text-tennis-primary">{{ match.home_team.name if match.home_team else 'TBD' }}</div>
                                    <div class="fw-normal text-tennis-primary">vs {{ match.visitor_team.name if match.visitor_team else 'TBD' }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ match.league.name if match.league else 'Unknown' }}</span>
                            </td>
                            <td>
                                {% if match.facility and match.facility.name %}
                                <span class="text-success">
                                    <i class="fas fa-map-marker-alt"></i> {{ match.facility.short_name }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-question-circle"></i> Not assigned
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.date %}
                                <span class="text-success">
                                    <i class="fas fa-calendar-check"></i> {{ match.date }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-calendar-times"></i> Not scheduled
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.get_scheduled_times() %}
                                <div class="small">
                                    {% for time in match.get_scheduled_times() %}
                                    <div class="text-success">
                                        <i class="fas fa-clock"></i> {{ time }}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-clock"></i> Not scheduled
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.is_fully_scheduled() %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Scheduled
                                </span>
                                {% elif match.is_partially_scheduled() %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Partial
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times"></i> Unscheduled
                                </span>
                                {% endif %}
                            </td>




                            
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- View button - always visible -->
                                    
                                    <a href="{{ url_for('view_match', match_id=match.id) }}" 
                                       class="btn btn-tennis-primary btn-sm"
                                       data-bs-toggle="tooltip" 
                                       title="View Match Details">
                                        <i class="fas fa-eye"></i>
                                    </a>                                   
                                    
                                    {% if match.is_fully_scheduled() %}
                                        <!-- Scheduled Match Actions -->
                                        <button type="button" class="btn btn-tennis-warning btn-sm" 
                                                onclick="unscheduleMatch({{ match.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Unschedule Match">
                                            <i class="fas fa-calendar-times"></i>
                                        </button>
                                    {% else %}
                                        <!-- Unscheduled Match Actions -->
                                        <button type="button" class="btn btn-tennis-success btn-sm" 
                                                onclick="scheduleMatch({{ match.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Schedule Match">
                                            <i class="fas fa-calendar-plus"></i>
                                        </button>
                                        <button type="button" class="btn btn-tennis-danger btn-sm" 
                                                onclick="deleteMatch({{ match.id }})"
                                                data-bs-toggle="tooltip" 
                                                title="Delete Unscheduled Match">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>




                            
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mobile Card View -->
    <div class="d-lg-none">
        {% for match in matches %}
        <div class="tennis-card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <!-- Match Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">
                                    <span class="badge bg-secondary me-2">{{ match.id }}</span>
                                    {% if match.is_fully_scheduled() %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check"></i> Scheduled
                                    </span>
                                    {% elif match.is_partially_scheduled() %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Partial
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times"></i> Unscheduled
                                    </span>
                                    {% endif %}
                                </h6>
                                                                    <div class="text-muted small">{{ match.league.name if match.league else 'Unknown' }}</div>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-tennis-primary btn-sm" 
                                        onclick="scheduleMatch({{ match.id }})">
                                    <i class="fas fa-{% if match.is_scheduled() %}edit{% else %}calendar-plus{% endif %}"></i>
                                </button>
                                {% if not match.is_scheduled() %}
                                <button type="button" class="btn btn-tennis-danger btn-sm" 
                                        onclick="deleteMatch({{ match.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Teams -->
                        <div class="mb-3">
                            <div class="fw-bold text-tennis-primary">{{ match.home_team.name if match.home_team else 'TBD' }}</div>
                            <div class="text-muted">vs {{ match.visitor_team.name if match.visitor_team else 'TBD' }}</div>
                        </div>

                        <!-- Schedule Info -->
                        <div class="row text-sm">
                            <div class="col-6">
                                <div class="mb-2">
                                    <i class="fas fa-building text-muted"></i>
                                    {% if match.facility_name %}
                                    <span class="text-success">{{ match.facility_name }}</span>
                                    {% else %}
                                    <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <i class="fas fa-calendar text-muted"></i>
                                    {% if match.date %}
                                    <span class="text-success">{{ match.date }}</span>
                                    {% else %}
                                    <span class="text-muted">Not scheduled</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Times -->
                        {% if match.get_scheduled_times() %}
                        <div class="mt-2">
                            <i class="fas fa-clock text-muted"></i>
                            <span class="small">
                                {% for time in match.get_scheduled_times() %}
                                <span class="badge bg-light text-dark me-1">{{ time }}</span>
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- No Matches Found -->
    <div class="tennis-card">
        <div class="card-body text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Matches Found</h4>
            <p class="text-muted mb-4">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                No matches match your current filters. Try adjusting your search criteria.
                {% else %}
                There are no matches in the database yet.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-2">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                <a href="{{ url_for('matches') }}" class="btn btn-tennis-primary">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bulk Auto-Schedule Modal -->
<div class="modal fade tennis-modal" id="bulkAutoScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic"></i> Bulk Auto-Schedule Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkAutoScheduleForm" class="tennis-form">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-crosshairs"></i> Scope <span class="required">*</span>
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="all" id="scopeAll" checked>
                            <label class="form-check-label" for="scopeAll">
                                All unscheduled matches
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="scopeLeague">
                            <label class="form-check-label" for="scopeLeague">
                                Specific league only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected" id="scopeSelected">
                            <label class="form-check-label" for="scopeSelected">
                                Currently filtered matches only
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="leagueSelection" style="display: none;">
                        <label for="bulkLeagueSelect" class="form-label">
                            <i class="fas fa-trophy"></i> Select League
                        </label>
                        <select class="form-select" id="bulkLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-tennis-info">
                        <i class="fas fa-info-circle"></i>
                        This will attempt to automatically schedule unscheduled matches to available facilities and time slots.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-tennis-warning" onclick="handleBulkAutoSchedule()">
                    <i class="fas fa-magic"></i> Auto-Schedule Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Unschedule Modal -->
<!-- Bulk Unschedule Modal -->
<div class="modal fade tennis-modal" id="bulkUnscheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-times"></i> Bulk Unschedule Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkUnscheduleForm" class="tennis-form">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-crosshairs"></i> Scope <span class="required">*</span>
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="all" id="unscheduleAll" checked>
                            <label class="form-check-label" for="unscheduleAll">
                                All scheduled matches
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="unscheduleLeague">
                            <label class="form-check-label" for="unscheduleLeague">
                                Scheduled matches in specific league
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected" id="unscheduleSelected">
                            <label class="form-check-label" for="unscheduleSelected">
                                Currently filtered scheduled matches only
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="unscheduleLeagueSelection" style="display: none;">
                        <label for="unscheduleBulkLeagueSelect" class="form-label">
                            <i class="fas fa-trophy"></i> Select League
                        </label>
                        <select class="form-select" id="unscheduleBulkLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-tennis-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will remove scheduling information from selected matches. This action cannot be undone.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-tennis-warning" onclick="handleBulkUnschedule()">
                    <i class="fas fa-calendar-times"></i> Unschedule Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade tennis-modal" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash"></i> Bulk Delete Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkDeleteForm" class="tennis-form">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-crosshairs"></i> Scope <span class="required">*</span>
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="unscheduled" id="deleteUnscheduled" checked>
                            <label class="form-check-label" for="deleteUnscheduled">
                                All unscheduled matches only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="deleteLeague">
                            <label class="form-check-label" for="deleteLeague">
                                Unscheduled matches in specific league
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected" id="deleteSelected">
                            <label class="form-check-label" for="deleteSelected">
                                Currently filtered unscheduled matches
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="deleteLeagueSelection" style="display: none;">
                        <label for="deleteBulkLeagueSelect" class="form-label">
                            <i class="fas fa-trophy"></i> Select League
                        </label>
                        <select class="form-select" id="deleteBulkLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-tennis-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Only unscheduled matches can be deleted for safety. This action cannot be undone.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-tennis-danger" onclick="handleBulkDelete()">
                    <i class="fas fa-trash"></i> Delete Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Individual Match Schedule Modal -->
<div class="modal fade tennis-modal" id="scheduleMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Schedule Match
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scheduleMatchContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentMatchId = null;

// Handle scope selection for bulk operations
document.addEventListener('DOMContentLoaded', function() {
    // Bulk Auto-Schedule scope handling
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const leagueSelection = document.getElementById('leagueSelection');
    
    scopeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                leagueSelection.style.display = 'block';
            } else {
                leagueSelection.style.display = 'none';
            }
        });
    });

    // Bulk Unschedule scope handling
    const unscheduleRadios = document.querySelectorAll('#bulkUnscheduleModal input[name="scope"]');
    const unscheduleLeagueSelection = document.getElementById('unscheduleLeagueSelection');
    
    unscheduleRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                unscheduleLeagueSelection.style.display = 'block';
            } else {
                unscheduleLeagueSelection.style.display = 'none';
            }
        });
    });

    // Bulk Delete scope handling
    const deleteRadios = document.querySelectorAll('#bulkDeleteModal input[name="scope"]');
    const deleteLeagueSelection = document.getElementById('deleteLeagueSelection');
    
    deleteRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                deleteLeagueSelection.style.display = 'block';
            } else {
                deleteLeagueSelection.style.display = 'none';
            }
        });
    });
});

// Bulk Operation Handlers
function handleBulkAutoSchedule() {
    const form = document.getElementById('bulkAutoScheduleForm');
    if (!TennisUI.validateForm('bulkAutoScheduleForm')) {
        return;
    }
    
    const formData = new FormData(form);
    const scope = formData.get('scope');
    
    // Add current filter parameters if scope is 'selected'
    if (scope === 'selected') {
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            if (!formData.has(key)) {
                formData.append(key, value);
            }
        }
    }
    
    TennisUI.executeBulkOperation(
        'Bulk Auto-Schedule',
        '/api/bulk-auto-schedule',
        formData,
        'bulkAutoScheduleModal'
    );
}

function handleBulkUnschedule() {
    const form = document.getElementById('bulkUnscheduleForm');
    if (!TennisUI.validateForm('bulkUnscheduleForm')) {
        return;
    }
    
    const formData = new FormData(form);
    const scope = formData.get('scope');
    
    // Add current filter parameters if scope is 'selected'
    if (scope === 'selected') {
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            if (!formData.has(key)) {
                formData.append(key, value);
            }
        }
    }
    
    TennisUI.executeBulkOperation(
        'Bulk Unschedule',
        '/api/bulk-unschedule',
        formData,
        'bulkUnscheduleModal'
    );
}

function handleBulkDelete() {
    const form = document.getElementById('bulkDeleteForm');
    if (!TennisUI.validateForm('bulkDeleteForm')) {
        return;
    }
    
    const formData = new FormData(form);
    const scope = formData.get('scope');
    
    // Add current filter parameters if scope is 'selected'
    if (scope === 'selected') {
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            if (!formData.has(key)) {
                formData.append(key, value);
            }
        }
    }
    
    // Show confirmation dialog
    if (!confirm('Are you sure you want to delete the selected unscheduled matches? This action cannot be undone.')) {
        return;
    }
    
    TennisUI.executeBulkOperation(
        'Bulk Delete',
        '/api/bulk-delete',
        formData,
        'bulkDeleteModal'
    );
}

// Individual Match Operations
function scheduleMatch(matchId) {
    currentMatchId = matchId;
    
    // Show loading in modal content
    TennisUI.setModalContent('scheduleMatchModal', 'scheduleMatchContent', 
        '<div class="text-center py-4"><div class="tennis-spinner"></div><p class="mt-2">Loading match details...</p></div>'
    );
    
    // Show the modal
    TennisUI.showModal('scheduleMatchModal');
    
    // Load match details
    TennisUI.apiCall(`/api/matches/${matchId}/schedule-form`)
        .then(data => {
            TennisUI.setModalContent('scheduleMatchModal', 'scheduleMatchContent', data.html);
        })
        .catch(error => {
            TennisUI.setModalContent('scheduleMatchModal', 'scheduleMatchContent', 
                `<div class="alert alert-tennis-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading match details: ${error.message}
                </div>`
            );
        });
}

function deleteMatch(matchId) {
    if (!confirm('Are you sure you want to delete this unscheduled match? This action cannot be undone.')) {
        return;
    }
    
    TennisUI.apiCall(`/api/matches/${matchId}`, {
        method: 'DELETE'
    })
    .then(result => {
        TennisUI.showNotification(result.message || 'Match deleted successfully', 'success');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        TennisUI.showNotification(`Failed to delete match: ${error.message}`, 'danger');
    });
}

// Schedule form submission (called from dynamically loaded content)
function submitSchedule() {
    const form = document.getElementById('scheduleForm');
    if (!form) {
        TennisUI.showNotification('Schedule form not found', 'danger');
        return;
    }
    
    if (!TennisUI.validateForm('scheduleForm')) {
        return;
    }
    
    const formData = new FormData(form);
    
    TennisUI.setFormLoading('scheduleForm', true);
    
    TennisUI.apiCall(`/api/matches/${currentMatchId}/schedule`, {
        method: 'POST',
        body: formData
    })
    .then(result => {
        TennisUI.hideModal('scheduleMatchModal');
        TennisUI.showNotification(result.message || 'Match scheduled successfully', 'success');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        TennisUI.showNotification(`Failed to schedule match: ${error.message}`, 'danger');
    })
    .finally(() => {
        TennisUI.setFormLoading('scheduleForm', false);
    });
}

// Clear schedule (called from dynamically loaded content)
function clearSchedule() {
    if (!confirm('Are you sure you want to clear the schedule for this match?')) {
        return;
    }
    
    TennisUI.apiCall(`/api/matches/${currentMatchId}/schedule`, {
        method: 'DELETE'
    })
    .then(result => {
        TennisUI.hideModal('scheduleMatchModal');
        TennisUI.showNotification(result.message || 'Match schedule cleared successfully', 'success');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        TennisUI.showNotification(`Failed to clear schedule: ${error.message}`, 'danger');
    });
}

// Filter form enhancements
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.querySelector('.tennis-form');
    if (filterForm) {
        // Auto-submit on select changes for better UX
        const selects = filterForm.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                // Small delay to allow user to see the change
                setTimeout(() => {
                    filterForm.submit();
                }, 100);
            });
        });
        
        // Clear search on Escape key
        const searchInput = document.getElementById('search_query');
        if (searchInput) {
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    filterForm.submit();
                }
            });
        }
    }
    
    // Initialize tooltips for action buttons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Enhanced table interactions
    setupTableInteractions();
});

function setupTableInteractions() {
    const table = document.querySelector('.tennis-table');
    if (!table) return;
    
    // Add hover effects for better UX
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Add click-to-select functionality for bulk operations
    let selectedRows = new Set();
    
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't select if clicking on action buttons
            if (e.target.closest('.btn-group')) return;
            
            const matchId = this.querySelector('.badge').textContent;
            
            if (this.classList.contains('selected')) {
                this.classList.remove('selected');
                selectedRows.delete(matchId);
            } else {
                this.classList.add('selected');
                selectedRows.add(matchId);
            }
            
            updateBulkOperationButtons(selectedRows.size);
        });
    });
}

function updateBulkOperationButtons(selectedCount) {
    const bulkButton = document.getElementById('bulkOperationsDropdown');
    if (bulkButton) {
        if (selectedCount > 0) {
            bulkButton.innerHTML = `<i class="fas fa-tasks"></i> Bulk Operations (${selectedCount})`;
            bulkButton.classList.remove('btn-tennis-primary');
            bulkButton.classList.add('btn-tennis-warning');
        } else {
            bulkButton.innerHTML = '<i class="fas fa-tasks"></i> Bulk Operations';
            bulkButton.classList.remove('btn-tennis-warning');
            bulkButton.classList.add('btn-tennis-primary');
        }
    }
}

// Performance optimization for large tables
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.tennis-table tbody');
    if (table && table.children.length > 100) {
        // Implement virtual scrolling for very large tables
        console.log('Large table detected, consider implementing virtual scrolling');
    }
});

// Export functions for use in dynamically loaded content
window.MatchesPage = {
    scheduleMatch,
    deleteMatch,
    submitSchedule,
    clearSchedule,
    handleBulkAutoSchedule,
    handleBulkUnschedule,
    handleBulkDelete
};
</script>

<style>
/* Additional page-specific styles */
.match-teams {
    line-height: 1.2;
}

.selected {
    background-color: rgba(45, 90, 135, 0.1) !important;
    border-left: 4px solid var(--tennis-primary) !important;
}

.table tbody tr {
    transition: all 0.2s ease;
}

.enhanced-table tbody tr:hover {
    background-color: rgba(45, 90, 135, 0.05);
    transform: translateX(2px);
}

.btn-group .btn {
    border-radius: 0.25rem !important;
}

.btn-group .btn:not(:last-child) {
    margin-right: 2px;
}

/* Mobile responsive improvements */
@media (max-width: 768px) {
    .tennis-card .card-body {
        padding: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-group .btn {
        width: 100%;
    }
}

/* Loading state for table rows */
.loading-row {
    opacity: 0.6;
    pointer-events: none;
}

/* Enhanced badge styling */
.badge {
    font-size: 0.8em;
    padding: 0.4em 0.6em;
}

/* Status indicators */
.status-scheduled {
    color: var(--tennis-success);
}

.status-partial {
    color: var(--tennis-warning);
}

.status-unscheduled {
    color: var(--tennis-danger);
}

/* Improved filter section */
.tennis-form .row.g-3 > * {
    margin-bottom: 1rem;
}

/* Animation for filter badges */
.badge {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
