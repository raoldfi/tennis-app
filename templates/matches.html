{% extends "base.html" %}

{% block title %}Matches - Tennis Database{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-calendar-alt text-primary"></i> Tennis Matches
                    </h1>
                    <p class="text-muted mb-0">View and manage tennis matches</p>
                </div>
                <div>
                    {% if leagues %}
                    <a href="{{ url_for('generate_matches') }}" class="btn btn-success me-2">
                        <i class="fas fa-plus"></i> Generate Matches
                    </a>
                    {% endif %}
                    <button class="btn btn-warning" onclick="toggleAutoScheduleModal()">
                        <i class="fas fa-magic"></i> Auto-Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('matches') }}" class="row g-3">
                <!-- League Filter -->
                <div class="col-md-3">
                    <label for="league_id" class="form-label">League</label>
                    <select class="form-select" id="league_id" name="league_id">
                        <option value="">All Leagues</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}" 
                                {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                            {{ league.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Match Type Filter (NEW - Using MatchType enum) -->
                <div class="col-md-3">
                    <label for="match_type" class="form-label">Match Type</label>
                    <select class="form-select" id="match_type" name="match_type">
                        <option value="all" {% if match_type == 'all' %}selected{% endif %}>
                            All Matches
                        </option>
                        <option value="scheduled" {% if match_type == 'scheduled' %}selected{% endif %}>
                            Scheduled Only
                        </option>
                        <option value="unscheduled" {% if match_type == 'unscheduled' %}selected{% endif %}>
                            Unscheduled Only
                        </option>
                    </select>
                </div>

                <!-- Date Range Filters -->
                <div class="col-md-2">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date or '' }}">
                </div>

                <div class="col-md-2">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" 
                           value="{{ end_date or '' }}">
                </div>

                <!-- Search -->
                <div class="col-md-2">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Team, facility..." value="{{ search_query or '' }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="col-12">
                    <div class="d-flex gap-2 align-items-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <a href="{{ url_for('matches') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear All
                        </a>
                        
                        <!-- Quick Match Type Buttons -->
                        <div class="ms-3 btn-group" role="group">
                            <a href="{{ url_for('matches', match_type='all', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-info btn-sm {% if match_type == 'all' %}active{% endif %}">
                                All
                            </a>
                            <a href="{{ url_for('matches', match_type='scheduled', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-success btn-sm {% if match_type == 'scheduled' %}active{% endif %}">
                                Scheduled
                            </a>
                            <a href="{{ url_for('matches', match_type='unscheduled', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-warning btn-sm {% if match_type == 'unscheduled' %}active{% endif %}">
                                Unscheduled
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Match Statistics -->
    {% if matches %}
    {% set scheduled_matches = matches | selectattr('is_fully_scheduled', 'true') | list %}
    {% set unscheduled_matches = matches | rejectattr('is_fully_scheduled', 'true') | list %}
    {% set partially_scheduled = matches | selectattr('is_partially_scheduled', 'true') | list %}
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success mb-1">{{ scheduled_matches | length }}</h3>
                    <p class="card-text small mb-0">Fully Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-1">{{ partially_scheduled | length }}</h3>
                    <p class="card-text small mb-0">Partially Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h3 class="text-danger mb-1">{{ unscheduled_matches | length }}</h3>
                    <p class="card-text small mb-0">Unscheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info mb-1">{{ matches | length }}</h3>
                    <p class="card-text small mb-0">Total Matches</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Active Filters Display -->
    {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <strong>Active Filters:</strong>
                {% if selected_league %}
                <span class="badge bg-primary ms-1">League: {{ selected_league.name }}</span>
                {% endif %}
                {% if match_type != 'all' %}
                <span class="badge bg-secondary ms-1">Type: {{ match_type.title() }}</span>
                {% endif %}
                {% if start_date %}
                <span class="badge bg-info ms-1">From: {{ start_date }}</span>
                {% endif %}
                {% if end_date %}
                <span class="badge bg-info ms-1">To: {{ end_date }}</span>
                {% endif %}
                {% if search_query %}
                <span class="badge bg-warning ms-1">Search: "{{ search_query }}"</span>
                {% endif %}
            </div>
            <a href="{{ url_for('matches') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Clear All
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Matches Content -->
    {% if matches %}
    <!-- Desktop Table View -->
    <div class="card d-none d-lg-block">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-0">
                        <i class="fas fa-table"></i> Match Details
                    </h4>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">{{ matches | length }} matches</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Teams</th>
                            <th>League</th>
                            <th>Facility</th>
                            <th>Date</th>
                            <th>Times</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr class="{% if not match.is_fully_scheduled %}table-warning{% endif %}">
                            <td>
                                <span class="badge bg-secondary">{{ match.id }}</span>
                            </td>
                            <td>
                                <div class="match-teams">
                                    <div class="fw-bold text-primary">{{ match.home_team_name }}</div>
                                    <div class="small text-muted">vs</div>
                                    <div class="fw-bold text-info">{{ match.visitor_team_name }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ match.league_name }}</span>
                            </td>
                            <td>
                                {% if match.facility_name != 'No Facility Assigned' %}
                                <span class="text-success">
                                    <i class="fas fa-map-marker-alt"></i> {{ match.facility_name }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-question-circle"></i> Not Assigned
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.date %}
                                <span class="text-success">
                                    <i class="fas fa-calendar"></i> {{ match.date }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-calendar-times"></i> Not Set
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.scheduled_times %}
                                <div class="time-slots">
                                    {% for time in match.scheduled_times %}
                                    <span class="badge bg-success me-1 mb-1">
                                        <i class="fas fa-clock"></i> {{ time }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-clock"></i> Not Scheduled
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="status-column">
                                    {% if match.is_fully_scheduled %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Fully Scheduled
                                    </span>
                                    {% elif match.is_partially_scheduled %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Partial ({{ match.num_scheduled_lines }}/{{ match.expected_lines }})
                                    </span>
                                    {% elif match.has_facility and match.has_date %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-info-circle"></i> Location Set
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times-circle"></i> Unscheduled
                                    </span>
                                    {% endif %}
                                    
                                    {% if match.missing_fields %}
                                    <div class="small text-warning mt-1">
                                        Missing: {{ ', '.join(match.missing_fields) }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    {% if not match.is_fully_scheduled %}
                                    <button class="btn btn-success" 
                                            onclick="scheduleMatch({{ match.id }})"
                                            title="Schedule this match">
                                        <i class="fas fa-calendar-plus"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-warning" 
                                            onclick="rescheduleMatch({{ match.id }})"
                                            title="Reschedule this match">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-info" 
                                            onclick="viewMatch({{ match.id }})"
                                            title="View match details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mobile Card View -->
    <div class="d-block d-lg-none">
        {% for match in matches %}
        <div class="card mb-3 {% if not match.is_fully_scheduled %}border-warning{% endif %}">
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-6">
                        <small class="text-muted">Match ID</small>
                        <div><span class="badge bg-secondary">{{ match.id }}</span></div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">League</small>
                        <div><span class="badge bg-info">{{ match.league_name }}</span></div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="text-center">
                            <div class="fw-bold text-primary fs-5">{{ match.home_team_name }}</div>
                            <div class="small text-muted">vs</div>
                            <div class="fw-bold text-info fs-5">{{ match.visitor_team_name }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-12">
                        <small class="text-muted">Facility</small>
                        <div>
                            {% if match.facility_name != 'No Facility Assigned' %}
                            <i class="fas fa-map-marker-alt text-success"></i> {{ match.facility_name }}
                            {% else %}
                            <i class="fas fa-question-circle text-muted"></i> Not Assigned
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-6">
                        <small class="text-muted">Date</small>
                        <div>
                            {% if match.date %}
                            <i class="fas fa-calendar text-success"></i> {{ match.date }}
                            {% else %}
                            <i class="fas fa-calendar-times text-muted"></i> Not Set
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Times</small>
                        <div>
                            {% if match.scheduled_times %}
                            {% for time in match.scheduled_times %}
                            <span class="badge bg-success me-1">{{ time }}</span>
                            {% endfor %}
                            {% else %}
                            <i class="fas fa-clock text-muted"></i> Not Scheduled
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <small class="text-muted">Status</small>
                        <div>
                            {% if match.is_fully_scheduled %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle"></i> Fully Scheduled
                            </span>
                            {% elif match.is_partially_scheduled %}
                            <span class="badge bg-warning">
                                <i class="fas fa-exclamation-triangle"></i> Partial ({{ match.num_scheduled_lines }}/{{ match.expected_lines }})
                            </span>
                            {% elif match.has_facility and match.has_date %}
                            <span class="badge bg-info">
                                <i class="fas fa-info-circle"></i> Location Set
                            </span>
                            {% else %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle"></i> Unscheduled
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    {% if not match.is_fully_scheduled %}
                    <button class="btn btn-success btn-sm" onclick="scheduleMatch({{ match.id }})">
                        <i class="fas fa-calendar-plus"></i> Schedule
                    </button>
                    {% else %}
                    <button class="btn btn-outline-warning btn-sm" onclick="rescheduleMatch({{ match.id }})">
                        <i class="fas fa-calendar-alt"></i> Reschedule
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-info btn-sm" onclick="viewMatch({{ match.id }})">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- No Matches Found -->
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="fas fa-calendar-times text-muted" style="font-size: 4rem;"></i>
            </div>
            <h4 class="text-muted">No Matches Found</h4>
            <p class="text-muted mb-4">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                No matches match your current filter criteria.
                {% else %}
                There are no matches in the database yet.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-2">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                <a href="{{ url_for('matches') }}" class="btn btn-primary">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
                {% if leagues %}
                <a href="{{ url_for('generate_matches') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Generate Matches
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Auto-Schedule Modal -->
<div class="modal fade" id="autoScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic"></i> Auto-Schedule Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="autoScheduleForm">
                    <div class="mb-3">
                        <label class="form-label">Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="all" id="scopeAll" checked>
                            <label class="form-check-label" for="scopeAll">
                                All unscheduled matches
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="scopeLeague">
                            <label class="form-check-label" for="scopeLeague">
                                Specific league only
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="leagueSelection" style="display: none;">
                        <label for="autoScheduleLeague" class="form-label">Select League</label>
                        <select class="form-select" id="autoScheduleLeague" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                <div id="autoScheduleResults" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Scheduling Complete</h6>
                        <p id="autoScheduleMessage" class="mb-0"></p>
                    </div>
                    <div id="autoScheduleDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalCloseBtn">Close</button>
                <button type="button" class="btn btn-primary" onclick="executeAutoSchedule()" id="scheduleBtn">
                    <i class="fas fa-magic"></i> Schedule Matches
                </button>
                <button type="button" class="btn btn-success" onclick="window.location.reload()" id="refreshBtn" style="display: none;">
                    <i class="fas fa-refresh"></i> Refresh Page
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Match Modal -->
<div class="modal fade" id="scheduleMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Schedule Match
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scheduleMatchContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentMatchId = null;

// Auto-schedule functionality
function toggleAutoScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('autoScheduleModal'));
    modal.show();
}

// Handle scope radio button changes
document.addEventListener('DOMContentLoaded', function() {
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const leagueSelection = document.getElementById('leagueSelection');
    
    scopeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                leagueSelection.style.display = 'block';
            } else {
                leagueSelection.style.display = 'none';
            }
        });
    });
});

function executeAutoSchedule() {
    const form = document.getElementById('autoScheduleForm');
    const formData = new FormData(form);
    const scheduleBtn = document.getElementById('scheduleBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    
    // Disable schedule button
    scheduleBtn.disabled = true;
    scheduleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
    
    fetch('/matches/auto-schedule', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('autoScheduleResults');
        const messageDiv = document.getElementById('autoScheduleMessage');
        const detailsDiv = document.getElementById('autoScheduleDetails');
        
        if (data.success) {
            messageDiv.textContent = data.message;
            
            if (data.scheduled_count > 0) {
                detailsDiv.innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="text-success">
                                <h4>${data.scheduled_count}</h4>
                                <small>Scheduled</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-danger">
                                <h4>${data.failed_count}</h4>
                                <small>Failed</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-info">
                                <h4>${data.total_count}</h4>
                                <small>Total</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show results and refresh button
            resultsDiv.style.display = 'block';
            refreshBtn.style.display = 'inline-block';
            scheduleBtn.style.display = 'none';
            modalCloseBtn.textContent = 'Close';
            
        } else {
            messageDiv.textContent = 'Error: ' + data.error;
            resultsDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const resultsDiv = document.getElementById('autoScheduleResults');
        const messageDiv = document.getElementById('autoScheduleMessage');
        messageDiv.textContent = 'An error occurred while scheduling matches.';
        resultsDiv.style.display = 'block';
    })
    .finally(() => {
        scheduleBtn.disabled = false;
        scheduleBtn.innerHTML = '<i class="fas fa-magic"></i> Schedule Matches';
    });
}

// Individual match scheduling
function scheduleMatch(matchId) {
    currentMatchId = matchId;
    const modal = new bootstrap.Modal(document.getElementById('scheduleMatchModal'));
    
    // Load scheduling interface
    fetch(`/matches/${matchId}/schedule-form`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('scheduleMatchContent').innerHTML = html;
            modal.show();
        })
        .catch(error => {
            console.error('Error loading schedule form:', error);
            alert('Error loading schedule form');
        });
}

function rescheduleMatch(matchId) {
    scheduleMatch(matchId); // Same interface for rescheduling
}

function viewMatch(matchId) {
    // Implement match viewing functionality
    window.location.href = `/matches/${matchId}`;
}

// Filter form enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when match type buttons are clicked
    const matchTypeButtons = document.querySelectorAll('.btn-group a');
    matchTypeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = this.href;
        });
    });
    
    // Clear search when empty
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.closest('form').submit();
            }
        });
    }
});
</script>
{% endblock %}
