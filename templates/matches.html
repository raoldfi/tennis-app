{% extends "base.html" %}

{% block title %}Matches - Tennis Database{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-calendar-alt text-primary"></i> Tennis Matches
                    </h1>
                    <p class="text-muted mb-0">View and manage tennis matches</p>
                </div>
                <div>
                    <!-- Bulk Operations Dropdown -->
                    <div class="dropdown me-2 d-inline-block">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="bulkOperationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-tasks"></i> Bulk Operations
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="bulkOperationsDropdown">
                            <li><h6 class="dropdown-header">Scheduling Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkAutoScheduleModal()">
                                <i class="fas fa-magic text-warning"></i> Auto-Schedule Matches
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Unscheduling Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkUnscheduleModal()">
                                <i class="fas fa-calendar-times text-danger"></i> Unschedule Matches
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Delete Operations</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="showBulkDeleteModal()">
                                <i class="fas fa-trash text-danger"></i> Delete Matches
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('matches') }}" class="row g-3">
                <!-- League Filter -->
                <div class="col-md-3">
                    <label for="league_id" class="form-label">League</label>
                    <select class="form-select" id="league_id" name="league_id">
                        <option value="">All Leagues</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}" 
                                {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                            {{ league.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Match Type Filter -->
                <div class="col-md-3">
                    <label for="match_type" class="form-label">Match Type</label>
                    <select class="form-select" id="match_type" name="match_type">
                        <option value="all" {% if match_type == 'all' %}selected{% endif %}>
                            All Matches
                        </option>
                        <option value="scheduled" {% if match_type == 'scheduled' %}selected{% endif %}>
                            Scheduled Only
                        </option>
                        <option value="unscheduled" {% if match_type == 'unscheduled' %}selected{% endif %}>
                            Unscheduled Only
                        </option>
                    </select>
                </div>

                <!-- Date Range Filters -->
                <div class="col-md-2">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date or '' }}">
                </div>

                <div class="col-md-2">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" 
                           value="{{ end_date or '' }}">
                </div>

                <!-- Search -->
                <div class="col-md-2">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Team, facility..." value="{{ search_query or '' }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="col-12">
                    <div class="d-flex gap-2 align-items-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <a href="{{ url_for('matches') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear All
                        </a>
                        
                        <!-- Quick Match Type Buttons -->
                        <div class="ms-3 btn-group" role="group">
                            <a href="{{ url_for('matches', match_type='all', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-info btn-sm {% if match_type == 'all' %}active{% endif %}">
                                All
                            </a>
                            <a href="{{ url_for('matches', match_type='scheduled', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-success btn-sm {% if match_type == 'scheduled' %}active{% endif %}">
                                Scheduled
                            </a>
                            <a href="{{ url_for('matches', match_type='unscheduled', league_id=selected_league.id if selected_league else '') }}" 
                               class="btn btn-outline-warning btn-sm {% if match_type == 'unscheduled' %}active{% endif %}">
                                Unscheduled
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Match Statistics -->
    {% if matches %}
    {% set scheduled_matches = matches | selectattr('is_fully_scheduled', 'true') | list %}
    {% set unscheduled_matches = matches | rejectattr('is_fully_scheduled', 'true') | list %}
    {% set partially_scheduled = matches | selectattr('is_partially_scheduled', 'true') | list %}
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success mb-1">{{ scheduled_matches | length }}</h3>
                    <p class="card-text small mb-0">Fully Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-1">{{ partially_scheduled | length }}</h3>
                    <p class="card-text small mb-0">Partially Scheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h3 class="text-danger mb-1">{{ unscheduled_matches | length }}</h3>
                    <p class="card-text small mb-0">Unscheduled</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info mb-1">{{ matches | length }}</h3>
                    <p class="card-text small mb-0">Total Matches</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Active Filters Display -->
    {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <strong>Active Filters:</strong>
                {% if selected_league %}
                <span class="badge bg-primary ms-1">League: {{ selected_league.name }}</span>
                {% endif %}
                {% if match_type != 'all' %}
                <span class="badge bg-secondary ms-1">Type: {{ match_type.title() }}</span>
                {% endif %}
                {% if start_date %}
                <span class="badge bg-info ms-1">From: {{ start_date }}</span>
                {% endif %}
                {% if end_date %}
                <span class="badge bg-info ms-1">To: {{ end_date }}</span>
                {% endif %}
                {% if search_query %}
                <span class="badge bg-warning ms-1">Search: "{{ search_query }}"</span>
                {% endif %}
            </div>
            <a href="{{ url_for('matches') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Clear All
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Matches Content -->
    {% if matches %}
    <!-- Desktop Table View -->
    <div class="card d-none d-lg-block">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-0">
                        <i class="fas fa-table"></i> Match Details
                    </h4>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">{{ matches | length }} matches</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 enhanced-table">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Teams</th>
                            <th>League</th>
                            <th>Facility</th>
                            <th>Date</th>
                            <th>Times</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr class="{% if not match.is_fully_scheduled %}table-warning{% endif %}">
                            <td>
                                <span class="badge bg-secondary">{{ match.id }}</span>
                            </td>
                            <td>
                                <div class="match-teams">
                                    <div class="fw-bold text-primary">{{ match.home_team_name }}</div>
                                    <div class="small text-muted">vs</div>
                                    <div class="fw-bold text-info">{{ match.visitor_team_name }}</div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ match.league_name }}</span>
                            </td>
                            <td>
                                {% if match.facility_name != 'No Facility Assigned' %}
                                <span class="text-success">
                                    <i class="fas fa-map-marker-alt"></i> {{ match.facility_name }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-question-circle"></i> Not Assigned
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.date %}
                                <span class="text-success">
                                    <i class="fas fa-calendar"></i> {{ match.date }}
                                </span>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-calendar-times"></i> Not Set
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.scheduled_times %}
                                {% for time in match.scheduled_times %}
                                <span class="badge bg-primary me-1">{{ time }}</span>
                                {% endfor %}
                                {% else %}
                                <span class="text-muted small">No times set</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if match.is_fully_scheduled %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle"></i> Scheduled
                                </span>
                                {% elif match.is_partially_scheduled %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Partial
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-times-circle"></i> Unscheduled
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- Actions for Scheduled Matches -->
                                    {% if match.is_scheduled %}
                                    <button class="btn btn-outline-warning btn-sm" 
                                            onclick="rescheduleMatch({{ match.id }})" 
                                            title="Reschedule Match">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="unscheduleMatch({{ match.id }})" 
                                            title="Unschedule Match">
                                        <i class="fas fa-calendar-times"></i>
                                    </button>
                                    {% else %}
                                    <!-- Actions for Unscheduled Matches -->
                                    <button class="btn btn-outline-success btn-sm" 
                                            onclick="scheduleMatch({{ match.id }})" 
                                            title="Schedule Match">
                                        <i class="fas fa-calendar-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteMatch({{ match.id }})" 
                                            title="Delete Match">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="viewMatch({{ match.id }})" 
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mobile Card View -->
    <div class="d-lg-none">
        {% for match in matches %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge bg-secondary">ID: {{ match.id }}</span>
                    {% if match.is_fully_scheduled %}
                    <span class="badge bg-success">Scheduled</span>
                    {% elif match.is_partially_scheduled %}
                    <span class="badge bg-warning">Partial</span>
                    {% else %}
                    <span class="badge bg-danger">Unscheduled</span>
                    {% endif %}
                </div>
                
                <h5 class="card-title">
                    {{ match.home_team_name }} <small class="text-muted">vs</small> {{ match.visitor_team_name }}
                </h5>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <small class="text-muted">League:</small><br>
                        <span class="badge bg-info">{{ match.league_name }}</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Facility:</small><br>
                        {% if match.facility_name != 'No Facility Assigned' %}
                        <span class="text-success small">{{ match.facility_name }}</span>
                        {% else %}
                        <span class="text-muted small">Not Assigned</span>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Date:</small><br>
                        {% if match.date %}
                        <span class="text-success small">{{ match.date }}</span>
                        {% else %}
                        <span class="text-muted small">Not Set</span>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Times:</small><br>
                        {% if match.scheduled_times %}
                        {% for time in match.scheduled_times %}
                        <span class="badge bg-primary me-1 small">{{ time }}</span>
                        {% endfor %}
                        {% else %}
                        <span class="text-muted small">No times set</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="d-flex gap-1">
                    {% if match.is_scheduled %}
                    <button class="btn btn-outline-warning btn-sm" onclick="rescheduleMatch({{ match.id }})">
                        <i class="fas fa-edit"></i> Reschedule
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="unscheduleMatch({{ match.id }})">
                        <i class="fas fa-calendar-times"></i> Unschedule
                    </button>
                    {% else %}
                    <button class="btn btn-outline-success btn-sm" onclick="scheduleMatch({{ match.id }})">
                        <i class="fas fa-calendar-plus"></i> Schedule
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMatch({{ match.id }})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-primary btn-sm" onclick="viewMatch({{ match.id }})">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Matches Message -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h4>No Matches Found</h4>
            <p class="text-muted">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                No matches match your current filters.
                {% else %}
                There are no matches in the database yet.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-2">
                {% if selected_league or match_type != 'all' or start_date or end_date or search_query %}
                <a href="{{ url_for('matches') }}" class="btn btn-primary">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bulk Auto-Schedule Modal -->
<div class="modal fade" id="bulkAutoScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic"></i> Bulk Auto-Schedule Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkAutoScheduleForm">
                    <div class="mb-3">
                        <label class="form-label">Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="all" id="scopeAll" checked>
                            <label class="form-check-label" for="scopeAll">
                                All unscheduled matches
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="scopeLeague">
                            <label class="form-check-label" for="scopeLeague">
                                Specific league only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected" id="scopeSelected">
                            <label class="form-check-label" for="scopeSelected">
                                Currently filtered matches only
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="leagueSelection" style="display: none;">
                        <label for="bulkLeagueSelect" class="form-label">Select League</label>
                        <select class="form-select" id="bulkLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This will attempt to automatically schedule unscheduled matches to available facilities and time slots.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="executeBulkAutoSchedule()">
                    <i class="fas fa-magic"></i> Auto-Schedule Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Unschedule Modal -->
<div class="modal fade" id="bulkUnscheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-times"></i> Bulk Unschedule Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkUnscheduleForm">
                    <div class="mb-3">
                        <label class="form-label">Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="all" id="unscheduleAll" checked>
                            <label class="form-check-label" for="unscheduleAll">
                                All scheduled matches
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league" id="unscheduleLeague">
                            <label class="form-check-label" for="unscheduleLeague">
                                Specific league only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected" id="unscheduleSelected">
                            <label class="form-check-label" for="unscheduleSelected">
                                Currently filtered matches only
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="unscheduleLeagueSelection" style="display: none;">
                        <label for="unscheduleLeagueSelect" class="form-label">Select League</label>
                        <select class="form-select" id="unscheduleLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        This will remove scheduling information (dates, times, facilities) from matches. The match records will remain but will become unscheduled.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="executeBulkUnschedule()">
                    <i class="fas fa-calendar-times"></i> Unschedule Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash"></i> Bulk Delete Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkDeleteForm">
                    <div class="mb-3">
                        <label class="form-label">Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="unscheduled" id="deleteUnscheduled" checked>
                            <label class="form-check-label" for="deleteUnscheduled">
                                All unscheduled matches only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="league_unscheduled" id="deleteLeagueUnscheduled">
                            <label class="form-check-label" for="deleteLeagueUnscheduled">
                                Unscheduled matches in specific league
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="scope" value="selected_unscheduled" id="deleteSelectedUnscheduled">
                            <label class="form-check-label" for="deleteSelectedUnscheduled">
                                Unscheduled matches in current filter
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="deleteLeagueSelection" style="display: none;">
                        <label for="deleteLeagueSelect" class="form-label">Select League</label>
                        <select class="form-select" id="deleteLeagueSelect" name="league_id">
                            <option value="">Choose a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will permanently delete match records from the database. Only unscheduled matches can be deleted for safety. This action cannot be undone.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="executeBulkDelete()">
                    <i class="fas fa-trash"></i> Delete Matches
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Individual Match Schedule Modal -->
<div class="modal fade" id="scheduleMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Schedule Match
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scheduleMatchContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentMatchId = null;

// Bulk Operations Modal Functions
function showBulkAutoScheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkAutoScheduleModal'));
    modal.show();
}

function showBulkUnscheduleModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkUnscheduleModal'));
    modal.show();
}

function showBulkDeleteModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
}

// Bulk Auto-Schedule Execution
function executeBulkAutoSchedule() {
    const form = document.getElementById('bulkAutoScheduleForm');
    const formData = new FormData(form);
    const scope = formData.get('scope');
    const leagueId = formData.get('league_id');
    
    let url = '/api/bulk-auto-schedule';
    let params = new URLSearchParams();
    
    if (scope === 'league' && leagueId) {
        params.append('league_id', leagueId);
    } else if (scope === 'selected') {
        // Add current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            params.append(key, value);
        }
    }
    
    const scheduleBtn = document.querySelector('#bulkAutoScheduleModal .btn-warning');
    scheduleBtn.disabled = true;
    scheduleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';
    
    fetch(url + (params.toString() ? '?' + params.toString() : ''), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully scheduled ${data.scheduled_count} matches`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling matches');
    })
    .finally(() => {
        scheduleBtn.disabled = false;
        scheduleBtn.innerHTML = '<i class="fas fa-magic"></i> Auto-Schedule Matches';
        bootstrap.Modal.getInstance(document.getElementById('bulkAutoScheduleModal')).hide();
    });
}

// Bulk Unschedule Execution
function executeBulkUnschedule() {
    const form = document.getElementById('bulkUnscheduleForm');
    const formData = new FormData(form);
    const scope = formData.get('scope');
    const leagueId = formData.get('league_id');
    
    let url = '/api/bulk-unschedule';
    let params = new URLSearchParams();
    
    if (scope === 'league' && leagueId) {
        params.append('league_id', leagueId);
    } else if (scope === 'selected') {
        // Add current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            params.append(key, value);
        }
    }
    
    const unscheduleBtn = document.querySelector('#bulkUnscheduleModal .btn-danger');
    unscheduleBtn.disabled = true;
    unscheduleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Unscheduling...';
    
    fetch(url + (params.toString() ? '?' + params.toString() : ''), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully unscheduled ${data.unscheduled_count} matches`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error unscheduling matches');
    })
    .finally(() => {
        unscheduleBtn.disabled = false;
        unscheduleBtn.innerHTML = '<i class="fas fa-calendar-times"></i> Unschedule Matches';
        bootstrap.Modal.getInstance(document.getElementById('bulkUnscheduleModal')).hide();
    });
}

// Bulk Delete Execution
function executeBulkDelete() {
    const form = document.getElementById('bulkDeleteForm');
    const formData = new FormData(form);
    const scope = formData.get('scope');
    const leagueId = formData.get('league_id');
    
    if (!confirm('Are you sure you want to delete these matches? This action cannot be undone.')) {
        return;
    }
    
    let url = '/api/bulk-delete';
    let params = new URLSearchParams();
    
    if (scope === 'league_unscheduled' && leagueId) {
        params.append('league_id', leagueId);
    } else if (scope === 'selected_unscheduled') {
        // Add current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams) {
            params.append(key, value);
        }
    }
    
    const deleteBtn = document.querySelector('#bulkDeleteModal .btn-danger');
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    fetch(url + (params.toString() ? '?' + params.toString() : ''), {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted_count} matches`);
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting matches');
    })
    .finally(() => {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete Matches';
        bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal')).hide();
    });
}

// Individual Match Actions
function scheduleMatch(matchId) {
    currentMatchId = matchId;
    const modal = new bootstrap.Modal(document.getElementById('scheduleMatchModal'));
    
    // Load scheduling interface
    fetch(`/matches/${matchId}/schedule-form`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('scheduleMatchContent').innerHTML = html;
            modal.show();
        })
        .catch(error => {
            console.error('Error loading schedule form:', error);
            alert('Error loading schedule form');
        });
}

function rescheduleMatch(matchId) {
    scheduleMatch(matchId); // Same interface for rescheduling
}

function unscheduleMatch(matchId) {
    if (!confirm('Are you sure you want to unschedule this match?')) {
        return;
    }
    
    fetch(`/api/matches/${matchId}/unschedule`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match unscheduled successfully');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error unscheduling match');
    });
}

function deleteMatch(matchId) {
    if (!confirm('Are you sure you want to delete this match? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/matches/${matchId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match deleted successfully');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting match');
    });
}

function viewMatch(matchId) {
    window.location.href = `/matches/${matchId}`;
}

// Modal scope change handlers
document.addEventListener('DOMContentLoaded', function() {
    // Auto-schedule modal scope handler
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const leagueSelection = document.getElementById('leagueSelection');
    
    scopeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                leagueSelection.style.display = 'block';
            } else {
                leagueSelection.style.display = 'none';
            }
        });
    });
    
    // Unschedule modal scope handler
    const unscheduleRadios = document.querySelectorAll('#bulkUnscheduleModal input[name="scope"]');
    const unscheduleLeagueSelection = document.getElementById('unscheduleLeagueSelection');
    
    unscheduleRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league') {
                unscheduleLeagueSelection.style.display = 'block';
            } else {
                unscheduleLeagueSelection.style.display = 'none';
            }
        });
    });
    
    // Delete modal scope handler
    const deleteRadios = document.querySelectorAll('#bulkDeleteModal input[name="scope"]');
    const deleteLeagueSelection = document.getElementById('deleteLeagueSelection');
    
    deleteRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'league_unscheduled') {
                deleteLeagueSelection.style.display = 'block';
            } else {
                deleteLeagueSelection.style.display = 'none';
            }
        });
    });
    
    // Auto-submit form when match type buttons are clicked
    const matchTypeButtons = document.querySelectorAll('.btn-group a');
    matchTypeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = this.href;
        });
    });
    
    // Clear search when empty
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.closest('form').submit();
            }
        });
    }
});
</script>
{% endblock %}
