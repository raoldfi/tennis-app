{% extends "base.html" %}

{% block title %}Matches{% endblock %}

{% block content %}
<div class="tennis-page-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="tennis-page-title">
                <i class="fas fa-calendar-alt"></i> Matches
            </h1>
            <p class="tennis-subtitle">View and manage tennis matches</p>
        </div>
        <div class="d-flex gap-2">
            <!-- View Toggle -->
            <div class="btn-group" role="group" aria-label="View Type">
                <input type="radio" class="btn-check" name="view_type" id="tableView" autocomplete="off" 
                       {% if view_type != 'schedule' and view_type != 'calendar' %}checked{% endif %} onchange="toggleView('table')">
                <label class="btn btn-outline-tennis-primary" for="tableView">
                    <i class="fas fa-table"></i> Table
                </label>
                
                <input type="radio" class="btn-check" name="view_type" id="scheduleView" autocomplete="off" 
                       {% if view_type == 'schedule' %}checked{% endif %} onchange="toggleView('schedule')">
                <label class="btn btn-outline-tennis-primary" for="scheduleView">
                    <i class="fas fa-calendar-week"></i> Schedule
                </label>
                
                <input type="radio" class="btn-check" name="view_type" id="calendarView" autocomplete="off" 
                       {% if view_type == 'calendar' %}checked{% endif %} onchange="toggleView('calendar')">
                <label class="btn btn-outline-tennis-primary" for="calendarView">
                    <i class="fas fa-calendar"></i> Calendar
                </label>
            </div>
            
            <div class="dropdown">
                <button class="btn-tennis-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cogs"></i> Bulk Operations
                </button>
                <ul class="dropdown-menu">
                    <li><h6 class="dropdown-header">Scheduling</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkAutoScheduleModal()">
                        <i class="fas fa-magic text-tennis-primary"></i> Auto-Schedule Matches
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkUnscheduleModal()">
                        <i class="fas fa-calendar-times text-tennis-warning"></i> Unschedule Matches
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Management</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="showBulkDeleteModal()">
                        <i class="fas fa-trash text-tennis-danger"></i> Delete Matches
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Quality Score Summary -->
{% if quality_stats and quality_stats.count > 0 %}
<div class="tennis-card mb-3">
    <div class="tennis-section-header">
        <h3 class="tennis-section-title">
            <i class="fas fa-chart-line"></i> Schedule Quality Index
        </h3>
        <div class="tennis-badge tennis-badge-primary">{{ quality_stats.count }} scheduled matches</div>
    </div>
    <div class="tennis-card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-success">{{ quality_stats.average }}</div>
                    <div class="small text-tennis-muted">Average Match Quality</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-info">{{ quality_stats.count }}</div>
                    <div class="small text-tennis-muted">Scheduled Matches</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="display-6 fw-bold text-tennis-muted">{{ quality_stats.total_matches }}</div>
                    <div class="small text-tennis-muted">Total Matches</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter Section -->
<div class="tennis-card mb-3">
    <div class="tennis-card-body py-2">
        <form method="GET" id="filterForm">
            <!-- Hidden field to preserve view type -->
            <input type="hidden" name="view_type" value="{{ view_type or 'table' }}">
            <div class="row g-2 align-items-center">
                <!-- Primary Filters Row - League, Facility, Team -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <select class="tennis-form-control" name="league_id" onchange="this.form.submit();">
                        <option value="">All Leagues</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}" 
                                {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                            {{ league.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <select class="tennis-form-control" name="facility_id" onchange="this.form.submit();">
                        <option value="">All Facilities</option>
                        {% for facility in facilities %}
                        <option value="{{ facility.id }}" 
                                {% if selected_facility and selected_facility.id == facility.id %}selected{% endif %}>
                            {{ facility.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <select class="tennis-form-control" name="team_id" onchange="this.form.submit();">
                        <option value="">All Teams</option>
                        {% for team in teams %}
                        <option value="{{ team.id }}" 
                                {% if selected_team and selected_team.id == team.id %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-lg-2 col-md-3 col-sm-4">
                    <select class="tennis-form-control" name="match_type" onchange="this.form.submit();">
                        <option value="all" {% if match_type == 'all' %}selected{% endif %}>All Matches</option>
                        <option value="scheduled" {% if match_type == 'scheduled' %}selected{% endif %}>Scheduled Matches</option>
                        <option value="unscheduled" {% if match_type == 'unscheduled' %}selected{% endif %}>Unscheduled Matches</option>
                    </select>
                </div>
                
                <div class="col-lg-1 col-md-1 col-sm-2 text-end">
                    <div class="d-flex gap-1">
                        <button type="submit" class="btn-tennis-primary btn-sm" title="Apply Filters">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if selected_league or selected_facility or selected_team or match_type != 'all' or search_query or start_date or end_date %}
                        <a href="{{ url_for('matches') }}" class="btn-tennis-outline btn-sm" title="Clear All Filters">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Secondary Filters Row - Date Range, Search -->
            <div class="row g-2 align-items-center mt-2">
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <input type="date" class="tennis-form-control" name="start_date" value="{{ start_date or '' }}" placeholder="Start Date">
                </div>
                
                <div class="col-lg-2 col-md-3 col-sm-6">
                    <input type="date" class="tennis-form-control" name="end_date" value="{{ end_date or '' }}" placeholder="End Date">
                </div>
                
                <div class="col-lg-8 col-md-6 col-sm-12">
                    <input type="text" 
                           class="tennis-form-control" 
                           name="search_query" 
                           value="{{ search_query or '' }}"
                           placeholder="Search teams, leagues, facilities...">
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Active Filters Display -->
{% if selected_league or selected_facility or selected_team or match_type != 'all' or search_query or start_date or end_date %}
<div class="tennis-status tennis-status-scheduled mb-3">
    <i class="fas fa-filter"></i>
    <strong>Filters:</strong>
    {% if selected_league %}
    <span class="tennis-badge tennis-badge-primary ms-1">{{ selected_league.name }}</span>
    {% endif %}
    {% if selected_facility %}
    <span class="tennis-badge tennis-badge-info ms-1">{{ selected_facility.name }}</span>
    {% endif %}
    {% if selected_team %}
    <span class="tennis-badge tennis-badge-success ms-1">{{ selected_team.name }}</span>
    {% endif %}
    {% if match_type != 'all' %}
    <span class="tennis-badge tennis-badge-secondary ms-1">{{ match_type.title() }}</span>
    {% endif %}
    {% if search_query %}
    <span class="tennis-badge tennis-badge-warning ms-1">"{{ search_query }}"</span>
    {% endif %}
    {% if start_date or end_date %}
    <span class="tennis-badge tennis-badge-info ms-1">{{ start_date or 'Start' }} - {{ end_date or 'End' }}</span>
    {% endif %}
</div>
{% endif %}

<!-- Matches Display -->
{% if matches %}
{% if view_type == 'schedule' %}
    <!-- Schedule View - Grouped by Date -->
    {% set grouped_matches = matches | groupby_date %}
    {% for date, day_matches in grouped_matches %}
    <div class="tennis-card mb-4">
        <div class="tennis-section-header">
            <h3 class="tennis-section-title">
                <i class="fas fa-calendar-day"></i> 
                {% if date and date is not none %}
                    {% if date is string %}
                        {% set date_obj = date | parse_date %}
                        {% if date_obj %}
                            {{ date_obj.strftime('%A, %B %d, %Y') }}
                        {% else %}
                            {{ date }}
                        {% endif %}
                    {% else %}
                        {{ date.strftime('%A, %B %d, %Y') }}
                    {% endif %}
                {% else %}
                    Unscheduled Matches
                {% endif %}
            </h3>
            <div class="tennis-badge tennis-badge-primary">{{ day_matches|list|length }} matches</div>
        </div>
        
        <div class="tennis-card-body p-0">
            <div class="table-responsive">
                <table class="tennis-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th style="width: 200px;">Home Team</th>
                            <th style="width: 200px;">Visitor Team</th>
                            <th style="width: 180px;">League</th>
                            <th style="width: 150px;">Time</th>
                            <th style="width: 160px;">Facility</th>
                            <th style="width: 120px;">Status</th>
                            <th style="width: 100px; min-width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in day_matches %}
                        <tr>
                            <td data-label="ID">
                                <span class="tennis-badge tennis-badge-light">{{ match.id }}</span>
                                {% if match.round %}
                                <div class="small text-tennis-muted">R{{ match.round }}</div>
                                {% endif %}
                            </td>
                            <td data-label="Home Team">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-home text-tennis-success me-1"></i>
                                    {% if match.home_team %}
                                    <a href="{{ url_for('view_team', team_id=match.home_team.id) }}" class="text-decoration-none fw-bold">
                                        {{ match.home_team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-tennis-muted">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="Visitor Team">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-plane text-tennis-info me-1"></i>
                                    {% if match.visitor_team %}
                                    <a href="{{ url_for('view_team', team_id=match.visitor_team.id) }}" class="text-decoration-none fw-bold">
                                        {{ match.visitor_team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-tennis-muted">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="League">
                                {% if match.league %}
                                <a href="{{ url_for('view_league', league_id=match.league.id) }}" class="text-tennis-primary text-decoration-none">
                                    <i class="fas fa-trophy me-1"></i>
                                    {{ match.league.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">No League</span>
                                {% endif %}
                            </td>
                            <td data-label="Time">
                                {% if match.is_scheduled() and match.scheduled_times %}
                                    {% set unique_times = match.scheduled_times | unique | list %}
                                    {% for time in unique_times %}
                                    <span class="tennis-badge tennis-badge-success">{{ time }}</span>
                                    {% endfor %}
                                {% else %}
                                <span class="text-tennis-muted">Not scheduled</span>
                                {% endif %}
                            </td>
                            <td data-label="Facility">
                                {% if match.facility %}
                                <a href="{{ url_for('view_facility', facility_id=match.facility.id) }}" class="text-decoration-none">
                                    {{ match.facility.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td data-label="Status">
                                {% if match.is_scheduled() %}
                                    {% if match.is_fully_scheduled() %}
                                    <span class="tennis-badge tennis-badge-success">
                                        <i class="fas fa-check-circle"></i> Complete
                                    </span>
                                    {% else %}
                                    <span class="tennis-badge tennis-badge-warning">
                                        <i class="fas fa-exclamation-circle"></i> Partial
                                    </span>
                                    {% endif %}
                                    {% if match.get_quality_score() %}
                                    <div class="small">
                                        Quality: <strong>{{ match.get_quality_score() }}</strong>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <span class="tennis-badge tennis-badge-secondary">
                                    <i class="fas fa-clock"></i> Unscheduled
                                </span>
                                {% endif %}
                            </td>
                            <td data-label="Actions">
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('view_match', match_id=match.id) }}" 
                                       class="btn-tennis-outline btn-sm" 
                                       title="View match details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if match.is_scheduled() %}
                                    <button class="btn-tennis-danger btn-sm unschedule-btn" 
                                            data-match-id="{{ match.id }}"
                                            data-match-description="Match {{ match.id }}: {{ (match.home_team.name if match.home_team else 'TBD') | e }} vs {{ (match.visitor_team.name if match.visitor_team else 'TBD') | e }}"
                                            title="Unschedule match">
                                        <i class="fas fa-calendar-times"></i>
                                    </button>
                                    {% else %}
                                    <a href="{{ url_for('schedule_match', match_id=match.id) }}" 
                                       class="btn-tennis-primary btn-sm" 
                                       title="Schedule match">
                                        <i class="fas fa-calendar-plus"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
{% elif view_type == 'calendar' %}
    <!-- Calendar View - Monthly Calendar -->
    <div class="tennis-card">
        <div class="tennis-section-header">
            <h3 class="tennis-section-title">
                <i class="fas fa-calendar"></i> Match Calendar
            </h3>
            <div class="tennis-badge tennis-badge-primary">{{ matches|length }} match{{ 'es' if matches|length != 1 else '' }}</div>
        </div>
        
        <div class="tennis-card-body">
            <div class="calendar-container">
                <!-- Calendar Header with Navigation -->
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prev-month">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="calendar-month-year" id="current-month-year">
                            {% if month_name and current_year %}
                                {{ month_name }} {{ current_year }}
                            {% else %}
                                <script>document.write(new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }));</script>
                            {% endif %}
                        </span>
                        <button class="calendar-nav-btn" id="next-month">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="today-btn">
                            <i class="fas fa-calendar-day me-1"></i>
                            Today
                        </button>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <!-- Day Headers -->
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>

                    <!-- Calendar Days -->
                    {% for week in calendar_weeks %}
                        {% for day in week.days %}
                        <div class="calendar-day {% if day.is_other_month %}other-month{% endif %} {% if day.is_today %}today{% endif %}">
                            <div class="calendar-day-number">{{ day.day }}</div>
                            {% if day.is_today %}
                            <div class="calendar-today-indicator"></div>
                            {% endif %}
                            <div class="calendar-events">
                                {% for match in day.matches %}
                                <div class="calendar-event match-event" 
                                     data-league-id="{{ match.league.id if match.league else '' }}"
                                     title="{{ match.home_team.name if match.home_team else 'TBD' }} vs {{ match.visitor_team.name if match.visitor_team else 'TBD' }}{% if match.facility %} at {{ match.facility.name }}{% endif %}{% if match.league %} ({{ match.league.name }}){% endif %}">
                                    {{ (match.home_team.name if match.home_team else 'TBD')[:10] }} vs {{ (match.visitor_team.name if match.visitor_team else 'TBD')[:10] }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>

                <!-- Calendar Legend -->
                <div class="calendar-legend">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background: var(--tennis-success);"></div>
                        <span>Scheduled Matches</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background: var(--tennis-warning);"></div>
                        <span>Facility Events</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background: var(--tennis-danger);"></div>
                        <span>Team Events</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <!-- Table View - Single Table -->
    <div class="tennis-card">
        <div class="tennis-section-header">
            <h3 class="tennis-section-title">
                <i class="fas fa-list"></i> Matches
                {% if search_query %}
                <small class="tennis-form-text">- Results for "{{ search_query }}"</small>
                {% endif %}
            </h3>
            <div class="tennis-badge tennis-badge-primary">{{ matches|length }} match{{ 'es' if matches|length != 1 else '' }}</div>
        </div>
        
        <div class="tennis-card-body p-0">
            <div class="table-responsive">
                <table class="tennis-table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th style="width: 200px;">Home Team</th>
                            <th style="width: 200px;">Visitor Team</th>
                            <th style="width: 180px;">League</th>
                            <th style="width: 150px;">Date & Time</th>
                            <th style="width: 160px;">Facility</th>
                            <th style="width: 120px;">Status</th>
                            <th style="width: 100px; min-width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr>
                            <td data-label="ID">
                                <span class="tennis-badge tennis-badge-light">{{ match.id }}</span>
                                {% if match.round %}
                                <div class="small text-tennis-muted">R{{ match.round }}</div>
                                {% endif %}
                            </td>
                            <td data-label="Home Team">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-home text-tennis-success me-1"></i>
                                    {% if match.home_team %}
                                    <a href="{{ url_for('view_team', team_id=match.home_team.id) }}" class="text-decoration-none fw-bold">
                                        {{ match.home_team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-tennis-muted">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="Visitor Team">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-plane text-tennis-info me-1"></i>
                                    {% if match.visitor_team %}
                                    <a href="{{ url_for('view_team', team_id=match.visitor_team.id) }}" class="text-decoration-none fw-bold">
                                        {{ match.visitor_team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-tennis-muted">TBD</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td data-label="League">
                                {% if match.league %}
                                <a href="{{ url_for('view_league', league_id=match.league.id) }}" class="text-decoration-none">
                                    <i class="fas fa-trophy me-1"></i>
                                    {{ match.league.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">No League</span>
                                {% endif %}
                            </td>
                            <td data-label="Date & Time">
                                {% if match.is_scheduled() %}
                                    {% if match.date %}
                                    <div class="fw-bold">{{ match.date | format_date('%m/%d/%Y') }}</div>
                                    {% endif %}
                                    {% if match.scheduled_times %}
                                        {% set unique_times = match.scheduled_times | unique | list %}
                                        {% for time in unique_times %}
                                        <span class="tennis-badge tennis-badge-success">{{ time }}</span>
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                <span class="text-tennis-muted">Not scheduled</span>
                                {% endif %}
                            </td>
                            <td data-label="Facility">
                                {% if match.facility %}
                                <a href="{{ url_for('view_facility', facility_id=match.facility.id) }}" class="text-decoration-none">
                                    {{ match.facility.name }}
                                </a>
                                {% else %}
                                <span class="text-tennis-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td data-label="Status">
                                {% if match.is_scheduled() %}
                                    {% if match.is_fully_scheduled() %}
                                    <span class="tennis-badge tennis-badge-success">
                                        <i class="fas fa-check-circle"></i> Scheduled
                                    </span>
                                    {% else %}
                                    <span class="tennis-badge tennis-badge-warning">
                                        <i class="fas fa-exclamation-circle"></i> Partial
                                    </span>
                                    {% endif %}
                                    {% if match.get_quality_score() %}
                                    <div class="small">
                                        Quality: <strong>{{ match.get_quality_score() }}</strong>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <span class="tennis-badge tennis-badge-secondary">
                                    <i class="fas fa-clock"></i> Unscheduled
                                </span>
                                {% endif %}
                            </td>
                            <td data-label="Actions">
                                <div class="d-flex gap-1">
                                    <a href="{{ url_for('view_match', match_id=match.id) }}" 
                                       class="btn-tennis-outline btn-sm" 
                                       title="View match details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if match.is_scheduled() %}
                                    <button class="btn-tennis-danger btn-sm unschedule-btn" 
                                            data-match-id="{{ match.id }}"
                                            data-match-description="Match {{ match.id }}: {{ (match.home_team.name if match.home_team else 'TBD') | e }} vs {{ (match.visitor_team.name if match.visitor_team else 'TBD') | e }}"
                                            title="Unschedule match">
                                        <i class="fas fa-calendar-times"></i>
                                    </button>
                                    {% else %}
                                    <a href="{{ url_for('schedule_match', match_id=match.id) }}" 
                                       class="btn-tennis-primary btn-sm" 
                                       title="Schedule match">
                                        <i class="fas fa-calendar-plus"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="tennis-empty-state">
    <i class="fas fa-calendar-alt"></i>
    {% if search_query or selected_league or selected_facility or selected_team or match_type != 'all' or start_date or end_date %}
    <h5>No Matches Found</h5>
    <p>No matches match your current filter criteria.</p>
    <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="{{ url_for('matches') }}" class="btn-tennis-outline">
            <i class="fas fa-times"></i> Clear Filters
        </a>
    </div>
    {% else %}
    <h5>No Matches Found</h5>
    <p>No matches are currently in the database.</p>
    {% endif %}
    
    <div class="tennis-status tennis-status-scheduled mt-3">
        <i class="fas fa-info-circle"></i>
        <strong>Note:</strong> Matches are generated from league team assignments. Create leagues and teams first.
    </div>
</div>
{% endif %}

{% endblock %}

{% block modals %}
<!-- Modals will be created dynamically by the MatchesPage JavaScript class -->
{% endblock %}

{% block scripts %}
<!-- Load matches page JavaScript -->
<script src="{{ url_for('static', filename='js/pages/matches.js') }}"></script>
<script>
// Global variables to store current filter state
let currentFilters = {
    league_id: "{% if selected_league %}{{ selected_league.id }}{% else %}{% endif %}",
    facility_id: "{% if selected_facility %}{{ selected_facility.id }}{% else %}{% endif %}",
    match_type: "{{ match_type if match_type else 'all' }}",
    start_date: "{{ start_date if start_date else '' }}",
    end_date: "{{ end_date if end_date else '' }}",
    search_query: "{{ search_query if search_query else '' }}"
};

// Initialize matches page when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the matches page with available leagues
    const leagues = [
        {% for league in leagues %}
        {
            id: {{ league.id }},
            name: "{{ league.name | e }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Create league color mapping
    const leagueColors = [
        '#28a745', '#007bff', '#dc3545', '#fd7e14', '#6f42c1',
        '#20c997', '#6c757d', '#e83e8c', '#17a2b8', '#ffc107'
    ];
    
    // Add colors to leagues
    leagues.forEach((league, index) => {
        league.color = leagueColors[index % leagueColors.length];
    });
    
    // Create league color lookup
    const leagueColorMap = {};
    leagues.forEach(league => {
        leagueColorMap[league.id] = league.color;
    });
    
    window.matchesPage = new MatchesPage(leagues);
    console.log('🎾 Matches page initialized with', leagues.length, 'leagues');
    
    // Add event listeners to unschedule buttons
    document.querySelectorAll('.unschedule-btn').forEach(button => {
        button.addEventListener('click', function() {
            const matchId = this.dataset.matchId;
            const description = this.dataset.matchDescription;
            unscheduleMatch(matchId, description, this);
        });
    });
    
    // Initialize calendar navigation if in calendar view
    if (document.querySelector('.calendar-container')) {
        initializeCalendarNavigation();
        initializeCalendarClickHandlers();
        applyLeagueColors(); // Apply colors to initial calendar events
    }
});

// Calendar navigation functions
function initializeCalendarNavigation() {
    const prevButton = document.getElementById('prev-month');
    const nextButton = document.getElementById('next-month');
    const todayButton = document.getElementById('today-btn');
    
    if (prevButton) {
        prevButton.addEventListener('click', function() {
            console.log('Previous month clicked');
            // Get fresh current month/year from URL params each time
            const urlParams = new URLSearchParams(window.location.search);
            const currentMonth = parseInt(urlParams.get('month')) || new Date().getMonth() + 1;
            const currentYear = parseInt(urlParams.get('year')) || new Date().getFullYear();
            navigateToMonth(currentMonth - 1, currentYear);
        });
    }
    
    if (nextButton) {
        nextButton.addEventListener('click', function() {
            console.log('Next month clicked');
            // Get fresh current month/year from URL params each time
            const urlParams = new URLSearchParams(window.location.search);
            const currentMonth = parseInt(urlParams.get('month')) || new Date().getMonth() + 1;
            const currentYear = parseInt(urlParams.get('year')) || new Date().getFullYear();
            navigateToMonth(currentMonth + 1, currentYear);
        });
    }
    
    if (todayButton) {
        todayButton.addEventListener('click', function() {
            console.log('Today clicked');
            const today = new Date();
            navigateToMonth(today.getMonth() + 1, today.getFullYear());
        });
    }
}

// Navigate to a specific month/year using AJAX
function navigateToMonth(month, year) {
    // Handle month overflow/underflow
    if (month < 1) {
        month = 12;
        year--;
    } else if (month > 12) {
        month = 1;
        year++;
    }
    
    // Show loading state
    const calendarContainer = document.querySelector('.calendar-container');
    if (calendarContainer) {
        calendarContainer.style.opacity = '0.6';
        calendarContainer.style.pointerEvents = 'none';
    }
    
    // Build URL parameters including current filters
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('month', month);
    urlParams.set('year', year);
    
    // Make AJAX request to get calendar data
    fetch(`/api/calendar-data?${urlParams.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update calendar with new data
            updateCalendarDisplay(data);
            
            // Update URL without page reload
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('month', month);
            newUrl.searchParams.set('year', year);
            window.history.pushState({}, '', newUrl);
            
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
            alert('Failed to load calendar data: ' + error.message);
        })
        .finally(() => {
            // Restore calendar state
            if (calendarContainer) {
                calendarContainer.style.opacity = '1';
                calendarContainer.style.pointerEvents = 'auto';
            }
        });
}

// Update calendar display with new data from AJAX response
function updateCalendarDisplay(calendarData) {
    // Update month/year display
    const monthYearElement = document.getElementById('current-month-year');
    if (monthYearElement) {
        monthYearElement.textContent = `${calendarData.month_name} ${calendarData.current_year}`;
    }
    
    // Clear existing calendar days (keep headers)
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) return;
    
    // Remove all calendar days, keeping only headers
    const dayElements = calendarGrid.querySelectorAll('.calendar-day');
    dayElements.forEach(day => day.remove());
    
    // Add new calendar days
    calendarData.calendar_weeks.forEach(week => {
        week.days.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${day.is_other_month ? 'other-month' : ''} ${day.is_today ? 'today' : ''}`;
            
            let dayHTML = `<div class="calendar-day-number">${day.day}</div>`;
            
            if (day.is_today) {
                dayHTML += '<div class="calendar-today-indicator"></div>';
            }
            
            dayHTML += '<div class="calendar-events">';
            day.matches.forEach(match => {
                const matchTitle = `${match.home_team} vs ${match.visitor_team}${match.facility ? ` at ${match.facility}` : ''}${match.league ? ` (${match.league})` : ''}`;
                const shortTitle = `${match.home_team.substring(0, 10)} vs ${match.visitor_team.substring(0, 10)}`;
                const leagueId = match.league_id || '';
                const backgroundColor = leagueId && leagueColorMap[leagueId] ? leagueColorMap[leagueId] : '#28a745';
                
                dayHTML += `<div class="calendar-event match-event" data-league-id="${leagueId}" style="background-color: ${backgroundColor};" title="${matchTitle}">${shortTitle}</div>`;
            });
            dayHTML += '</div>';
            
            dayElement.innerHTML = dayHTML;
            calendarGrid.appendChild(dayElement);
        });
    });
    
    // Re-initialize click handlers for new elements
    initializeCalendarClickHandlers();
    
    // Apply league colors to new calendar events
    applyLeagueColors();
    
    // Update the current month/year for navigation
    const urlParams = new URLSearchParams(window.location.search);
    const currentMonth = calendarData.current_month;
    const currentYear = calendarData.current_year;
    
    // Update the navigation state
    const prevButton = document.getElementById('prev-month');
    const nextButton = document.getElementById('next-month');
    
    if (prevButton) {
        prevButton.onclick = () => navigateToMonth(currentMonth - 1, currentYear);
    }
    if (nextButton) {
        nextButton.onclick = () => navigateToMonth(currentMonth + 1, currentYear);
    }
}

// Apply league colors to calendar events
function applyLeagueColors() {
    const calendarEvents = document.querySelectorAll('.calendar-event[data-league-id]');
    calendarEvents.forEach(event => {
        const leagueId = event.dataset.leagueId;
        if (leagueId && leagueColorMap[leagueId]) {
            event.style.backgroundColor = leagueColorMap[leagueId];
        }
    });
}

// Calendar day and event click handlers
function initializeCalendarClickHandlers() {
    // Calendar day click handlers
    const calendarDays = document.querySelectorAll('.calendar-day');
    calendarDays.forEach(day => {
        day.addEventListener('click', function() {
            const dayNumber = this.querySelector('.calendar-day-number').textContent;
            console.log('Day clicked:', dayNumber);
            // TODO: Implement day detail view or event creation
        });
    });
    
    // Calendar event click handlers
    const calendarEvents = document.querySelectorAll('.calendar-event');
    calendarEvents.forEach(event => {
        event.addEventListener('click', function(e) {
            e.stopPropagation();
            console.log('Event clicked:', this.textContent);
            // TODO: Implement event detail view or editing
        });
    });
}

// View toggle function
function toggleView(viewType) {
    const form = document.getElementById('filterForm');
    const viewInput = form.querySelector('input[name="view_type"]');
    
    if (viewInput) {
        viewInput.value = viewType;
        form.submit();
    } else {
        // Fallback: create the input if it doesn't exist
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'view_type';
        input.value = viewType;
        form.appendChild(input);
        form.submit();
    }
}

// Show modal functions (kept for backward compatibility)
function showBulkAutoScheduleModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkAutoScheduleModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}

function showBulkUnscheduleModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkUnscheduleModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}

function showBulkDeleteModal() {
    if (window.matchesPage) {
        window.matchesPage.showBulkDeleteModal();
    } else {
        console.error('MatchesPage not initialized');
    }
}

function unscheduleMatch(matchId, description, button) {
    if (!confirm(`Are you sure you want to unschedule this match?\n\n${description}`)) {
        return;
    }
    
    // Show loading state
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    // Call the unschedule route using DELETE method
    fetch(`/matches/${matchId}/schedule`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(data.message || 'Match unscheduled successfully');
            
            // Reload the page to refresh the table
            window.location.reload();
        } else if (data.warning) {
            // Handle warning case (match already unscheduled)
            alert(data.warning);
            
            // Still reload to refresh the view
            window.location.reload();
        } else {
            // Handle error case
            const errorMsg = data.error || 'Failed to unschedule match';
            alert(errorMsg);
        }
    })
    .catch(error => {
        console.error('Error unscheduling match:', error);
        alert('Network error while unscheduling match');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}