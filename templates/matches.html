{% extends "base.html" %}

{% block title %}Matches - Tennis Database{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-calendar-alt"></i> Matches
        {% if selected_league %}
        <small class="text-muted">in {{ selected_league.name }}</small>
        {% endif %}
    </h1>
    <div class="d-flex gap-2">
        <span class="badge badge-match fs-6">{{ matches|length }} matches</span>
        <a href="{{ url_for('calculate_pairings') }}" class="btn btn-primary">
            <i class="fas fa-calculator"></i> Generate Matches
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row align-items-end">
            <div class="col-md-4">
                <label for="league_filter" class="form-label">
                    <i class="fas fa-filter"></i> Filter by League
                </label>
                <select class="form-select" id="league_filter" name="league_id" onchange="this.form.submit()">
                    <option value="">All Leagues</option>
                    {% for league in leagues %}
                    <option value="{{ league.id }}" {% if selected_league and selected_league.id == league.id %}selected{% endif %}>
                        {{ league.name }} ({{ league.year }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="unscheduled_filter" class="form-label">
                    <i class="fas fa-calendar-check"></i> Show Unscheduled
                </label>
                <select class="form-select" id="unscheduled_filter" name="show_unscheduled" onchange="this.form.submit()">
                    <option value="true" {% if show_unscheduled %}selected{% endif %}>Include Unscheduled</option>
                    <option value="false" {% if not show_unscheduled %}selected{% endif %}>Scheduled Only</option>
                </select>
            </div>
            <div class="col-md-4">
                {% if selected_league or not show_unscheduled %}
                <a href="{{ url_for('matches') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
                <button type="button" class="btn btn-outline-info ms-2" onclick="showUnscheduledOnly()">
                    <i class="fas fa-calendar-plus"></i> Unscheduled Only
                </button>
            </div>
        </form>
    </div>
</div>

{% if matches %}
<!-- Match Status Summary -->
<div class="row mb-4">
    {% set scheduled_count = matches|selectattr('is_scheduled')|list|length %}
    {% set unscheduled_count = matches|rejectattr('is_scheduled')|list|length %}
    
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h3 class="text-success">{{ scheduled_count }}</h3>
                <small class="text-muted">Scheduled Matches</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h3 class="text-warning">{{ unscheduled_count }}</h3>
                <small class="text-muted">Unscheduled Matches</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h3 class="text-info">{{ matches|length }}</h3>
                <small class="text-muted">Total Matches</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <button class="btn btn-outline-danger btn-sm" onclick="clearAllMatches()" title="Delete all matches to regenerate from pairings">
                    <i class="fas fa-trash"></i> Clear All
                </button>
                <small class="text-muted d-block mt-1">Reset Matches</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Home Team</th>
                        <th>Visitor Team</th>
                        <th>League</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Facility</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in matches %}
                    <tr class="{% if not match.is_scheduled %}table-warning{% endif %}">
                        <td><span class="badge bg-secondary">{{ match.id }}</span></td>
                        <td>
                            {% if match.status == 'Scheduled' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Scheduled
                            </span>
                            {% elif match.status == 'Partially Scheduled' %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-exclamation-triangle"></i> Partial
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-calendar-plus"></i> Unscheduled
                            </span>
                            {% endif %}
                            
                            {% if match.missing_fields %}
                            <div class="small text-muted mt-1">
                                Missing: {{ match.missing_fields|join(', ') }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold text-success">{{ match.home_team_name }}</div>
                            <small class="text-muted">ID: {{ match.home_team_id }}</small>
                        </td>
                        <td>
                            <div class="fw-bold text-primary">{{ match.visitor_team_name }}</div>
                            <small class="text-muted">ID: {{ match.visitor_team_id }}</small>
                        </td>
                        <td>
                            {% if match.league_id %}
                            <span class="badge bg-info">{{ match.league_name }}</span>
                            <div class="small text-muted">ID: {{ match.league_id }}</div>
                            {% else %}
                            <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if match.date %}
                            <i class="fas fa-calendar text-primary"></i>
                            <strong>{{ match.date }}</strong>
                            {% else %}
                            <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if match.time %}
                            <i class="fas fa-clock text-info"></i>
                            {{ match.time }}
                            {% else %}
                            <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark">{{ match.facility_name }}</span>
                            <div class="small text-muted">ID: {{ match.facility_id }}</div>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                {% if not match.is_scheduled %}
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="showScheduleModal({{ match.id }}, '{{ match.home_team_name }}', '{{ match.visitor_team_name }}')"
                                        title="Schedule this match">
                                    <i class="fas fa-calendar-check"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="unscheduleMatch({{ match.id }})"
                                        title="Unschedule this match">
                                    <i class="fas fa-calendar-minus"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewMatchDetails({{ match.id }})"
                                        title="View details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Match Summary Cards for Mobile -->
<div class="d-block d-md-none mt-4">
    <h5><i class="fas fa-list"></i> Match Cards</h5>
    {% for match in matches %}
    <div class="card mb-3 {% if not match.is_scheduled %}border-warning{% endif %}">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-secondary">Match {{ match.id }}</span>
                {% if match.status == 'Scheduled' %}
                <span class="badge bg-success">Scheduled</span>
                {% elif match.status == 'Partially Scheduled' %}
                <span class="badge bg-warning text-dark">Partial</span>
                {% else %}
                <span class="badge bg-secondary">Unscheduled</span>
                {% endif %}
            </div>
            
            <div class="row">
                <div class="col-6">
                    <h6 class="text-success mb-1">
                        <i class="fas fa-home"></i> Home
                    </h6>
                    <div class="fw-bold">{{ match.home_team_name }}</div>
                </div>
                <div class="col-6">
                    <h6 class="text-primary mb-1">
                        <i class="fas fa-plane"></i> Visitor
                    </h6>
                    <div class="fw-bold">{{ match.visitor_team_name }}</div>
                </div>
            </div>
            
            <hr>
            
            <div class="row">
                <div class="col-4">
                    <small class="text-muted">Date</small>
                    <div>{{ match.date or 'Not set' }}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Time</small>
                    <div>{{ match.time or 'Not set' }}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Facility</small>
                    <div class="small">{{ match.facility_name }}</div>
                </div>
            </div>
            
            <div class="row mt-2">
                <div class="col-6">
                    <small class="text-muted">League</small>
                    <div>{{ match.league_name if match.league_id else 'Not assigned' }}</div>
                </div>
                <div class="col-6">
                    {% if not match.is_scheduled %}
                    <button class="btn btn-sm btn-success" 
                            onclick="showScheduleModal({{ match.id }}, '{{ match.home_team_name }}', '{{ match.visitor_team_name }}')">
                        <i class="fas fa-calendar-check"></i> Schedule
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-warning" 
                            onclick="unscheduleMatch({{ match.id }})">
                        <i class="fas fa-calendar-minus"></i> Unschedule
                    </button>
                    {% endif %}
                </div>
            </div>
            
            {% if match.missing_fields %}
            <div class="mt-2">
                <small class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Missing: {{ match.missing_fields|join(', ') }}
                </small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card">
    <div class="card-body text-center">
        <i class="fas fa-calculator fa-4x text-muted mb-3"></i>
        <h5>No Matches Found</h5>
        {% if selected_league %}
        <p class="text-muted">No matches found in the selected league: <strong>{{ selected_league.name }}</strong></p>
        <p class="text-muted">Generate matches automatically using team pairings.</p>
        <div class="d-flex gap-2 justify-content-center">
            <a href="{{ url_for('calculate_pairings') }}?league_id={{ selected_league.id }}" class="btn btn-primary">
                <i class="fas fa-calculator"></i> Generate Matches for This League
            </a>
        </div>
        {% else %}
        <p class="text-muted">No matches have been generated yet.</p>
        <p class="text-muted">Use the <strong>Calculate Pairings</strong> feature to automatically generate balanced match schedules.</p>
        <div class="d-flex gap-2 justify-content-center">
            <a href="{{ url_for('calculate_pairings') }}" class="btn btn-primary">
                <i class="fas fa-calculator"></i> Generate Your First Matches
            </a>
        </div>
        {% endif %}
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>How it works:</strong> Matches are automatically generated from team pairings to ensure fair and balanced scheduling.
            
            <div class="mt-2">
                <strong>Process:</strong>
                <ol class="text-start small mt-2">
                    <li>Select a league with at least 2 teams</li>
                    <li>Use "Calculate Pairings" to generate balanced match pairings</li>
                    <li>Create unscheduled matches from the pairings</li>
                    <li>Schedule the matches with specific dates and times</li>
                </ol>
            </div>
        </div>
        
        {% if selected_league %}
        <div class="mt-3">
            <a href="{{ url_for('matches') }}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> View All Matches
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="mt-4">
    <div class="d-flex gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{{ url_for('calculate_pairings') }}" class="btn btn-primary">
            <i class="fas fa-calculator"></i> Generate Matches
        </a>
        {% if matches %}
        <a href="{{ url_for('teams') }}" class="btn btn-outline-primary">
            <i class="fas fa-users"></i> View Teams
        </a>
        <a href="{{ url_for('facilities') }}" class="btn btn-outline-info">
            <i class="fas fa-building"></i> View Facilities
        </a>
        {% endif %}
    </div>
</div>

<!-- Match Generation Help -->
{% if not matches %}
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-question-circle"></i> How to Generate Matches
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6><i class="fas fa-users text-primary"></i> 1. Prepare Teams</h6>
                <ul class="small">
                    <li>Ensure you have at least 2 teams in a league</li>
                    <li>Teams need home facilities assigned</li>
                    <li>Set team preferred playing days if desired</li>
                    <li>Verify all teams are properly configured</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6><i class="fas fa-calculator text-success"></i> 2. Calculate Pairings</h6>
                <ul class="small">
                    <li>Go to the "Calculate Pairings" page</li>
                    <li>Select the league you want to generate matches for</li>
                    <li>Review the calculated team pairings</li>
                    <li>Create unscheduled matches from the pairings</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6><i class="fas fa-calendar-check text-warning"></i> 3. Schedule Matches</h6>
                <ul class="small">
                    <li>Generated matches start as "unscheduled"</li>
                    <li>Use the schedule button to set dates and times</li>
                    <li>Assign matches to the appropriate league</li>
                    <li>Coordinate with teams and facilities</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Schedule Match Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Match</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="schedule_match_id">
                    
                    <div class="mb-3">
                        <h6 id="schedule_match_teams" class="text-center"></h6>
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule_league_id" class="form-label">League *</label>
                        <select class="form-select" id="schedule_league_id" required>
                            <option value="">Select a league...</option>
                            {% for league in leagues %}
                            <option value="{{ league.id }}">{{ league.name }} ({{ league.year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule_date" class="form-label">Date *</label>
                                <input type="date" class="form-control" id="schedule_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule_time" class="form-label">Time *</label>
                                <input type="time" class="form-control" id="schedule_time" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSchedule()">
                    <i class="fas fa-calendar-check"></i> Schedule Match
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Make table sortable
document.querySelectorAll('th').forEach(header => {
    if (header.textContent.trim() && !header.textContent.includes('Actions')) {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const index = Array.from(header.parentNode.children).indexOf(header);
            
            rows.sort((a, b) => {
                const aText = a.cells[index].textContent.trim();
                const bText = b.cells[index].textContent.trim();
                
                // Handle date sorting
                if (index === 5) { // Date column
                    const aDate = aText.includes('Not set') ? '0000-00-00' : aText.split('\n')[1] || aText;
                    const bDate = bText.includes('Not set') ? '0000-00-00' : bText.split('\n')[1] || bText;
                    return new Date(aDate) - new Date(bDate);
                }
                
                // Handle time sorting
                if (index === 6) { // Time column
                    const aTime = aText.includes('Not set') ? '00:00' : aText.split('\n')[1] || aText;
                    const bTime = bText.includes('Not set') ? '00:00' : bText.split('\n')[1] || bText;
                    return aTime.localeCompare(bTime);
                }
                
                // Default sorting
                return aText.localeCompare(bText, undefined, {numeric: true});
            });
            
            rows.forEach(row => tbody.appendChild(row));
            
            // Add sort indicator
            document.querySelectorAll('th').forEach(th => th.classList.remove('sorted'));
            header.classList.add('sorted');
        });
    }
});

function showUnscheduledOnly() {
    const url = new URL(window.location);
    url.searchParams.set('show_unscheduled', 'true');
    url.searchParams.delete('league_id');
    window.location.href = url.toString();
}

function showScheduleModal(matchId, homeTeam, visitorTeam) {
    document.getElementById('schedule_match_id').value = matchId;
    document.getElementById('schedule_match_teams').textContent = `${homeTeam} vs ${visitorTeam}`;
    
    // Set default date to today and time to 10:00
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('schedule_date').value = today;
    document.getElementById('schedule_time').value = '10:00';
    
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    modal.show();
}

function submitSchedule() {
    const matchId = document.getElementById('schedule_match_id').value;
    const leagueId = document.getElementById('schedule_league_id').value;
    const date = document.getElementById('schedule_date').value;
    const time = document.getElementById('schedule_time').value;
    
    if (!leagueId || !date || !time) {
        alert('Please fill in all required fields');
        return;
    }
    
    const formData = new FormData();
    formData.append('league_id', leagueId);
    formData.append('date', date);
    formData.append('time', time);
    
    fetch(`/matches/${matchId}/schedule`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error scheduling match: ' + error);
    });
}

function unscheduleMatch(matchId) {
    if (!confirm('Are you sure you want to unschedule this match?')) {
        return;
    }
    
    fetch(`/matches/${matchId}/unschedule`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error unscheduling match: ' + error);
    });
}

function clearAllMatches() {
    if (!confirm('Are you sure you want to delete ALL matches? This action cannot be undone.\n\nThis is useful when you want to regenerate matches from updated team pairings.')) {
        return;
    }
    
    if (!confirm('This will permanently delete all match data. Are you absolutely sure?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('confirm', 'true');
    
    fetch('/matches/delete-all', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message + '\n\nYou can now generate new matches using Calculate Pairings.');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting matches: ' + error);
    });
}

function viewMatchDetails(matchId) {
    // For now, just show an alert. Could be enhanced to show a modal with detailed info
    alert(`Match details for ID ${matchId} would be shown here. This could be enhanced to show a detailed view.`);
}

// Add CSS for sort indicator
const style = document.createElement('style');
style.textContent = `
    th.sorted::after {
        content: ' ↕';
        color: #007bff;
        font-weight: bold;
    }
    th:hover {
        background-color: #e9ecef;
    }
    .table-warning {
        --bs-table-bg: #fff3cd;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
