{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit Team{% else %}Add Team{% endif %} - Tennis Database{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-{% if is_edit %}edit{% else %}users{% endif %}"></i> {% if is_edit %}Edit Team: {{ team.name }}{% else %}Add New Team{% endif %}
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="id" class="form-label">
                                <i class="fas fa-hashtag"></i> Team ID *
                            </label>
                            <input type="number" class="form-control" id="id" name="id" 
                                   {% if is_edit %}value="{{ team.id }}" readonly disabled{% else %}min="1" required placeholder="e.g., 1001"{% endif %}>
                            <div class="form-text">{% if is_edit %}Team ID cannot be changed{% else %}Unique identifier{% endif %}</div>
                        </div>
                        
                        <div class="col-md-9 mb-3">
                            <label for="name" class="form-label">
                                <i class="fas fa-users"></i> Team Name *
                            </label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   {% if is_edit %}value="{{ team.name }}"{% endif %} required maxlength="255"
                                   placeholder="e.g., Smith - Tennis Center North">
                            <div class="form-text">Team name (often includes captain name and facility)</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="league_id" class="form-label">
                                <i class="fas fa-trophy"></i> League *
                            </label>
                            <select class="form-select" id="league_id" name="league_id" required>
                                <option value="">Select a league...</option>
                                {% for league in leagues %}
                                <option value="{{ league.id }}" {% if is_edit and league.id == team.league.id %}selected{% endif %}>
                                    {{ league.name }} ({{ league.year }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">League this team competes in</div>
                        </div>
                        
                        <!-- ENHANCED: Facility management section -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fas fa-building"></i> Preferred Facilities *
                            </label>
                            
                            <!-- Selected Facilities List -->
                            <div class="card">
                                <div class="card-header bg-light py-2">
                                    <h6 class="mb-0">Selected Facilities</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="selectedFacilities" class="facility-list">
                                        {% if is_edit and team.preferred_facilities %}
                                            {% for facility in team.preferred_facilities %}
                                            <div class="facility-item d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded" data-facility-id="{{ facility.id }}">
                                                <div class="facility-info">
                                                    <span class="facility-name fw-bold">{{ facility.name }}</span>
                                                    {% if facility.short_name %}<span class="text-muted"> ({{ facility.short_name }})</span>{% endif %}
                                                    {% if facility.location %}<br><small class="text-muted">{{ facility.location }}</small>{% endif %}
                                                    {% if loop.first %}<span class="badge bg-primary ms-2">Primary</span>{% endif %}
                                                </div>
                                                <div class="facility-actions">
                                                    {% if not loop.first %}
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 move-up-btn" title="Move up">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if not loop.last %}
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 move-down-btn" title="Move down">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger" title="Remove facility">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                        <div id="noFacilitiesMessage" class="text-muted text-center py-3">
                                            <i class="fas fa-building"></i><br>
                                            No facilities selected. Add facilities using the dropdown below.
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add Facility Dropdown -->
                            <div class="mt-3">
                                <div class="input-group">
                                    <select class="form-select" id="facilityToAdd">
                                        <option value="">Select a facility to add...</option>
                                        {% for facility in facilities %}
                                        <option value="{{ facility.id }}" 
                                                data-name="{{ facility.name }}" 
                                                data-short="{{ facility.short_name or '' }}"
                                                data-location="{{ facility.location or '' }}">
                                            {{ facility.name }}
                                            {% if facility.short_name %}({{ facility.short_name }}){% endif %}
                                            {% if facility.location %}- {{ facility.location }}{% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" id="addFacilityBtn">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                                <div class="form-text">
                                    Add facilities where this team can play matches. The first facility will be the primary facility.
                                    {% if facilities|length == 0 %}
                                    <br><span class="text-warning">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        No facilities available. <a href="{{ url_for('add_facility') }}" target="_blank">Add facilities first</a>.
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Hidden input to store selected facility IDs for form submission -->
                            <input type="hidden" id="preferred_facility_ids" name="preferred_facility_ids" value="" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="captain" class="form-label">
                                <i class="fas fa-user"></i> Captain *
                            </label>
                            <input type="text" class="form-control" id="captain" name="captain" 
                                   {% if is_edit %}value="{{ team.captain }}"{% endif %} required maxlength="255"
                                   placeholder="e.g., John Smith">
                            <div class="form-text">Team captain's name</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="preferred_days" class="form-label">
                                <i class="fas fa-calendar-alt"></i> Preferred Playing Days
                            </label>
                            <div class="row">
                                {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               id="day_{{ day }}" name="preferred_days" value="{{ day }}"
                                               {% if is_edit and day in team.preferred_days %}checked{% endif %}>
                                        <label class="form-check-label" for="day_{{ day }}">
                                            {{ day }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">
                                Select the days this team prefers to play. 
                                Leave empty if the team has no preference.
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" 
                                {% if facilities|length == 0 %}disabled title="Add facilities before creating teams"{% endif %}>
                            <i class="fas fa-{% if is_edit %}save{% else %}plus{% endif %}"></i> {% if is_edit %}Save Changes{% else %}Add Team{% endif %}
                        </button>
                        <a href="{{ url_for('teams') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="button" class="btn btn-outline-info" id="generateTeamNameBtn">
                            <i class="fas fa-magic"></i> Auto-Generate Name
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-info-circle"></i> Team Creation Guidelines
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-lightbulb text-warning"></i> Naming Convention</h6>
                        <p class="small">Team names often include:</p>
                        <ul class="small">
                            <li>Captain's last name</li>
                            <li>Home facility name</li>
                            <li>Sometimes team number or nickname</li>
                        </ul>
                        <div class="bg-light p-2 rounded small mt-2">
                            <strong>Examples:</strong><br>
                            • Smith - Tennis Center North<br>
                            • Johnson - Westside Club<br>
                            • Wilson Team #1
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-check-circle text-success"></i> Requirements</h6>
                        <ul class="small">
                            <li>Team must be assigned to an existing league</li>
                            <li>Home facility must be selected from available facilities</li>
                            <li>Team ID must be unique</li>
                            <li>Captain name is required for contact purposes</li>
                        </ul>
                        <div class="alert alert-info mt-2 p-2 small">
                            <i class="fas fa-info-circle"></i> 
                            Teams can only be assigned to facilities that exist in the database.
                            If you need to add a new facility, 
                            <a href="{{ url_for('add_facility') }}" target="_blank">create it here first</a>.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-star text-warning"></i> Preferred Days</h6>
                        <p class="small">
                            Selecting preferred days helps with automatic scheduling.
                            The system will prioritize these days when scheduling matches.
                        </p>
                        <div class="small">
                            <strong>Strategy:</strong>
                            <ul class="mb-0">
                                <li>Choose days that work best for your team</li>
                                <li>Consider facility availability</li>
                                <li>Coordinate with league scheduling preferences</li>
                                <li>Leave blank for maximum flexibility</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Details Modal (for viewing facility info) -->
<div class="modal fade" id="facilityDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building"></i> Facility Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="facilityDetailsContent">
                <!-- Facility details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/facility-management.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pages/team-facility-management.js') }}"></script>
{% endblock %}