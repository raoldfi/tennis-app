{% extends "base.html" %}

{% block title %}Leagues{% endblock %}

{% block extra_css %}
<!-- Page-specific styles that build on shared styles -->
<style>
.league-row {
    transition: all 0.2s ease;
}

.league-row:hover {
    background-color: var(--tennis-hover-bg, rgba(0, 123, 255, 0.05));
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-group .btn {
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.filter-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 0.5rem;
    border: 1px solid rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-trophy"></i> Leagues</h2>
        <p class="text-muted mb-0">Manage tennis leagues and their configurations</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('add_league') }}" class="btn btn-tennis-primary">
            <i class="fas fa-plus"></i> Add League
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="TennisLeagues.importYAML()">
            <i class="fas fa-upload"></i> Import YAML
        </button>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card tennis-card mb-4 filter-section">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="search" 
                           class="form-control" 
                           id="leagueSearch" 
                           placeholder="Search leagues by name, year, or division..."
                           value="">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="yearFilter">
                    <option value="">All Years</option>
                    <!-- Populated by JavaScript -->
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="divisionFilter">
                    <option value="">All Divisions</option>
                    <!-- Populated by JavaScript -->
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-secondary" onclick="TennisLeagues.clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
            <div class="col-md-2 text-end">
                <span class="text-muted" id="resultCount">{{ leagues|length }} leagues</span>
            </div>
        </div>
    </div>
</div>

<!-- Leagues Table -->
<div class="card tennis-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list"></i> All Leagues</span>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-primary" id="tableResultCount">{{ leagues|length }}</span>
        </div>
    </div>
    <div class="card-body p-0">
        {% if leagues %}
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" id="leaguesTable">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center" style="width: 60px;">ID</th>
                        <th style="width: 250px;">League Name</th>
                        <th class="text-center" style="width: 80px;">Year</th>
                        <th class="text-center" style="width: 120px;">Division</th>
                        <th class="text-center" style="width: 100px;">Section</th>
                        <th class="text-center" style="width: 120px;">Age Group</th>
                        <th class="text-center" style="width: 80px;">Teams</th>
                        <th class="text-center" style="width: 80px;">Matches</th>
                        <th class="text-center" style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="leaguesTableBody">
                    {% for league in leagues %}
                    <tr class="league-row" 
                        data-league-name="{{ league.name|lower }}" 
                        data-league-year="{{ league.year }}" 
                        data-league-division="{{ league.division|lower }}"
                        data-league-section="{{ league.section|lower }}"
                        data-league-age-group="{{ league.age_group|lower }}">
                        
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ league.id }}</span>
                        </td>
                        
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-trophy text-tennis-primary me-2"></i>
                                <div>
                                    <strong>{{ league.name }}</strong>
                                    <div class="small text-muted">{{ league.region }}</div>
                                </div>
                            </div>
                        </td>
                        
                        <td class="text-center">
                            <span class="badge bg-info">{{ league.year }}</span>
                        </td>
                        
                        <td class="text-center">
                            <span class="badge bg-success">{{ league.division }}</span>
                        </td>
                        
                        <td class="text-center">
                            <small class="text-muted">{{ league.section }}</small>
                        </td>
                        
                        <td class="text-center">
                            <small class="text-muted">{{ league.age_group }}</small>
                        </td>
                        
                        <td class="text-center">
                            <a href="{{ url_for('teams', league_id=league.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-users"></i> 
                                <span class="badge bg-primary ms-1">{{ league.teams_count or 0 }}</span>
                            </a>
                        </td>
                        
                        <td class="text-center">
                            <a href="{{ url_for('matches', league_id=league.id) }}" 
                               class="btn btn-sm btn-outline-info">
                                <i class="fas fa-calendar-alt"></i>
                                <span class="badge bg-info ms-1">{{ league.matches_count or 0 }}</span>
                            </a>
                        </td>
                        
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <!-- View Action -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary" 
                                        onclick="TennisLeagues.viewLeague({{ league.id }})"
                                        title="View League Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                
                                <!-- Edit Action -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-warning" 
                                        onclick="TennisLeagues.editLeague({{ league.id }})"
                                        title="Edit League">
                                    <i class="fas fa-edit"></i>
                                </button>
                                
                                <!-- Generate Matches Action -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-success" 
                                        onclick="TennisLeagues.generateMatches({{ league.id }}, '{{ league.name|e }}')"
                                        title="Generate Matches">
                                    <i class="fas fa-magic"></i>
                                </button>
                                
                                <!-- Dropdown for additional actions -->
                                <div class="btn-group" role="group">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                            data-bs-toggle="dropdown" 
                                            title="More Actions">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('teams', league_id=league.id) }}">
                                                <i class="fas fa-users"></i> View Teams
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('matches', league_id=league.id) }}">
                                                <i class="fas fa-calendar-alt"></i> View Matches
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="TennisLeagues.deleteLeague({{ league.id }}, '{{ league.name|e }}')">
                                                <i class="fas fa-trash"></i> Delete League
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- No Results Message -->
        <div id="noResults" class="text-center py-4" style="display: none;">
            <i class="fas fa-search fa-2x text-muted mb-3"></i>
            <h6 class="text-muted">No leagues found</h6>
            <p class="text-muted">Try adjusting your search terms or filters</p>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Leagues Yet</h5>
            <p class="text-muted">Create your first league to get started with match generation</p>
            <a href="{{ url_for('add_league') }}" class="btn btn-tennis-primary">
                <i class="fas fa-plus"></i> Create First League
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Statistics Section -->
{% if leagues %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card tennis-card text-center">
            <div class="card-body">
                <i class="fas fa-trophy fa-2x text-tennis-primary mb-2"></i>
                <h4 class="mb-0">{{ leagues|length }}</h4>
                <small class="text-muted">Total Leagues</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card tennis-card text-center">
            <div class="card-body">
                <i class="fas fa-calendar fa-2x text-tennis-success mb-2"></i>
                <h4 class="mb-0">{{ leagues|map(attribute='year')|unique|list|length }}</h4>
                <small class="text-muted">Active Years</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card tennis-card text-center">
            <div class="card-body">
                <i class="fas fa-layer-group fa-2x text-tennis-info mb-2"></i>
                <h4 class="mb-0">{{ leagues|map(attribute='division')|unique|list|length }}</h4>
                <small class="text-muted">Divisions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card tennis-card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-2x text-tennis-warning mb-2"></i>
                <h4 class="mb-0">{{ leagues|sum(attribute='teams_count') or 0 }}</h4>
                <small class="text-muted">Total Teams</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Generate Matches Modal -->
<div class="modal fade" id="generateMatchesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic"></i> Generate Matches
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to generate matches for <strong id="generateLeagueName"></strong>?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    This will create all match pairings automatically using the league's configuration.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('generate_matches') }}" style="display: inline;">
                    <input type="hidden" name="league_id" id="generateLeagueId">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-magic"></i> Generate Matches
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View League Modal -->
<div class="modal fade" id="viewLeagueModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye"></i> League Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewLeagueContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editLeagueFromView()">
                    <i class="fas fa-edit"></i> Edit League
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block init_js %}
// Initialize the leagues page using TennisUI
TennisLeagues.init();
{% endblock %}

{% block scripts %}
<script>
/**
 * Tennis Leagues Management - Uses shared TennisUI components
 */
class TennisLeagues {
    static currentLeagueId = null;
    
    /**
     * Initialize the leagues page functionality
     */
    static init() {
        this.setupSearch();
        this.setupFilters();
        this.populateFilterOptions();
        console.log('Tennis Leagues initialized');
    }

    /**
     * Set up search functionality using TennisUI
     */
    static setupSearch() {
        const searchInput = document.getElementById('leagueSearch');
        if (searchInput) {
            searchInput.addEventListener('input', () => this.filterTable());
        }
    }

    /**
     * Set up filter dropdowns
     */
    static setupFilters() {
        const yearFilter = document.getElementById('yearFilter');
        const divisionFilter = document.getElementById('divisionFilter');
        
        if (yearFilter) {
            yearFilter.addEventListener('change', () => this.filterTable());
        }
        
        if (divisionFilter) {
            divisionFilter.addEventListener('change', () => this.filterTable());
        }
    }

    /**
     * Populate filter dropdown options based on available data
     */
    static populateFilterOptions() {
        const rows = document.querySelectorAll('.league-row');
        const years = new Set();
        const divisions = new Set();
        
        rows.forEach(row => {
            const year = row.dataset.leagueYear;
            const division = row.dataset.leagueDivision;
            
            if (year) years.add(year);
            if (division) divisions.add(division);
        });
        
        // Populate year filter
        const yearFilter = document.getElementById('yearFilter');
        if (yearFilter) {
            Array.from(years).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }
        
        // Populate division filter
        const divisionFilter = document.getElementById('divisionFilter');
        if (divisionFilter) {
            Array.from(divisions).sort().forEach(division => {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division.charAt(0).toUpperCase() + division.slice(1);
                divisionFilter.appendChild(option);
            });
        }
    }

    /**
     * Filter table based on search and filter criteria
     */
    static filterTable() {
        const searchTerm = document.getElementById('leagueSearch').value.toLowerCase();
        const yearFilter = document.getElementById('yearFilter').value;
        const divisionFilter = document.getElementById('divisionFilter').value.toLowerCase();
        
        const rows = document.querySelectorAll('.league-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const name = row.dataset.leagueName;
            const year = row.dataset.leagueYear;
            const division = row.dataset.leagueDivision;
            const section = row.dataset.leagueSection;
            const ageGroup = row.dataset.leagueAgeGroup;
            
            const matchesSearch = !searchTerm || 
                name.includes(searchTerm) || 
                year.includes(searchTerm) ||
                division.includes(searchTerm) ||
                section.includes(searchTerm) ||
                ageGroup.includes(searchTerm);
            
            const matchesYear = !yearFilter || year === yearFilter;
            const matchesDivision = !divisionFilter || division === divisionFilter;
            
            const isVisible = matchesSearch && matchesYear && matchesDivision;
            
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        
        // Update result counts
        document.getElementById('resultCount').textContent = `${visibleCount} leagues`;
        document.getElementById('tableResultCount').textContent = visibleCount;
        
        // Show/hide no results message using TennisUI
        const noResults = document.getElementById('noResults');
        const tableBody = document.getElementById('leaguesTableBody');
        
        if (visibleCount === 0) {
            noResults.style.display = 'block';
            tableBody.style.display = 'none';
        } else {
            noResults.style.display = 'none';
            tableBody.style.display = '';
        }
    }

    /**
     * View league details using TennisUI modal management
     */
    static viewLeague(leagueId) {
        this.currentLeagueId = leagueId;
        
        // Use TennisUI modal utilities
        TennisUI.showModal('viewLeagueModal');
        TennisUI.setModalContent('viewLeagueModal', 'viewLeagueContent', `
            <div class="text-center">
                <div class="tennis-spinner mb-3"></div>
                <p>Loading league details...</p>
            </div>
        `);
        
        // Fetch league details using TennisUI API utilities
        TennisUI.apiCall(`/api/leagues/${leagueId}`)
            .then(data => {
                const content = this.buildLeagueDetailContent(data);
                TennisUI.setModalContent('viewLeagueModal', 'viewLeagueContent', content);
            })
            .catch(error => {
                TennisUI.setModalContent('viewLeagueModal', 'viewLeagueContent', `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading league details: ${error.message}
                    </div>
                `);
            });
    }

    /**
     * Build league detail content for modal
     */
    static buildLeagueDetailContent(league) {
        return `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Name:</strong></td><td>${league.name}</td></tr>
                        <tr><td><strong>Year:</strong></td><td><span class="badge bg-info">${league.year}</span></td></tr>
                        <tr><td><strong>Division:</strong></td><td><span class="badge bg-success">${league.division}</span></td></tr>
                        <tr><td><strong>Section:</strong></td><td>${league.section}</td></tr>
                        <tr><td><strong>Region:</strong></td><td>${league.region}</td></tr>
                        <tr><td><strong>Age Group:</strong></td><td>${league.age_group}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-bar"></i> Statistics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Teams:</strong></td><td><span class="badge bg-primary">${league.teams_count}</span></td></tr>
                        <tr><td><strong>Total Matches:</strong></td><td><span class="badge bg-info">${league.matches_count}</span></td></tr>
                        <tr><td><strong>Scheduled:</strong></td><td><span class="badge bg-success">${league.scheduled_matches}</span></td></tr>
                        <tr><td><strong>Unscheduled:</strong></td><td><span class="badge bg-warning">${league.unscheduled_matches}</span></td></tr>
                        <tr><td><strong>Matches per Team:</strong></td><td>${league.num_matches || 'Not set'}</td></tr>
                        <tr><td><strong>Lines per Match:</strong></td><td>${league.num_lines_per_match || 'Not set'}</td></tr>
                    </table>
                </div>
            </div>
        `;
    }

    /**
     * Edit league
     */
    static editLeague(leagueId) {
        window.location.href = `/leagues/${leagueId}/edit`;
    }

    /**
     * Edit league from view modal
     */
    static editLeagueFromView() {
        if (this.currentLeagueId) {
            this.editLeague(this.currentLeagueId);
        }
    }

    /**
     * Generate matches for a league using TennisUI
     */
    static generateMatches(leagueId, leagueName) {
        document.getElementById('generateLeagueId').value = leagueId;
        document.getElementById('generateLeagueName').textContent = leagueName;
        
        TennisUI.showModal('generateMatchesModal');
    }

    /**
     * Delete league using TennisUI confirmation
     */
    static deleteLeague(leagueId, leagueName) {
        TennisUI.confirmAction(
            `Delete league "${leagueName}"?`,
            `This action cannot be undone and will also delete all associated teams and matches.`,
            'danger',
            () => {
                // Perform deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/leagues/${leagueId}/delete`;
                document.body.appendChild(form);
                form.submit();
            }
        );
    }

    /**
     * Clear all filters using TennisUI utilities
     */
    static clearFilters() {
        document.getElementById('leagueSearch').value = '';
        document.getElementById('yearFilter').value = '';
        document.getElementById('divisionFilter').value = '';
        this.filterTable();
        
        TennisUI.showNotification('Filters cleared', 'info', 2000);
    }

    /**
     * Import YAML functionality using TennisUI
     */
    static importYAML() {
        TennisUI.showNotification('YAML import functionality would be implemented here.', 'info');
    }
}
</script>
{% endblock %}
